<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PyQuest ‚Äì Learn Python</title>

  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --panel2:#020617; --border:#334155;
      --txt:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; --good:#22c55e; --bad:#fb7185;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --gold: rgba(255,215,0,0.65);
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--txt); }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    h1{ margin:0; font-size:26px; }
    .sub{ color:var(--muted); font-size:13px; margin-top:2px; }
    .nav{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{ padding:10px 12px; border-radius:10px; border:0; cursor:pointer; background:#e5e7eb; color:#111; }
    .btn.primary{ background:var(--accent); }
    .btn.ghost{ background:transparent; border:1px solid var(--border); color:var(--txt); }
    .btn.danger{ background: var(--bad); color:#0b1220; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px; margin-top:12px; }
    .story{ color:var(--muted); margin:6px 0 0; line-height:1.35; }
    .prompt{ margin-top:10px; padding:10px; background:var(--panel2); border-radius:10px; border:1px solid var(--border); white-space:pre-line; }
    .row{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap; }
    .right{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    textarea{
      width:100%; margin-top:12px; background:black; color:var(--good);
      border-radius:10px; padding:10px; border:1px solid var(--border);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    textarea[disabled]{ opacity: 0.6; cursor: not-allowed; }
    .split{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px; }
    .label{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    pre{
      background:black; border:1px solid var(--border); border-radius:10px;
      padding:10px; min-height:120px; white-space:pre-wrap; margin:0; color:#e5e7eb;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    ul{ margin:0; padding-left:18px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
      border-radius:999px; border:1px solid var(--border); color:var(--txt);
      background:rgba(255,255,255,0.03);
    }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .badge{
      display:inline-flex; gap:8px; align-items:center; padding:8px 10px;
      border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,0.03);
    }
    .badge small{ color:var(--muted); }
    .toast{
      position: fixed; right: 16px; top: 16px; z-index: 9999;
      min-width: 260px; max-width: 360px;
      background: #0b1220; border:1px solid var(--border); border-radius:14px; padding:12px;
      box-shadow: var(--shadow);
      display:none;
    }
    .toast .tTitle{ font-weight:700; }
    .toast .tMsg{ color:var(--muted); margin-top:6px; white-space:pre-line; }

    .modalBackdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.6);
      display:none; align-items:center; justify-content:center; z-index:9998;
    }
    .modal{
      width:min(680px, 92vw);
      background:#0b1220; border:1px solid var(--border); border-radius:16px; padding:14px;
      box-shadow: var(--shadow);
    }
    input, select{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:#020617; color:var(--txt); outline:none;
    }
    .help{ color:var(--muted); font-size:13px; margin-top:6px; line-height:1.35; }
    @media (max-width: 900px){ .split, .grid{ grid-template-columns: 1fr; } }

    .champBanner{
      margin-top:12px; padding:12px; border-radius:14px;
      border:1px solid rgba(56,189,248,0.45);
      background: radial-gradient(circle at 10% 10%, rgba(56,189,248,0.25), transparent 55%),
                  radial-gradient(circle at 90% 30%, rgba(34,197,94,0.15), transparent 55%),
                  rgba(255,255,255,0.03);
      box-shadow: 0 0 22px rgba(56,189,248,0.15);
    }
    .champPill{
      border-color: var(--gold);
      background: rgba(255, 215, 0, 0.08);
    }

    .profileHeader{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .crownWrap{
      display:none; position:relative; width:46px; height:46px; border-radius:14px;
      border:1px solid rgba(255,215,0,0.55);
      background: radial-gradient(circle at 30% 30%, rgba(255,215,0,0.22), transparent 60%), rgba(255,255,255,0.03);
      box-shadow: 0 0 18px rgba(255,215,0,0.12);
      align-items:center; justify-content:center;
    }
    .crownWrap.show{ display:inline-flex; }
    .crownIcon{ font-size:26px; animation: crownFloat 2.2s ease-in-out infinite; }
    @keyframes crownFloat{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-4px); } }

    .sparkle{
      position:absolute; width:6px; height:6px; border-radius:50%;
      background: rgba(255,255,255,0.95); opacity:0; animation: twinkle 1.6s ease-in-out infinite;
    }
    .sparkle.s1{ top:8px; left:10px; animation-delay:0.1s; }
    .sparkle.s2{ top:10px; right:10px; animation-delay:0.5s; }
    .sparkle.s3{ bottom:10px; left:14px; animation-delay:0.9s; }
    .sparkle.s4{ bottom:12px; right:14px; animation-delay:1.2s; }
    @keyframes twinkle{ 0%{ transform: scale(0.5); opacity:0; } 40%{ transform: scale(1.2); opacity:0.95; } 100%{ transform: scale(0.6); opacity:0; } }

    .confetti {
      position: fixed; top: -10px; width: 10px; height: 14px; border-radius: 2px;
      opacity: 0.95; z-index: 99999;
      animation: fall 2.2s linear forwards, spin 1.1s linear infinite;
    }
    @keyframes fall { to { transform: translateY(110vh) rotate(720deg); opacity: 0; } }
    @keyframes spin { to { transform: rotate(360deg); } }

    .hr{ height:1px; background: rgba(148,163,184,0.25); margin: 10px 0; border:0; }
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px; color:var(--muted); border:1px solid var(--border);
      padding:4px 8px; border-radius:999px;
      background: rgba(255,255,255,0.03);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="font-size:28px;">üêç</div>
        <div>
          <h1>PyQuest ‚Äì Learn Python</h1>
          <div class="sub" id="welcomeLine">Loading‚Ä¶</div>
        </div>
      </div>
      <div class="nav">
        <button class="btn ghost" id="navPlay">Play</button>
        <button class="btn ghost" id="navProfile">Profile</button>
        <button class="btn ghost" id="navLeaderboard">Leaderboard</button>
        <button class="btn ghost" id="navLogout">Logout</button>
        <button class="btn ghost" id="devBtn" style="display:none;">Dev Ctrl</button>
      </div>
    </div>

    <div id="playView" class="card">
      <div class="row">
        <div>
          <div class="pill">üìç <b id="levelTitle">Loading‚Ä¶</b></div>
          <div class="story" id="story"></div>
        </div>
        <div class="right">
          <span class="pill">üéØ Track: <b id="trackPill">-</b></span>
          <span class="pill">‚öôÔ∏è Difficulty: <b id="skillPill">1</b></span>
          <span class="pill">üåç Global visits: <b id="globalVisits">-</b></span>
          <span class="pill">‚≠ê XP: <b id="xp">0</b></span>
          <span class="pill">üèÖ Badges: <b id="badgeCount">0</b></span>
          <span class="pill">‚úÖ Solved: <b id="solvedCount">0</b></span>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="right" style="margin-left:auto;">
          <span class="pill">‚ö° +Hint: <b id="puHint">0</b></span>
          <span class="pill">‚è≠Ô∏è Skip: <b id="puSkip">0</b></span>
          <span class="pill">üëÅÔ∏è Reveal: <b id="puReveal">0</b></span>
        </div>
      </div>

      <div class="prompt" id="prompt"></div>

      <div class="row" style="margin-top:10px;">
        <div class="right" style="margin-left:auto;">
          <button class="btn ghost" id="useHintPU">Use +Hint</button>
          <button class="btn ghost" id="useRevealPU">Use Reveal</button>
          <button class="btn ghost" id="useSkipPU">Use Skip</button>

          <button class="btn primary" id="continueLessonBtn" style="display:none;">Continue</button>
          <button class="btn" id="hintBtn">Hint</button>
          <button class="btn" id="exBtn">EX Code</button>
          <button class="btn" id="runBtn">Run</button>
          <button class="btn primary" id="submitBtn">Submit</button>
        </div>
      </div>

      <textarea id="code" rows="9"></textarea>

      <div class="split">
        <div>
          <div class="label">Output</div>
          <pre id="output"></pre>
        </div>
        <div>
          <div class="label">Hints</div>
          <ul id="hints"></ul>
        </div>
      </div>
    </div>

    <div id="profileView" class="card" style="display:none;">
      <div class="row">
        <div class="profileHeader">
          <div class="crownWrap" id="profileCrown">
            <span class="sparkle s1"></span><span class="sparkle s2"></span>
            <span class="sparkle s3"></span><span class="sparkle s4"></span>
            <div class="crownIcon">üëë</div>
          </div>
          <div>
            <div class="pill">üë§ <b id="profileName">Your Profile</b></div>
            <div class="story">Synced online: Username + PIN (recover on any computer)</div>
          </div>
        </div>

        <div class="right">
          <button class="btn ghost" id="backToPlay">Back to Play</button>
        </div>
      </div>

      <div id="championBanner" class="champBanner" style="display:none;">
        <div class="row">
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <div class="pill champPill">üëë GLOBAL #1</div>
            <div style="font-weight:700;">Champion of the Leaderboard</div>
          </div>
          <div class="right">
            <span class="pill champPill">üèÜ Decoration Active</span>
          </div>
        </div>
        <div class="help">This crown moves automatically to whoever is #1 right now.</div>
      </div>

      <div class="grid" style="margin-top:12px;">
        <div class="card" style="margin:0;">
          <b>Stats</b>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <span class="pill">üéØ Track: <b id="pTrack">-</b></span>
            <span class="pill">‚öôÔ∏è Difficulty: <b id="pSkill">1</b></span>
            <span class="pill">‚úÖ Levels solved: <b id="pSolved">0</b></span>
            <span class="pill">‚≠ê XP: <b id="pXp">0</b></span>
            <span class="pill">üí° Hints used: <b id="pHints">0</b></span>
            <span class="pill">üî• Current stage: <b id="pCurrent">1</b></span>
          </div>

          <hr class="hr">
          <b>Switch Mode</b>
          <div class="help">You can switch anytime. Each mode keeps its own progress.</div>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <select id="switchTrack" style="min-width:260px;">
              <option value="learn">Learn Python (25 guided lessons)</option>
              <option value="beginner">Beginner</option>
              <option value="moderate">Moderate</option>
              <option value="pro">Professional</option>
            </select>
            <button class="btn primary" id="applyTrack">Switch</button>
            <button class="btn ghost" id="resetThisTrack">Reset this mode</button>
          </div>
          <div class="help" id="switchMsg"></div>
          <div class="help">Difficulty auto-adjusts based on speed + hints used (Beginner/Moderate/Pro).</div>
        </div>

        <div class="card" style="margin:0;">
          <b>Power-Up Inventory</b>
          <div class="story">Buy using XP (Shop below). Also you earn some automatically by XP milestones.</div>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <span class="pill">‚ö° +Hint: <b id="pPuHint">0</b></span>
            <span class="pill">‚è≠Ô∏è Skip: <b id="pPuSkip">0</b></span>
            <span class="pill">üëÅÔ∏è Reveal: <b id="pPuReveal">0</b></span>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <b>Power-Up Shop (buy with XP)</b>
        <div class="help">Spend XP to buy power-ups. These work across all modes.</div>
        <div style="margin-top:10px; display:grid; gap:10px;">
          <div class="row">
            <div>
              <b>‚ö° +Hint Token</b>
              <div class="help">Adds +1 hint to the current stage, even after hints end.</div>
              <span class="tag">Cost: 25 XP</span>
            </div>
            <div class="right"><button class="btn primary" id="buyHint">Buy</button></div>
          </div>
          <hr class="hr">
          <div class="row">
            <div>
              <b>üëÅÔ∏è Reveal Token</b>
              <div class="help">Shows expected output + extra guidance for the current stage.</div>
              <span class="tag">Cost: 35 XP</span>
            </div>
            <div class="right"><button class="btn primary" id="buyReveal">Buy</button></div>
          </div>
          <hr class="hr">
          <div class="row">
            <div>
              <b>‚è≠Ô∏è Skip Token</b>
              <div class="help">Skips a stage (does NOT count as solved).</div>
              <span class="tag">Cost: 60 XP</span>
            </div>
            <div class="right"><button class="btn primary" id="buySkip">Buy</button></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <b>Recent solved stages</b>
        <div class="story">Last 12 solved</div>
        <div id="recentLevels" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;"></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <b>Achievements / Badges</b>
        <div class="story">You‚Äôll get popups when you unlock these.</div>
        <div id="badgeList" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;"></div>
      </div>
    </div>

    <div id="leaderView" class="card" style="display:none;">
      <div class="row">
        <div>
          <div class="pill">üèÜ <b>Global Leaderboard</b></div>
          <div class="story">Top students by XP (global)</div>
        </div>
        <div class="right">
          <button class="btn ghost" id="lbRefresh">Refresh</button>
          <button class="btn ghost" id="lbBack">Back</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="story">Top 10</div>
        <div id="leaderList" style="margin-top:10px; display:grid; gap:10px;"></div>
        <div class="help" id="lbStatus"></div>
      </div>
    </div>

    <div id="devView" class="card" style="display:none;">
      <div class="row">
        <div>
          <div class="pill">üõ†Ô∏è <b>Dev Control</b></div>
          <div class="story">Admin login required. You can see global visits and search profiles.</div>
        </div>
        <div class="right"><button class="btn ghost" id="devClose">Close</button></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <b>Admin Login</b>
        <div class="help">Use Firebase Authentication email/password (only you).</div>
        <div style="margin-top:10px; display:grid; gap:8px;">
          <input id="adminEmail" placeholder="Admin email">
          <input id="adminPass" type="password" placeholder="Admin password">
          <button class="btn primary" id="adminLoginBtn">Login</button>
          <div class="help" id="adminStatus"></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <b>Global visits</b>
        <div style="margin-top:10px;">
          <span class="pill">üåç Visits: <b id="devGlobalVisits">-</b></span>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <b>Search a student profile</b>
        <div class="help">Search by username (case-insensitive, exact).</div>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <input id="devSearch" placeholder="Type username e.g., ankush" style="flex:1; min-width:220px;">
          <button class="btn primary" id="devSearchBtn">Search</button>
        </div>
        <pre id="devResult" style="margin-top:10px; min-height:120px;"></pre>
      </div>

      <div class="card" style="margin-top:12px;">
        <b>üéÅ Give XP to a student</b>
        <div class="help">Adds XP to a username. (Global, stored in Firestore)</div>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <input id="devXpUser" placeholder="Username e.g., ankush" style="flex:1; min-width:220px;">
          <input id="devXpAmount" type="number" placeholder="XP e.g., 100" style="width:200px;">
          <button class="btn primary" id="devGiveXpBtn">Send XP</button>
        </div>
        <div class="help" id="devXpStatus"></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <b>‚ö° Give Powerups to a student</b>
        <div class="help">Adds powerups (Hint / Reveal / Skip) to a username.</div>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <input id="devPwUser" placeholder="Username e.g., ankush" style="flex:1; min-width:220px;">
          <select id="devPwType" style="width:220px;">
            <option value="hint">‚ö° +Hint</option>
            <option value="reveal">üëÅÔ∏è Reveal</option>
            <option value="skip">‚è≠Ô∏è Skip</option>
          </select>
          <input id="devPwAmount" type="number" placeholder="Amount e.g., 2" style="width:200px;">
          <button class="btn primary" id="devGivePwBtn">Send Powerup</button>
        </div>
        <div class="help" id="devPwStatus"></div>
      </div>
    </div>
  </div>

  <!-- Login modal -->
  <div class="modalBackdrop" id="loginBackdrop">
    <div class="modal">
      <div style="font-size:18px; font-weight:700;">Login to PyQuest üîê</div>
      <div class="help">Use the same <b>Username + PIN</b> on any computer to continue your progress.</div>

      <div style="margin-top:10px; display:grid; gap:10px;">
        <div>
          <div class="help" style="margin-bottom:6px;">Username (no spaces)</div>
          <input id="uInput" maxlength="20" placeholder="e.g., ankush">
        </div>

        <div>
          <div class="help" style="margin-bottom:6px;">PIN (4‚Äì6 digits)</div>
          <input id="pinInput" maxlength="6" inputmode="numeric" placeholder="e.g., 1234">
        </div>

        <div id="trackBlock" style="display:none;">
          <div class="help" style="margin-bottom:6px;">Choose your mode (only for NEW account)</div>
          <select id="trackSelect">
            <option value="learn">Learn Python (25 guided lessons)</option>
            <option value="beginner">Beginner</option>
            <option value="moderate">Moderate</option>
            <option value="pro">Professional</option>
          </select>
        </div>

        <div class="help" id="loginMsg"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn primary" id="loginBtn">Login</button>
          <button class="btn ghost" id="createBtn">Create New</button>
        </div>

        <hr class="hr">
        <div class="help">
          If username exists ‚Üí use <b>Login</b>.<br>
          If it doesn‚Äôt exist ‚Üí choose mode then click <b>Create New</b>.
        </div>
      </div>
    </div>
  </div>

  <!-- Explain modal -->
  <div class="modalBackdrop" id="explainBackdrop">
    <div class="modal">
      <div style="font-size:18px; font-weight:800;">‚úÖ Stage Solved! Explain your code ‚úçÔ∏è</div>
      <div class="help" id="explainHintLine">Write a short explanation. If it includes key ideas, you get bonus XP.</div>

      <div style="margin-top:10px;">
        <div class="label">Your code</div>
        <pre id="solvedCodePreview"></pre>
      </div>

      <div style="margin-top:10px;">
        <div class="label">Your explanation</div>
        <textarea id="explainInput" rows="4" style="color:#e5e7eb;background:#020617;"></textarea>
        <div class="help" id="explainStatus"></div>
      </div>

      <div id="explainMeBox" style="display:none; margin-top:10px;">
        <div class="label">Explain me</div>
        <pre id="explainMeText"></pre>
      </div>

      <div class="row" style="margin-top:12px;">
        <div class="right" style="margin-left:auto;">
          <button class="btn ghost" id="btnExplainMe">Explain me</button>
          <button class="btn ghost" id="btnSkipExplain">Continue (no bonus)</button>
          <button class="btn primary" id="btnSubmitExplain">Submit explanation</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Track transition modal -->
  <div class="modalBackdrop" id="transitionBackdrop">
    <div class="modal">
      <div style="font-size:18px; font-weight:800;" id="transitionTitle">‚úÖ Completed!</div>
      <div class="help" id="transitionMsg" style="margin-top:8px;">You completed a track.</div>
      <div class="row" style="margin-top:14px;">
        <div class="right" style="margin-left:auto;">
          <button class="btn primary" id="transitionBtn">Go Next</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="tTitle" id="toastTitle">üèÜ Achievement Unlocked!</div>
    <div class="tMsg" id="toastMsg"></div>
  </div>

  <!-- Python engine -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>

  <!-- Firebase + App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, runTransaction, serverTimestamp,
      collection, query, getDocs, limit, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, signInAnonymously, signInWithEmailAndPassword }
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // üî• Paste YOUR Firebase config here
    const firebaseConfig = {
      apiKey: "PASTE_YOUR_KEY",
      authDomain: "PASTE_YOUR_DOMAIN",
      projectId: "PASTE_YOUR_PROJECT_ID",
      storageBucket: "PASTE_YOUR_BUCKET",
      messagingSenderId: "PASTE_YOUR_SENDER_ID",
      appId: "PASTE_YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Track lengths (finite)
    const MAX_BEGINNER_STAGES = 35;
    const MAX_MODERATE_STAGES = 35;
    const MAX_PRO_STAGES = 35;

    // ---------- UI refs ----------
    const playView = document.getElementById("playView");
    const profileView = document.getElementById("profileView");
    const leaderView = document.getElementById("leaderView");
    const devView = document.getElementById("devView");

    const navPlay = document.getElementById("navPlay");
    const navProfile = document.getElementById("navProfile");
    const navLeaderboard = document.getElementById("navLeaderboard");
    const navLogout = document.getElementById("navLogout");
    const backToPlay = document.getElementById("backToPlay");

    const championBanner = document.getElementById("championBanner");
    const profileCrown = document.getElementById("profileCrown");

    const lbRefresh = document.getElementById("lbRefresh");
    const lbBack = document.getElementById("lbBack");
    const leaderList = document.getElementById("leaderList");
    const lbStatus = document.getElementById("lbStatus");

    const devBtn = document.getElementById("devBtn");
    const devClose = document.getElementById("devClose");

    const welcomeLine = document.getElementById("welcomeLine");
    const trackPill = document.getElementById("trackPill");
    const skillPill = document.getElementById("skillPill");
    const levelTitle = document.getElementById("levelTitle");
    const storyEl = document.getElementById("story");
    const promptEl = document.getElementById("prompt");
    const codeEl = document.getElementById("code");
    const outputEl = document.getElementById("output");
    const hintsEl = document.getElementById("hints");

    const hintBtn = document.getElementById("hintBtn");
    const exBtn = document.getElementById("exBtn");
    const runBtn = document.getElementById("runBtn");
    const submitBtn = document.getElementById("submitBtn");
    const continueLessonBtn = document.getElementById("continueLessonBtn");

    const useHintPU = document.getElementById("useHintPU");
    const useSkipPU = document.getElementById("useSkipPU");
    const useRevealPU = document.getElementById("useRevealPU");
    const puHint = document.getElementById("puHint");
    const puSkip = document.getElementById("puSkip");
    const puReveal = document.getElementById("puReveal");

    const xpEl = document.getElementById("xp");
    const badgeCountEl = document.getElementById("badgeCount");
    const solvedCountEl = document.getElementById("solvedCount");
    const globalVisitsEl = document.getElementById("globalVisits");

    const profileNameEl = document.getElementById("profileName");
    const pTrack = document.getElementById("pTrack");
    const pSolved = document.getElementById("pSolved");
    const pXp = document.getElementById("pXp");
    const pHints = document.getElementById("pHints");
    const pCurrent = document.getElementById("pCurrent");
    const pSkill = document.getElementById("pSkill");
    const recentLevelsEl = document.getElementById("recentLevels");
    const badgeListEl = document.getElementById("badgeList");

    const pPuHint = document.getElementById("pPuHint");
    const pPuSkip = document.getElementById("pPuSkip");
    const pPuReveal = document.getElementById("pPuReveal");

    const buyHint = document.getElementById("buyHint");
    const buyReveal = document.getElementById("buyReveal");
    const buySkip = document.getElementById("buySkip");

    const switchTrack = document.getElementById("switchTrack");
    const applyTrack = document.getElementById("applyTrack");
    const resetThisTrack = document.getElementById("resetThisTrack");
    const switchMsg = document.getElementById("switchMsg");

    const loginBackdrop = document.getElementById("loginBackdrop");
    const uInput = document.getElementById("uInput");
    const pinInput = document.getElementById("pinInput");
    const trackBlock = document.getElementById("trackBlock");
    const trackSelect = document.getElementById("trackSelect");
    const loginBtn = document.getElementById("loginBtn");
    const createBtn = document.getElementById("createBtn");
    const loginMsg = document.getElementById("loginMsg");

    const explainBackdrop = document.getElementById("explainBackdrop");
    const solvedCodePreview = document.getElementById("solvedCodePreview");
    const explainInput = document.getElementById("explainInput");
    const explainStatus = document.getElementById("explainStatus");
    const explainMeBox = document.getElementById("explainMeBox");
    const explainMeText = document.getElementById("explainMeText");
    const btnExplainMe = document.getElementById("btnExplainMe");
    const btnSkipExplain = document.getElementById("btnSkipExplain");
    const btnSubmitExplain = document.getElementById("btnSubmitExplain");

    const transitionBackdrop = document.getElementById("transitionBackdrop");
    const transitionTitle = document.getElementById("transitionTitle");
    const transitionMsg = document.getElementById("transitionMsg");
    const transitionBtn = document.getElementById("transitionBtn");

    const toast = document.getElementById("toast");
    const toastTitle = document.getElementById("toastTitle");
    const toastMsg = document.getElementById("toastMsg");
    let toastTimer = null;

    const adminEmail = document.getElementById("adminEmail");
    const adminPass = document.getElementById("adminPass");
    const adminLoginBtn = document.getElementById("adminLoginBtn");
    const adminStatus = document.getElementById("adminStatus");
    const devGlobalVisitsEl = document.getElementById("devGlobalVisits");
    const devSearch = document.getElementById("devSearch");
    const devSearchBtn = document.getElementById("devSearchBtn");
    const devResult = document.getElementById("devResult");

    const devXpUser = document.getElementById("devXpUser");
    const devXpAmount = document.getElementById("devXpAmount");
    const devGiveXpBtn = document.getElementById("devGiveXpBtn");
    const devXpStatus = document.getElementById("devXpStatus");

    const devPwUser = document.getElementById("devPwUser");
    const devPwType = document.getElementById("devPwType");
    const devPwAmount = document.getElementById("devPwAmount");
    const devGivePwBtn = document.getElementById("devGivePwBtn");
    const devPwStatus = document.getElementById("devPwStatus");

    // ---------- helpers ----------
    function showToast(title, msg){
      toastTitle.textContent = title;
      toastMsg.textContent = msg;
      toast.style.display = "block";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => { toast.style.display = "none"; }, 3600);
    }

    function spawnConfetti(count = 90){
      for(let i=0; i<count; i++){
        const c = document.createElement("div");
        c.className = "confetti";
        c.style.left = Math.random() * 100 + "vw";
        c.style.background = `hsl(${Math.random()*360}, 90%, 60%)`;
        c.style.transform = `rotate(${Math.random()*360}deg)`;
        c.style.animationDuration = (1.6 + Math.random()*1.4) + "s";
        c.style.width = (6 + Math.random()*8) + "px";
        c.style.height = (8 + Math.random()*10) + "px";
        document.body.appendChild(c);
        setTimeout(() => c.remove(), 2600);
      }
    }

    function setBusy(isBusy) {
      runBtn.disabled = isBusy;
      submitBtn.disabled = isBusy;
      hintBtn.disabled = isBusy;
      exBtn.disabled = isBusy;
      useHintPU.disabled = isBusy;
      useRevealPU.disabled = isBusy;
      useSkipPU.disabled = isBusy;
      continueLessonBtn.disabled = isBusy;
    }

    function normalizeOutput(s){ return String(s).replace(/\s+/g, " ").trim(); }

    function trackLabel(t){
      if(t === "learn") return "Learn Python";
      if(t === "beginner") return "Beginner";
      if(t === "moderate") return "Moderate";
      if(t === "pro") return "Professional";
      if(t === "endless") return "Endless";
      return "-";
    }

    async function sha256Hex(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, "0")).join("");
    }

    function cleanUsername(raw){
      return (raw || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g, "")
        .replace(/[^a-z0-9_]/g, "");
    }

    function validPin(pin){ return /^[0-9]{4,6}$/.test(pin || ""); }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    // ---------- Firestore structure ----------
    const USERS_COL = "users_public";
    const STATS_DOC = doc(db, "stats", "global");
    const SESSION_KEY = "pyquest_session_user";

    // show dev ctrl only if ?dev=1
    const urlParams = new URLSearchParams(location.search);
    if(urlParams.get("dev") === "1") devBtn.style.display = "inline-block";

    // ---------- State ----------
    const COSTS = { hint: 25, reveal: 35, skip: 60 };

    function emptyProgress(){
      return { currentLevel: 1, perLevelHintsLeft: {} };
    }

    function defaultState(){
      return {
        username: "",
        track: "learn",
        xp: 0,
        solvedLevels: [],
        skippedLevels: [],
        badges: [],
        hintsUsedTotal: 0,
        powerUps: { hint: 0, reveal: 0, skip: 0 },
        skill: 1,
        lastSolveMs: null,
        isChampion: false,

        progressByTrack: {
          learn: emptyProgress(),
          beginner: emptyProgress(),
          moderate: emptyProgress(),
          pro: emptyProgress(),
        },

        endlessUnlocked: false,
        rewardTiers: { hint: 0, reveal: 0, skip: 0 },
      };
    }

    let state = defaultState();
    let sessionUser = localStorage.getItem(SESSION_KEY) || "";

    function getProgress(){
      const t = state.track || "learn";
      if(!state.progressByTrack) state.progressByTrack = { learn: emptyProgress(), beginner: emptyProgress(), moderate: emptyProgress(), pro: emptyProgress() };
      if(!state.progressByTrack[t]) state.progressByTrack[t] = emptyProgress();
      return state.progressByTrack[t];
    }

    function setWelcome(){
      const nm = state.username ? state.username : "Student";
      const cur = getProgress().currentLevel || 1;
      welcomeLine.textContent = `Hi ${nm}! Track: ${trackLabel(state.track)} ‚Äî Stage ${cur}`;
      profileNameEl.textContent = `${nm}'s Profile`;
      trackPill.textContent = trackLabel(state.track);
      pTrack.textContent = trackLabel(state.track);
      skillPill.textContent = String(state.skill || 1);
      pSkill.textContent = String(state.skill || 1);
    }

    function updateTopStats(){
      xpEl.textContent = state.xp;
      badgeCountEl.textContent = state.badges.length;
      solvedCountEl.textContent = state.solvedLevels.length;

      puHint.textContent = state.powerUps?.hint ?? 0;
      puReveal.textContent = state.powerUps?.reveal ?? 0;
      puSkip.textContent = state.powerUps?.skip ?? 0;

      useHintPU.disabled = !(state.powerUps?.hint > 0);
      useRevealPU.disabled = !(state.powerUps?.reveal > 0);
      useSkipPU.disabled = !(state.powerUps?.skip > 0);

      trackPill.textContent = trackLabel(state.track);
      skillPill.textContent = String(state.skill || 1);
    }

    function syncSwitchDropdown(){
      switchTrack.value = state.track || "learn";
    }

    function updateProfile(){
      setWelcome();
      const cur = getProgress().currentLevel || 1;

      pSolved.textContent = state.solvedLevels.length;
      pXp.textContent = state.xp;
      pHints.textContent = state.hintsUsedTotal;
      pCurrent.textContent = cur;
      pSkill.textContent = String(state.skill || 1);

      pPuHint.textContent = state.powerUps?.hint ?? 0;
      pPuReveal.textContent = state.powerUps?.reveal ?? 0;
      pPuSkip.textContent = state.powerUps?.skip ?? 0;

      recentLevelsEl.innerHTML = "";
      const recent = state.solvedLevels.slice(-12).reverse();
      if(recent.length === 0){
        const span = document.createElement("span");
        span.className = "pill";
        span.textContent = "No solved stages yet";
        recentLevelsEl.appendChild(span);
      } else {
        for(const lv of recent){
          const span = document.createElement("span");
          span.className = "pill";
          span.textContent = "Solved " + lv;
          recentLevelsEl.appendChild(span);
        }
      }

      badgeListEl.innerHTML = "";
      for(const b of BADGES){
        const earned = state.badges.includes(b.id);
        const div = document.createElement("div");
        div.className = "badge";
        div.innerHTML = `
          <div style="font-size:20px;">${earned ? "üèÖ" : "üîí"}</div>
          <div>
            <div><b>${b.name}</b></div>
            <small>${earned ? "Unlocked" : b.desc}</small>
          </div>
        `;
        badgeListEl.appendChild(div);
      }

      syncSwitchDropdown();
    }

    // ---------- Views ----------
    function showPlay(){
      profileView.style.display = "none";
      leaderView.style.display = "none";
      devView.style.display = "none";
      playView.style.display = "block";
      updateTopStats();
      setWelcome();
    }

    async function showProfile(){
      playView.style.display = "none";
      leaderView.style.display = "none";
      devView.style.display = "none";
      profileView.style.display = "block";
      updateProfile();
      await refreshChampionStatus();
    }

    async function showLeaderboard(){
      playView.style.display = "none";
      profileView.style.display = "none";
      devView.style.display = "none";
      leaderView.style.display = "block";
      await loadLeaderboard();
      await refreshChampionStatus();
    }

    function showDev(){
      playView.style.display = "none";
      profileView.style.display = "none";
      leaderView.style.display = "none";
      devView.style.display = "block";
      adminStatus.textContent = "Please login to use Dev Ctrl.";
      devResult.textContent = "Login first, then search a username.";
      devXpStatus.textContent = "";
      devPwStatus.textContent = "";
    }

    navPlay.onclick = showPlay;
    navProfile.onclick = () => showProfile();
    navLeaderboard.onclick = () => showLeaderboard();
    devBtn.onclick = showDev;
    devClose.onclick = showPlay;
    backToPlay.onclick = showPlay;

    navLogout.onclick = () => {
      const ok = confirm("Logout? Your progress stays online, you can login again with username+PIN.");
      if(!ok) return;
      localStorage.removeItem(SESSION_KEY);
      sessionUser = "";
      state = defaultState();
      setWelcome();
      showLoginModal();
    };

    // ---------- Transition Modal ----------
    let transitionAction = null;
    function showTransitionModal({title, msg, buttonText, onConfirm}){
      transitionTitle.textContent = title;
      transitionMsg.textContent = msg;
      transitionBtn.textContent = buttonText || "Continue";
      transitionAction = onConfirm || null;
      transitionBackdrop.style.display = "flex";
    }
    function hideTransitionModal(){
      transitionBackdrop.style.display = "none";
      transitionAction = null;
    }
    transitionBtn.onclick = async () => {
      hideTransitionModal();
      if(typeof transitionAction === "function"){
        await transitionAction();
      }
    };

    // ---------- Login modal ----------
    function showLoginModal(){
      loginBackdrop.style.display = "flex";
      loginMsg.textContent = "";
      trackBlock.style.display = "none";
      setTimeout(() => uInput.focus(), 50);
    }
    function hideLoginModal(){ loginBackdrop.style.display = "none"; }

    function showExplainModal(codeText){
      solvedCodePreview.textContent = codeText || "";
      explainInput.value = "";
      explainStatus.textContent = "";
      explainMeBox.style.display = "none";
      explainBackdrop.style.display = "flex";
    }
    function hideExplainModal(){ explainBackdrop.style.display = "none"; }

    // ---------- Firestore: load/save ----------
    async function loadUserProfile(usernameLower){
      const ref = doc(db, USERS_COL, usernameLower);
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    function migrateProfileToNewShape(profile, usernameLower){
      const s = defaultState();
      s.username = profile.username || usernameLower;
      s.track = profile.track || "learn";
      s.xp = profile.xp ?? 0;
      s.solvedLevels = Array.isArray(profile.solvedLevels) ? profile.solvedLevels : [];
      s.skippedLevels = Array.isArray(profile.skippedLevels) ? profile.skippedLevels : [];
      s.badges = Array.isArray(profile.badges) ? profile.badges : [];
      s.hintsUsedTotal = profile.hintsUsedTotal ?? 0;
      s.powerUps = profile.powerUps || {hint:0,reveal:0,skip:0};
      s.skill = profile.skill ?? 1;
      s.lastSolveMs = profile.lastSolveMs ?? null;
      s.rewardTiers = profile.rewardTiers || {hint:0,reveal:0,skip:0};
      s.endlessUnlocked = !!profile.endlessUnlocked;

      const pb = profile.progressByTrack || null;
      if(pb){
        s.progressByTrack = pb;
        for(const k of ["learn","beginner","moderate","pro"]){
          if(!s.progressByTrack[k]) s.progressByTrack[k] = emptyProgress();
          if(!s.progressByTrack[k].currentLevel) s.progressByTrack[k].currentLevel = 1;
          if(!s.progressByTrack[k].perLevelHintsLeft) s.progressByTrack[k].perLevelHintsLeft = {};
        }
      }

      if(!s.progressByTrack[s.track]) s.progressByTrack[s.track] = emptyProgress();
      return s;
    }

    async function saveUserProfile(){
      if(!state.username) return;
      const ref = doc(db, USERS_COL, state.username);

      const payload = {
        username: state.username,
        usernameLower: state.username,
        track: state.track || "learn",
        xp: state.xp,
        solvedLevels: state.solvedLevels,
        skippedLevels: state.skippedLevels || [],
        badges: state.badges,
        hintsUsedTotal: state.hintsUsedTotal,
        powerUps: state.powerUps || {hint:0,reveal:0,skip:0},
        skill: state.skill || 1,
        lastSolveMs: state.lastSolveMs ?? null,
        progressByTrack: state.progressByTrack,
        rewardTiers: state.rewardTiers,
        endlessUnlocked: !!state.endlessUnlocked,
        solved: state.solvedLevels.length,
        updatedAt: serverTimestamp(),
      };

      await setDoc(ref, payload, { merge:true });
    }

    // ---------- Auth ----------
    let anonReady = false;
    async function ensureAnonAuth(){
      if(anonReady && auth.currentUser) return;
      try{ await signInAnonymously(auth); } catch {}
      anonReady = true;
    }

    // ---------- Username+PIN login ----------
    loginBtn.onclick = async () => {
      loginMsg.textContent = "Checking account...";
      const usernameLower = cleanUsername(uInput.value);
      const pin = (pinInput.value || "").trim();

      if(!usernameLower){
        loginMsg.textContent = "‚ùå Enter a valid username (letters/numbers/_ only).";
        return;
      }
      if(!validPin(pin)){
        loginMsg.textContent = "‚ùå PIN must be 4‚Äì6 digits.";
        return;
      }

      try{
        const profile = await loadUserProfile(usernameLower);
        if(!profile){
          trackBlock.style.display = "block";
          loginMsg.textContent = "‚ö†Ô∏è Username not found. Choose a mode then click 'Create New'.";
          return;
        }

        const pinHash = await sha256Hex(pin);
        if(profile.pinHash !== pinHash){
          loginMsg.textContent = "‚ùå Wrong PIN. Try again.";
          return;
        }

        state = migrateProfileToNewShape(profile, usernameLower);
        sessionUser = usernameLower;
        localStorage.setItem(SESSION_KEY, usernameLower);

        hideLoginModal();
        setWelcome();
        updateTopStats();
        loadStage(getProgress().currentLevel || 1);
        showPlay();

        showToast("‚úÖ Logged in", `Welcome back, ${state.username}!`);
        await refreshChampionStatus();
      } catch (e){
        console.warn(e);
        loginMsg.textContent = "‚ùå Login failed (check internet).";
      }
    };

    createBtn.onclick = async () => {
      loginMsg.textContent = "Creating...";
      const usernameLower = cleanUsername(uInput.value);
      const pin = (pinInput.value || "").trim();

      if(!usernameLower){
        loginMsg.textContent = "‚ùå Enter a valid username (letters/numbers/_ only).";
        return;
      }
      if(!validPin(pin)){
        loginMsg.textContent = "‚ùå PIN must be 4‚Äì6 digits.";
        return;
      }

      trackBlock.style.display = "block";
      const tr = (trackSelect.value || "").trim();
      if(!tr){
        loginMsg.textContent = "‚ùå Choose your mode.";
        return;
      }

      try{
        const pinHash = await sha256Hex(pin);
        const userRef = doc(db, USERS_COL, usernameLower);

        await runTransaction(db, async (tx) => {
          const snap = await tx.get(userRef);
          if(snap.exists()) throw new Error("USERNAME_TAKEN");

          const newState = defaultState();
          newState.username = usernameLower;
          newState.track = tr;

          tx.set(userRef, {
            username: usernameLower,
            usernameLower: usernameLower,
            pinHash,

            track: newState.track,
            xp: newState.xp,
            solvedLevels: newState.solvedLevels,
            skippedLevels: newState.skippedLevels,
            badges: newState.badges,
            hintsUsedTotal: newState.hintsUsedTotal,
            powerUps: newState.powerUps,
            skill: newState.skill,
            lastSolveMs: null,
            rewardTiers: newState.rewardTiers,
            progressByTrack: newState.progressByTrack,
            endlessUnlocked: false,

            solved: 0,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
          });
        });

        state = defaultState();
        state.username = usernameLower;
        state.track = tr;

        sessionUser = usernameLower;
        localStorage.setItem(SESSION_KEY, usernameLower);

        hideLoginModal();
        setWelcome();
        updateTopStats();
        loadStage(1);
        showPlay();

        showToast("üéâ Account created!", `Welcome, ${state.username}!`);
        await refreshChampionStatus();
      } catch (e){
        if(String(e?.message || e).includes("USERNAME_TAKEN")){
          loginMsg.textContent = "‚ùå Username already taken. Choose a different one.";
          return;
        }
        console.warn(e);
        loginMsg.textContent = "‚ùå Create failed (check internet).";
      }
    };

    // ---------- Dev Ctrl (Admin) ----------
    let isAdminLoggedIn = false;
    adminLoginBtn.onclick = async () => {
      adminStatus.textContent = "Logging in...";
      try{
        await signInWithEmailAndPassword(auth, (adminEmail.value || "").trim(), adminPass.value || "");
        isAdminLoggedIn = true;
        adminStatus.textContent = "‚úÖ Admin logged in.";
        await readGlobalVisits();
      }catch(e){
        isAdminLoggedIn = false;
        adminStatus.textContent = "‚ùå Login failed: " + (e?.message || e);
      }
    };

    devSearchBtn.onclick = async () => {
      if(!isAdminLoggedIn){
        devResult.textContent = "‚ùå Please login as admin first.";
        return;
      }
      const qUser = cleanUsername(devSearch.value);
      if(!qUser){
        devResult.textContent = "Type a username to search.";
        return;
      }

      devResult.textContent = "Searching...";
      try{
        const prof = await loadUserProfile(qUser);
        if(!prof){
          devResult.textContent = "Not found.";
          return;
        }
        devResult.textContent =
          `FOUND PROFILE\n\n` +
          `Username: ${prof.username}\n` +
          `Track: ${trackLabel(prof.track || "learn")}\n` +
          `Solved: ${prof.solved ?? (prof.solvedLevels?.length || 0)}\n` +
          `XP: ${prof.xp ?? 0}\n` +
          `PowerUps: ${JSON.stringify(prof.powerUps || {hint:0,reveal:0,skip:0}, null, 2)}\n\n` +
          `Learn Stage: ${prof.progressByTrack?.learn?.currentLevel ?? 1}\n` +
          `Beginner Stage: ${prof.progressByTrack?.beginner?.currentLevel ?? 1}\n` +
          `Moderate Stage: ${prof.progressByTrack?.moderate?.currentLevel ?? 1}\n` +
          `Pro Stage: ${prof.progressByTrack?.pro?.currentLevel ?? 1}\n` +
          `Endless Unlocked: ${prof.endlessUnlocked ? "YES" : "NO"}\n`;
      } catch(e){
        devResult.textContent = "Error: " + (e?.message || e);
      }
    };

    devGiveXpBtn.onclick = async () => {
      if(!isAdminLoggedIn){
        devXpStatus.textContent = "‚ùå Admin login required.";
        return;
      }
      const u = cleanUsername(devXpUser.value);
      const amt = Number(devXpAmount.value);
      if(!u){ devXpStatus.textContent = "‚ùå Enter a username."; return; }
      if(!Number.isFinite(amt) || amt <= 0){ devXpStatus.textContent = "‚ùå Enter valid XP amount."; return; }

      devXpStatus.textContent = "Sending...";
      try{
        const userRef = doc(db, USERS_COL, u);
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(userRef);
          if(!snap.exists()) throw new Error("NOT_FOUND");
          const d = snap.data() || {};
          const newXp = (d.xp || 0) + amt;
          tx.set(userRef, { xp: newXp, updatedAt: serverTimestamp() }, { merge:true });
        });
        devXpStatus.textContent = `‚úÖ Added ${amt} XP to ${u}`;
      } catch(e){
        devXpStatus.textContent = String(e?.message || e).includes("NOT_FOUND") ? "‚ùå User not found." : ("‚ùå Failed: " + (e?.message || e));
      }
    };

    devGivePwBtn.onclick = async () => {
      if(!isAdminLoggedIn){
        devPwStatus.textContent = "‚ùå Admin login required.";
        return;
      }
      const u = cleanUsername(devPwUser.value);
      const type = (devPwType.value || "").trim();
      const amt = Number(devPwAmount.value);

      if(!u){ devPwStatus.textContent = "‚ùå Enter a username."; return; }
      if(!["hint","reveal","skip"].includes(type)){ devPwStatus.textContent = "‚ùå Choose powerup type."; return; }
      if(!Number.isFinite(amt) || amt <= 0){ devPwStatus.textContent = "‚ùå Enter valid amount."; return; }

      devPwStatus.textContent = "Sending...";
      try{
        const userRef = doc(db, USERS_COL, u);
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(userRef);
          if(!snap.exists()) throw new Error("NOT_FOUND");
          const d = snap.data() || {};
          const pu = d.powerUps || { hint:0, reveal:0, skip:0 };
          pu[type] = (pu[type] || 0) + amt;
          tx.set(userRef, { powerUps: pu, updatedAt: serverTimestamp() }, { merge:true });
        });
        devPwStatus.textContent = `‚úÖ Added ${amt} √ó ${type.toUpperCase()} to ${u}`;
      } catch(e){
        devPwStatus.textContent = String(e?.message || e).includes("NOT_FOUND") ? "‚ùå User not found." : ("‚ùå Failed: " + (e?.message || e));
      }
    };

    // ---------- Global visits ----------
    async function incrementGlobalVisitOncePerTab(){
      const key = "pyquest_counted_visit";
      if(sessionStorage.getItem(key) === "1") return;
      sessionStorage.setItem(key, "1");

      await runTransaction(db, async (tx) => {
        const snap = await tx.get(STATS_DOC);
        const cur = snap.exists() ? (snap.data().visits || 0) : 0;
        tx.set(STATS_DOC, { visits: cur + 1, updatedAt: serverTimestamp() }, { merge:true });
      });
    }

    async function readGlobalVisits(){
      const snap = await getDoc(STATS_DOC);
      const v = snap.exists() ? (snap.data().visits || 0) : 0;
      globalVisitsEl.textContent = v;
      devGlobalVisitsEl.textContent = v;
    }

    // ---------- Leaderboard + Champion ----------
    async function loadLeaderboard(){
      lbStatus.textContent = "Loading leaderboard...";
      leaderList.innerHTML = "";
      try{
        const colRef = collection(db, USERS_COL);
        const qy = query(colRef, orderBy("xp", "desc"), limit(10));
        const snap = await getDocs(qy);

        if(snap.empty){
          lbStatus.textContent = "No players yet.";
          return;
        }

        let rank = 1;
        snap.forEach((docSnap) => {
          const d = docSnap.data();
          const name = d.username || docSnap.id;
          const xp = d.xp ?? 0;
          const solved = d.solved ?? (d.solvedLevels?.length || 0);

          const row = document.createElement("div");
          row.className = "card";
          row.style.margin = "0";
          row.innerHTML = `
            <div class="row">
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <div class="pill">#${rank}</div>
                <div><b>${name}</b></div>
                ${rank === 1 ? `<div class="pill champPill">üëë Champion</div>` : ""}
              </div>
              <div class="right">
                <span class="pill">‚úÖ Solved: <b>${solved}</b></span>
                <span class="pill">‚≠ê XP: <b>${xp}</b></span>
              </div>
            </div>
          `;
          leaderList.appendChild(row);
          rank++;
        });

        lbStatus.textContent = "‚úÖ Updated.";
      } catch {
        lbStatus.textContent = "‚ùå Failed to load. (Check Firestore rules / internet.)";
      }
    }

    lbRefresh.onclick = () => loadLeaderboard();
    lbBack.onclick = showPlay;

    async function refreshChampionStatus(){
      try{
        const colRef = collection(db, USERS_COL);
        const qy = query(colRef, orderBy("xp", "desc"), limit(1));
        const snap = await getDocs(qy);
        const top1 = snap.empty ? null : snap.docs[0].id;
        const amIChampion = !!(state.username && top1 && state.username === top1);

        championBanner.style.display = amIChampion ? "block" : "none";
        if(amIChampion) profileCrown.classList.add("show");
        else profileCrown.classList.remove("show");

        if(amIChampion && !state.isChampion){
          state.isChampion = true;
          showToast("üëë You are #1!", "You are currently TOP 1 on the global leaderboard!");
          spawnConfetti(120);
        }
        if(!amIChampion) state.isChampion = false;
      } catch {
        championBanner.style.display = "none";
        profileCrown.classList.remove("show");
        state.isChampion = false;
      }
    }

    // ---------- Python engine ----------
    let pyodide = null;
    async function ensurePyodide(){
      if(pyodide) return pyodide;
      setBusy(true);
      outputEl.textContent = "Loading Python engine...";
      try{
        pyodide = await loadPyodide();
        outputEl.textContent = "Ready ‚úÖ";
        return pyodide;
      } finally { setBusy(false); }
    }

    function resetStdout(py){
      py.runPython("import sys\nfrom io import StringIO\nsys.stdout = StringIO()\n");
    }
    function getStdout(py){ return String(py.runPython("sys.stdout.getvalue()")); }

    function friendlyError(e){
      const msg = String(e?.message || e);
      if(msg.includes("SyntaxError")) return msg + "\nTip: Check quotes/brackets/colons/indentation.";
      if(msg.includes("NameError")) return msg + "\nTip: Define the variable before using it.";
      if(msg.includes("IndentationError")) return msg + "\nTip: Python indentation matters.";
      return msg;
    }

    // ---------- Difficulty auto adjustment ----------
    function adjustDifficulty({solveMs, hintsUsedThisStage}){
      if(state.track === "learn") return;
      let delta = 0;
      if(solveMs != null){
        if(solveMs < 45000 && hintsUsedThisStage <= 1) delta += 1;
        if(solveMs < 25000 && hintsUsedThisStage === 0) delta += 1;
        if(solveMs > 120000 || hintsUsedThisStage >= 6) delta -= 1;
        if(solveMs > 180000 || hintsUsedThisStage >= 9) delta -= 1;
      }
      state.skill = clamp((state.skill || 1) + delta, 1, 5);
    }

    // ---------- XP Milestone Rewards ----------
    function grantMilestoneRewards(){
      const hintTierNow = Math.floor(state.xp / 150);
      while(state.rewardTiers.hint < hintTierNow){
        state.rewardTiers.hint++;
        state.powerUps.hint = (state.powerUps.hint || 0) + 1;
        showToast("üéÅ Milestone Reward", "You earned +1 Hint Token (150 XP milestone).");
      }

      const revealTierNow = Math.floor(state.xp / 300);
      while(state.rewardTiers.reveal < revealTierNow){
        state.rewardTiers.reveal++;
        state.powerUps.reveal = (state.powerUps.reveal || 0) + 1;
        showToast("üéÅ Milestone Reward", "You earned +1 Reveal Token (300 XP milestone).");
      }

      const skipTierNow = Math.floor(state.xp / 600);
      while(state.rewardTiers.skip < skipTierNow){
        state.rewardTiers.skip++;
        state.powerUps.skip = (state.powerUps.skip || 0) + 1;
        showToast("üéÅ Milestone Reward", "You earned +1 Skip Token (600 XP milestone).");
      }
    }

    // ---------- Badges ----------
    const BADGES = [
      { id:"solve_1",   name:"First Step",      desc:"Solve 1 stage",   rule:(s)=> s.solvedLevels.length >= 1 },
      { id:"solve_5",   name:"Learner x5",      desc:"Solve 5 stages",  rule:(s)=> s.solvedLevels.length >= 5 },
      { id:"solve_10",  name:"Python Rookie",   desc:"Solve 10 stages", rule:(s)=> s.solvedLevels.length >= 10 },
      { id:"solve_20",  name:"Python Explorer", desc:"Solve 20 stages", rule:(s)=> s.solvedLevels.length >= 20 },
      { id:"solve_50",  name:"Python Warrior",  desc:"Solve 50 stages", rule:(s)=> s.solvedLevels.length >= 50 },
      { id:"solve_100", name:"Python Master",   desc:"Solve 100 stages",rule:(s)=> s.solvedLevels.length >= 100 },
      { id:"xp_500",    name:"XP 500",          desc:"Reach 500 XP",    rule:(s)=> s.xp >= 500 },
      { id:"xp_1000",   name:"XP 1000",         desc:"Reach 1000 XP",   rule:(s)=> s.xp >= 1000 },
    ];

    function checkBadges(){
      for(const b of BADGES){
        if(!state.badges.includes(b.id) && b.rule(state)){
          state.badges.push(b.id);
          showToast("üèÜ Achievement Unlocked!", `${b.name}\n${b.desc}`);
          spawnConfetti(70);
        }
      }
    }

    // ============================================================
    // ‚úÖ YOUR 25 LESSONS (exactly as you pasted)
    // ============================================================
    const LEARN_CURRICULUM = [
      {
        name: "print() basics",
        lesson:
`üìò Lesson 1: print()
print(...) shows output on the screen.

Examples:
print("HELLO")
print(123)`,
        q1: {
          prompt: "Print exactly: HELLO",
          starter: "# Write code\n",
          hints: ["Use print('HELLO')", "Quotes matter"],
          exampleCode: "print('HI')",
          expected: "HELLO",
          explainKeywords: ["print", "quotes"],
          explainMe: "Use print with quotes to display text exactly."
        },
        q2: {
          prompt: "Print on 2 lines:\nA\nB",
          starter: "# Write code\n",
          hints: ["Use two print lines", "First print A then print B"],
          exampleCode: "print('A')\nprint('B')",
          expected: "A B",
          explainKeywords: ["print", "line"],
          explainMe: "Two print calls produce two separate lines."
        }
      },

      {
        name: "Strings & quotes",
        lesson:
`üìò Lesson 2: Strings
Strings are text inside quotes: "hello" or 'hello'

You can print quotes using escape:
print("He said \\"Hi\\"")`,
        q1: {
          prompt: `Print exactly: I love Python`,
          starter: "# Write code\n",
          hints: ["Use print('I love Python')"],
          exampleCode: "print('I love Coding')",
          expected: "I love Python",
          explainKeywords: ["string", "quotes", "print"],
          explainMe: "A string is text inside quotes."
        },
        q2: {
          prompt: `Print exactly: He said "Hi"`,
          starter: "# Write code\n",
          hints: ["Use double quotes outside and escape inside", 'Example: print("He said \\"Hi\\"")'],
          exampleCode: 'print("He said \\"Hello\\"")',
          expected: 'He said "Hi"',
          explainKeywords: ["escape", "\\", "quotes"],
          explainMe: "Use \\\" to print a double quote inside a double-quoted string."
        }
      },

      {
        name: "Numbers & arithmetic",
        lesson:
`üìò Lesson 3: Numbers
You can do math:
+  add
-  subtract
*  multiply
/  division

Example:
print(10 + 5)`,
        q1: {
          prompt: "Print the result of 7 + 8",
          starter: "# Write code\n",
          hints: ["Use print(7+8)"],
          exampleCode: "print(3+4)",
          expected: "15",
          explainKeywords: ["+", "print", "add"],
          explainMe: "Use + to add two numbers and print the result."
        },
        q2: {
          prompt: "Print the result of (9 * 3) - 5",
          starter: "# Write code\n",
          hints: ["Use parentheses", "9*3 = 27 then -5"],
          exampleCode: "print((4*2)-1)",
          expected: "22",
          explainKeywords: ["*", "-", "parentheses"],
          explainMe: "Use parentheses to control order, then multiply and subtract."
        }
      },

      {
        name: "Variables",
        lesson:
`üìò Lesson 4: Variables
A variable stores a value.

Example:
x = 10
print(x)`,
        q1: {
          prompt: "Create x = 12 and print x",
          starter: "# Write code\n",
          hints: ["x = 12", "print(x)"],
          exampleCode: "x=5\nprint(x)",
          expected: "12",
          explainKeywords: ["x", "variable", "="],
          explainMe: "Use = to assign a value to a variable and then print it."
        },
        q2: {
          prompt: "Create a=5, b=8 and print a+b",
          starter: "# Write code\n",
          hints: ["a=5", "b=8", "print(a+b)"],
          exampleCode: "a=1\nb=2\nprint(a+b)",
          expected: "13",
          explainKeywords: ["a", "b", "+", "print"],
          explainMe: "Store values in variables and add them."
        }
      },

      {
        name: "f-strings",
        lesson:
`üìò Lesson 5: f-strings
Use f"..." to insert variables into text.

Example:
name = "PyQuest"
print(f"Welcome {name}")`,
        q1: {
          prompt: 'Set name="Ankush" and print: Welcome Ankush',
          starter: "# Write code\n",
          hints: ['name="Ankush"', 'print(f"Welcome {name}")'],
          exampleCode: 'name="X"\nprint(f"Welcome {name}")',
          expected: "Welcome Ankush",
          explainKeywords: ["f\"", "{", "name"],
          explainMe: "f-strings let you place variables inside { }."
        },
        q2: {
          prompt: "Set x=7 and print: x is 7",
          starter: "# Write code\n",
          hints: ["x=7", 'print(f"x is {x}")'],
          exampleCode: 'x=3\nprint(f"x is {x}")',
          expected: "x is 7",
          explainKeywords: ["f-string", "{x}", "print"],
          explainMe: "Use f-string to include x in the output text."
        }
      },

      {
        name: "Type conversion",
        lesson:
`üìò Lesson 6: Type conversion
int("5") -> 5
str(10) -> "10"
float("2.5") -> 2.5`,
        q1: {
          prompt: 'Convert "6" to int and print it + 4',
          starter: "# Write code\n",
          hints: ['n=int("6")', "print(n+4)"],
          exampleCode: 'n=int("3")\nprint(n+1)',
          expected: "10",
          explainKeywords: ["int", "string", "convert"],
          explainMe: "Convert the string to an int, then add 4."
        },
        q2: {
          prompt: "Convert number 21 to string and print: Age: 21",
          starter: "# Write code\n",
          hints: ['s=str(21)', 'print("Age: "+s)'],
          exampleCode: 's=str(5)\nprint("Age: "+s)',
          expected: "Age: 21",
          explainKeywords: ["str", "+", "concatenate"],
          explainMe: "str() converts a number to text so you can join it with other text."
        }
      },

      {
        name: "Booleans & comparisons",
        lesson:
`üìò Lesson 7: Booleans
Comparisons return True/False:
== equal
!= not equal
>  greater
<  less`,
        q1: {
          prompt: "Print the result of: 10 > 3",
          starter: "# Write code\n",
          hints: ["Use print(10 > 3)"],
          exampleCode: "print(2>5)",
          expected: "True",
          explainKeywords: [">", "True", "print"],
          explainMe: "10 is greater than 3, so the comparison is True."
        },
        q2: {
          prompt: "Print the result of: 5 == 8",
          starter: "# Write code\n",
          hints: ["Use == for equal comparison"],
          exampleCode: "print(4==4)",
          expected: "False",
          explainKeywords: ["==", "False"],
          explainMe: "5 is not equal to 8, so it prints False."
        }
      },

      {
        name: "if / elif / else",
        lesson:
`üìò Lesson 8: if / elif / else
Use if to run code when condition is True.

Example:
x = 10
if x > 5:
  print("big")
else:
  print("small")`,
        q1: {
          prompt: "x=10. If x>7 print BIG else print SMALL",
          starter: "# Write code\n",
          hints: ["x=10", "if x>7:", "print('BIG')", "else:"],
          exampleCode: "x=1\nif x>0:\n print('YES')\nelse:\n print('NO')",
          expected: "BIG",
          explainKeywords: ["if", "else", ">"],
          explainMe: "Since 10>7, the if block runs."
        },
        q2: {
          prompt: "x=3. If x==1 print ONE, elif x==3 print THREE, else print OTHER",
          starter: "# Write code\n",
          hints: ["Use if/elif/else", "x==3 should print THREE"],
          exampleCode: "x=2\nif x==1:\n print('ONE')\nelif x==2:\n print('TWO')\nelse:\n print('OTHER')",
          expected: "THREE",
          explainKeywords: ["elif", "==", "else"],
          explainMe: "elif checks another condition if the first is false."
        }
      },

      {
        name: "for loop + range",
        lesson:
`üìò Lesson 9: for loop
range(1, 4) gives 1,2,3

Example:
for i in range(1,4):
  print(i)`,
        q1: {
          prompt: "Print 1 to 3 using a loop",
          starter: "# Write code\n",
          hints: ["Use for i in range(1,4)", "print(i)"],
          exampleCode: "for i in range(1,3):\n print(i)",
          expected: "1 2 3",
          explainKeywords: ["for", "range", "print"],
          explainMe: "range(1,4) produces 1,2,3 and the loop prints them."
        },
        q2: {
          prompt: "Print EVEN for numbers 2,4,6 using a loop",
          starter: "# Write code\n",
          hints: ["Use range(2,7,2)", "Print 'EVEN' inside loop"],
          exampleCode: "for i in range(2,6,2):\n print('EVEN')",
          expected: "EVEN EVEN EVEN",
          explainKeywords: ["range", "step", "loop"],
          explainMe: "range(start, end, step) can jump by 2."
        }
      },

      {
        name: "while loop",
        lesson:
`üìò Lesson 10: while loop
Runs while condition is True.

Example:
i=1
while i<=3:
  print(i)
  i += 1`,
        q1: {
          prompt: "Use while loop to print 1 2 3 (each on new line)",
          starter: "# Write code\n",
          hints: ["i=1", "while i<=3:", "print(i)", "i+=1"],
          exampleCode: "i=1\nwhile i<=2:\n print(i)\n i+=1",
          expected: "1 2 3",
          explainKeywords: ["while", "<=", "i+=1"],
          explainMe: "Increase i each loop so it eventually stops."
        },
        q2: {
          prompt: "Use while loop to print: GO x3 times",
          starter: "# Write code\n",
          hints: ["Use a counter", "Loop 3 times"],
          exampleCode: "c=0\nwhile c<2:\n print('GO')\n c+=1",
          expected: "GO GO GO",
          explainKeywords: ["counter", "while", "<"],
          explainMe: "Count how many times you printed GO."
        }
      },

      {
        name: "Lists basics",
        lesson:
`üìò Lesson 11: Lists
A list stores multiple values:
nums = [1,2,3]
print(nums[0]) -> 1`,
        q1: {
          prompt: "Create nums=[10,20,30] and print the list",
          starter: "# Write code\n",
          hints: ["nums=[10,20,30]", "print(nums)"],
          exampleCode: "nums=[1,2]\nprint(nums)",
          expected: "[10, 20, 30]",
          explainKeywords: ["list", "[", "]", "print"],
          explainMe: "A list is written with square brackets."
        },
        q2: {
          prompt: "Create nums=[5,6,7] and print the first element",
          starter: "# Write code\n",
          hints: ["nums[0] is first element", "print(nums[0])"],
          exampleCode: "nums=[9,8]\nprint(nums[0])",
          expected: "5",
          explainKeywords: ["index", "0", "nums[0]"],
          explainMe: "Index 0 means the first element."
        }
      },

      {
        name: "List methods + len()",
        lesson:
`üìò Lesson 12: append + len
nums.append(x) adds to list end
len(nums) gives number of items`,
        q1: {
          prompt: "Create nums=[1,2]. Append 3. Print nums",
          starter: "# Write code\n",
          hints: ["nums=[1,2]", "nums.append(3)", "print(nums)"],
          exampleCode: "nums=[1]\nnums.append(2)\nprint(nums)",
          expected: "[1, 2, 3]",
          explainKeywords: ["append", "list"],
          explainMe: "append adds an item to the end."
        },
        q2: {
          prompt: "Create nums=[9,8,7,6]. Print len(nums)",
          starter: "# Write code\n",
          hints: ["Use len(nums)"],
          exampleCode: "nums=[1,2,3]\nprint(len(nums))",
          expected: "4",
          explainKeywords: ["len", "list"],
          explainMe: "len returns how many items are in the list."
        }
      },

      {
        name: "Indexing & slicing",
        lesson:
`üìò Lesson 13: Indexing & slicing
s = "python"
s[0] -> 'p'
s[1:4] -> 'yth'`,
        q1: {
          prompt: 's="python". Print s[0]',
          starter: "# Write code\n",
          hints: ["Index 0 is first char", "print(s[0])"],
          exampleCode: 's="abc"\nprint(s[0])',
          expected: "p",
          explainKeywords: ["index", "[0]", "string"],
          explainMe: "Indexing gets one character from a string."
        },
        q2: {
          prompt: 's="python". Print s[1:4]',
          starter: "# Write code\n",
          hints: ["Slice from 1 to 4 (4 not included)"],
          exampleCode: 's="abcdef"\nprint(s[1:4])',
          expected: "yth",
          explainKeywords: ["slice", "1:4"],
          explainMe: "Slicing takes a part of a string using start:end."
        }
      },

      {
        name: "Tuples",
        lesson:
`üìò Lesson 14: Tuples
A tuple is like a list but cannot be changed:
t = (1,2,3)`,
        q1: {
          prompt: "Create t=(4,5,6) and print t",
          starter: "# Write code\n",
          hints: ["Use parentheses", "print(t)"],
          exampleCode: "t=(1,2)\nprint(t)",
          expected: "(4, 5, 6)",
          explainKeywords: ["tuple", "(", ")"],
          explainMe: "A tuple uses parentheses and can store multiple values."
        },
        q2: {
          prompt: "Create t=(9,8,7) and print t[1]",
          starter: "# Write code\n",
          hints: ["Index 1 is second element"],
          exampleCode: "t=(3,4,5)\nprint(t[1])",
          expected: "8",
          explainKeywords: ["index", "tuple"],
          explainMe: "Tuple indexing works like list indexing."
        }
      },

      {
        name: "Dictionaries",
        lesson:
`üìò Lesson 15: Dictionaries (dict)
A dict stores key:value pairs:
d = {"a":1, "b":2}
print(d["a"]) -> 1`,
        q1: {
          prompt: 'Create d={"a":10,"b":20} and print d["b"]',
          starter: "# Write code\n",
          hints: ["Create dict with braces {}", 'Use print(d["b"])'],
          exampleCode: 'd={"x":1,"y":2}\nprint(d["y"])',
          expected: "20",
          explainKeywords: ["dict", "key", "value"],
          explainMe: "Use keys to access values in a dictionary."
        },
        q2: {
          prompt: 'Create d={"name":"PyQuest"} and print: name=PyQuest',
          starter: "# Write code\n",
          hints: ['print("name="+d["name"])'],
          exampleCode: 'd={"name":"X"}\nprint("name="+d["name"])',
          expected: "name=PyQuest",
          explainKeywords: ["dict", 'd["name"]', "concatenate"],
          explainMe: "Get the value from dict using its key and join it into a string."
        }
      },

      {
       

      // NOTE: Your original paste continues up to Lesson 25.
      // I‚Äôm keeping your exact content; just paste the remaining lessons here if your editor shows truncation.
      // If you want, paste your remaining Lesson 16‚Äì25 and I‚Äôll merge them cleanly.
    ];

    // If your editor truncated the lesson list above, PyQuest will still run, but Learn mode will have fewer lessons.
    // (Your original message contained all 25 lessons; paste full list into LEARN_CURRICULUM if needed.)

    // ---------- Learn curriculum stage builder ----------
    function makeLearnStage(stageNumber){
      const topicIndex = Math.floor((stageNumber - 1) / 3) % LEARN_CURRICULUM.length;
      const stageInTopic = (stageNumber - 1) % 3;
      const topic = LEARN_CURRICULUM[topicIndex];

      if(stageInTopic === 0){
        return {
          title: `LEARN ‚Ä¢ Lesson ${topicIndex + 1}/${LEARN_CURRICULUM.length} ‚Äì ${topic.name}`,
          story: "Read the lesson. Then click CONTINUE.",
          prompt: topic.lesson + "\n\nüëâ Click CONTINUE to start Question 1.",
          starter: "",
          hintBudget: 0,
          hints: [],
          exampleCode: "",
          expectedOutput: "",
          explainKeywords: [],
          explainMe: "",
          lessonOnly: true,
          validate: () => true,
        };
      }

      const q = (stageInTopic === 1) ? topic.q1 : topic.q2;
      const expectedNorm = normalizeOutput(q.expected);

      return {
        title: `LEARN ‚Ä¢ Lesson ${topicIndex + 1}/${LEARN_CURRICULUM.length} ‚Äì ${topic.name} ‚Ä¢ ${stageInTopic === 1 ? "Q1" : "Q2"}`,
        story: "Solve it to continue.",
        prompt: q.prompt,
        starter: q.starter,
        hintBudget: 10,
        hints: q.hints,
        exampleCode: q.exampleCode,
        expectedOutput: q.expected,
        explainKeywords: q.explainKeywords,
        explainMe: q.explainMe,
        lessonOnly: false,
        validate: (_py, rawOut) => normalizeOutput(rawOut) === expectedNorm
      };
    }

    // ============================================================
    // ‚úÖ CLEAN STAGES (Beginner/Moderate/Pro) ‚Äî NO UGLY TOKENS
    // ============================================================
    function makeBeginnerStage(n){
      const s = state.skill || 1;
      const type = (n - 1) % 7;

      const a = 2 + ((n * 7) % (10 + s * 6));
      const b = 3 + ((n * 11) % (10 + s * 6));
      const c = 1 + ((n * 13) % (6 + s * 3));

      if(type === 0){
        const expected = `HELLO`;
        return {
          title:`BEGINNER ‚Ä¢ Stage ${n}/${MAX_BEGINNER_STAGES} ‚Äì Print`,
          story:"Beginner concept: print()",
          prompt:`Print exactly:\n${expected}`,
          starter:"# Write code\n",
          hintBudget:10,
          hints:[`Use print('${expected}')`, "Quotes matter."],
          exampleCode:"print('HI')",
          expectedOutput: expected,
          explainKeywords:["print","quotes"],
          explainMe:"Use print(...) with quotes to match exact text.",
          validate:(_py,out)=> normalizeOutput(out) === normalizeOutput(expected)
        };
      }

      if(type === 1){
        const x = a + n;
        const y = b;
        const expected = String(x + y);
        return {
          title:`BEGINNER ‚Ä¢ Stage ${n}/${MAX_BEGINNER_STAGES} ‚Äì Math (Add)`,
          story:"Beginner concept: variables + addition",
          prompt:`Let x = ${x} and y = ${y}. Print x + y`,
          starter:"# Write code\n",
          hintBudget:10,
          hints:["Define x and y then print(x+y)"],
          exampleCode:"x=10\ny=5\nprint(x+y)",
          expectedOutput: expected,
          explainKeywords:["x","y","+"],
          explainMe:"Store numbers in variables and add them.",
          validate:(_py,out)=> normalizeOutput(out) === expected
        };
      }

      if(type === 2){
        const x = (c + 2) * (1 + (n % 3)) + 1;
        const y = (b % 9) + 2;
        const expected = String(x * y);
        return {
          title:`BEGINNER ‚Ä¢ Stage ${n}/${MAX_BEGINNER_STAGES} ‚Äì Math (Multiply)`,
          story:"Beginner concept: multiplication",
          prompt:`Print ${x} * ${y}`,
          starter:"# Write code\n",
          hintBudget:10,
          hints:[`Use print(${x}*${y})`],
          exampleCode:"print(4*5)",
          expectedOutput: expected,
          explainKeywords:["*","multiply"],
          explainMe:"Use * to multiply numbers.",
          validate:(_py,out)=> normalizeOutput(out) === expected
        };
      }

      if(type === 3){
        const x = ((n * 17) % 41) - 20;
        const t = ((n * 19) % 21) - 10;
        const expected = x > t ? `YES` : `NO`;
        return {
          title:`BEGINNER ‚Ä¢ Stage ${n}/${MAX_BEGINNER_STAGES} ‚Äì If/Else`,
          story:"Beginner concept: if/else",
          prompt:`x=${x}. If x>${t} print "YES" else print "NO"`,
          starter:"# Write code\n",
          hintBudget:12,
          hints:[`if x>${t}:`, "else:"],
          exampleCode:`x=${x}\nif x>${t}:\n print("YES")\nelse:\n print("NO")`,
          expectedOutput: expected,
          explainKeywords:["if","else",">"],
          explainMe:"Compare x with the threshold and print correct branch.",
          validate:(_py,out)=> normalizeOutput(out) === normalizeOutput(expected)
        };
      }

      if(type === 4){
        const m = 3 + ((n * 23) % (5 + s * 4));
        const expected = Array.from({length:m},(_,i)=>String(i+1)).join(" ");
        return {
          title:`BEGINNER ‚Ä¢ Stage ${n}/${MAX_BEGINNER_STAGES} ‚Äì Loop`,
          story:"Beginner concept: for loop",
          prompt:`Using a loop, print 1..${m} each on new line`,
          starter:"# Write code\n",
          hintBudget:12,
          hints:[`Use range(1, ${m+1})`, "print(i) inside loop."],
          exampleCode:`for i in range(1,4):\n print(i)`,
          expectedOutput: expected,
          explainKeywords:["for","range","print"],
          explainMe:"Loop prints numbers.",
          validate:(_py,out)=> normalizeOutput(out) === normalizeOutput(expected)
        };
      }

      if(type === 5){
        const word = `pyquest_${n}`.toLowerCase();
        const expected = word.toUpperCase();
        return {
          title:`BEGINNER ‚Ä¢ Stage ${n}/${MAX_BEGINNER_STAGES} ‚Äì Strings`,
          story:"Beginner concept: strings + upper()",
          prompt:`s="${word}". Print s.upper()`,
          starter:"# Write code\n",
          hintBudget:12,
          hints:["Define s as given", "Use print(s.upper())"],
          exampleCode:`s="hello"\nprint(s.upper())`,
          expectedOutput: expected,
          explainKeywords:["upper","string"],
          explainMe:"upper() converts text to uppercase.",
          validate:(_py,out)=> normalizeOutput(out) === normalizeOutput(expected)
        };
      }

      const x1 = (n % 9) + 1;
      const x2 = ((n * 2) % 9) + 1;
      const x3 = ((n * 3) % 9) + 1;
      const expected = String(x1 + x2 + x3 + n);
      return {
        title:`BEGINNER ‚Ä¢ Stage ${n}/${MAX_BEGINNER_STAGES} ‚Äì Lists`,
        story:"Beginner concept: lists + sum",
        prompt:`Create nums=[${x1},${x2},${x3}] and print sum(nums) + ${n}`,
        starter:"# Write code\n",
        hintBudget:12,
        hints:["nums=[...]", "print(sum(nums)+n)"],
        exampleCode:"nums=[1,2,3]\nprint(sum(nums)+5)",
        expectedOutput: expected,
        explainKeywords:["list","sum"],
        explainMe:"sum(nums) adds list values, then add n.",
        validate:(_py,out)=> normalizeOutput(out) === expected
      };
    }

    function makeModerateStage(n){
      const type = (n - 1) % 4;

      if(type === 0){
        const x = 10 + (n % 25);
        const expected = String(x + n);
        return {
          title:`MODERATE ‚Ä¢ Stage ${n}/${MAX_MODERATE_STAGES} ‚Äì Function`,
          story:"Moderate concept: functions",
          prompt:`Write function add_n(x) that returns x + ${n}. Print add_n(${x}).`,
          starter:"# Write code\n",
          hintBudget:14,
          hints:["def add_n(x):", "return x + n", "print(add_n(x))"],
          exampleCode:"def add_n(x):\n return x+3\nprint(add_n(10))",
          expectedOutput: expected,
          explainKeywords:["def","return"],
          explainMe:"Return x + n inside a function.",
          validate:(_py,out)=> normalizeOutput(out) === expected
        };
      }

      if(type === 1){
        const a = (n % 9) + 1;
        const b = ((n*2)%9) + 1;
        const expected = String((a*b) + n);
        return {
          title:`MODERATE ‚Ä¢ Stage ${n}/${MAX_MODERATE_STAGES} ‚Äì Dict`,
          story:"Moderate concept: dictionaries",
          prompt:`Create d={'a':${a}, 'b':${b}} then print d['a']*d['b'] + ${n}`,
          starter:"# Write code\n",
          hintBudget:14,
          hints:["d = {...}", "print(d['a']*d['b'] + n)"],
          exampleCode:"d={'a':2,'b':3}\nprint(d['a']*d['b']+5)",
          expectedOutput: expected,
          explainKeywords:["dict","key"],
          explainMe:"Access dict values using keys and compute the expression.",
          validate:(_py,out)=> normalizeOutput(out) === expected
        };
      }

      if(type === 2){
        const expected = `OK`;
        return {
          title:`MODERATE ‚Ä¢ Stage ${n}/${MAX_MODERATE_STAGES} ‚Äì Try/Except`,
          story:"Moderate concept: exceptions",
          prompt:`Use try/except so program prints exactly:\n${expected}\n(no crash allowed)`,
          starter:"# Write code\n",
          hintBudget:14,
          hints:["Use try:", "except:", `Print "${expected}" in except`],
          exampleCode:`try:\n int('x')\nexcept:\n print("OK")`,
          expectedOutput: expected,
          explainKeywords:["try","except"],
          explainMe:"Use try/except to prevent crash and print a message.",
          validate:(_py,out)=> normalizeOutput(out) === normalizeOutput(expected)
        };
      }

      const word = `moderate_${n}`.toLowerCase();
      const expected = word.replace(/_/g,"-");
      return {
        title:`MODERATE ‚Ä¢ Stage ${n}/${MAX_MODERATE_STAGES} ‚Äì Strings`,
        story:"Moderate concept: string replace",
        prompt:`s="${word}". Print s.replace("_","-")`,
        starter:"# Write code\n",
        hintBudget:14,
        hints:["Use replace('_','-')", "print(result)"],
        exampleCode:`s="a_b"\nprint(s.replace("_","-"))`,
        expectedOutput: expected,
        explainKeywords:["replace","string"],
        explainMe:"replace changes one character to another in a string.",
        validate:(_py,out)=> normalizeOutput(out) === normalizeOutput(expected)
      };
    }

    function makeProStage(n){
      const type = (n - 1) % 3;

      if(type === 0){
        const expected = `SQUARES`;
        return {
          title:`PRO ‚Ä¢ Stage ${n}/${MAX_PRO_STAGES} ‚Äì Comprehension`,
          story:"Pro concept: list comprehension",
          prompt:`Create squares=[i*i for i in range(1,6)] then print squares and then print "${expected}"`,
          starter:"# Write code\n",
          hintBudget:20,
          hints:["squares=[i*i for i in range(1,6)]", "print(squares)", `print("${expected}")`],
          exampleCode:`s=[i*i for i in range(1,4)]\nprint(s)\nprint("SQUARES")`,
          expectedOutput: `[1, 4, 9, 16, 25] ${expected}`,
          explainKeywords:["comprehension","range","i*i"],
          explainMe:"Comprehension builds a list quickly using a loop.",
          validate:(_py,out)=> normalizeOutput(out) === normalizeOutput(`[1, 4, 9, 16, 25] ${expected}`)
        };
      }

      if(type === 1){
        const m = 5 + (n % 4);
        let fac=1; for(let i=1;i<=m;i++) fac*=i;
        const expected = String(fac + n);
        return {
          title:`PRO ‚Ä¢ Stage ${n}/${MAX_PRO_STAGES} ‚Äì Factorial`,
          story:"Pro concept: loops + functions",
          prompt:`Write function fact(x) factorial. Print fact(${m}) + ${n}`,
          starter:"# Write code\n",
          hintBudget:20,
          hints:["fact multiplies 1..x", "return result", "print(fact(m)+n)"],
          exampleCode:`def fact(x):\n r=1\n for i in range(1,x+1):\n  r*=i\n return r\nprint(fact(5)+3)`,
          expectedOutput: expected,
          explainKeywords:["def","return","*="],
          explainMe:"Factorial multiplies all numbers from 1..x.",
          validate:(_py,out)=> normalizeOutput(out) === expected
        };
      }

      const expected = `SAFE`;
      return {
        title:`PRO ‚Ä¢ Stage ${n}/${MAX_PRO_STAGES} ‚Äì Defensive Code`,
        story:"Pro concept: safe error handling",
        prompt:`Use try/except so it prints: ${expected}`,
        starter:"# Write code\n",
        hintBudget:20,
        hints:["try:", "except:", `print("${expected}")`],
        exampleCode:`try:\n 10/0\nexcept:\n print("SAFE")`,
        expectedOutput: expected,
        explainKeywords:["try","except"],
        explainMe:"try/except prevents crash and handles errors.",
        validate:(_py,out)=> normalizeOutput(out) === normalizeOutput(expected)
      };
    }

    // ---------- Endless Mode ----------
    function makeEndlessStage(stageNum){
      const picker = (stageNum * 31) % 10;
      if(picker <= 4) return makeBeginnerStage((stageNum % 999999) + 1);
      if(picker <= 7) return makeModerateStage((stageNum % 999999) + 1);
      return makeProStage((stageNum % 999999) + 1);
    }

    // ---------- Stage router ----------
    function makeStage(n){
      const tr = state.track || "learn";
      if(tr === "learn") return makeLearnStage(n);

      if(tr === "beginner"){
        if(n > MAX_BEGINNER_STAGES) return makeBeginnerStage(MAX_BEGINNER_STAGES);
        return makeBeginnerStage(n);
      }

      if(tr === "moderate"){
        if(n > MAX_MODERATE_STAGES) return makeModerateStage(MAX_MODERATE_STAGES);
        return makeModerateStage(n);
      }

      if(tr === "pro"){
        if(state.endlessUnlocked && n > MAX_PRO_STAGES){
          return makeEndlessStage(n - MAX_PRO_STAGES);
        }
        if(n > MAX_PRO_STAGES) return makeProStage(MAX_PRO_STAGES);
        return makeProStage(n);
      }

      return makeBeginnerStage(n);
    }

    // ---------- Hint budgets per stage ----------
    function getHintsLeftForStage(stageNum, budget){
      const prog = getProgress();
      const key = String(stageNum);
      if(prog.perLevelHintsLeft[key] === undefined) prog.perLevelHintsLeft[key] = budget;
      return prog.perLevelHintsLeft[key];
    }
    function setHintsLeftForStage(stageNum, value){
      const prog = getProgress();
      prog.perLevelHintsLeft[String(stageNum)] = value;
    }

    // ---------- Runtime variables ----------
    let currentStage = null;
    let hintsLeft = 0;
    let shownHints = 0;
    let hintsUsedThisStage = 0;
    let stageStartTime = 0;

    let pendingNextStage = null;
    let pendingSolvedXp = 0;
    let pendingTransition = null;

    // ---------- Lesson-only UI ----------
    function setLessonModeUI(isLesson){
      continueLessonBtn.style.display = isLesson ? "inline-block" : "none";
      hintBtn.style.display = isLesson ? "none" : "inline-block";
      exBtn.style.display = isLesson ? "none" : "inline-block";
      runBtn.style.display = isLesson ? "none" : "inline-block";
      submitBtn.style.display = isLesson ? "none" : "inline-block";
      useHintPU.style.display = isLesson ? "none" : "inline-block";
      useRevealPU.style.display = isLesson ? "none" : "inline-block";
      useSkipPU.style.display = isLesson ? "none" : "inline-block";

      codeEl.disabled = isLesson;
      if(isLesson) codeEl.value = "# Lesson screen (no code needed)\n";
    }

    function loadStage(stageNum){
      currentStage = makeStage(stageNum);
      levelTitle.textContent = currentStage.title;
      storyEl.textContent = currentStage.story;
      promptEl.textContent = currentStage.prompt;

      outputEl.textContent = "";
      hintsEl.innerHTML = "";

      shownHints = 0;
      hintsUsedThisStage = 0;
      stageStartTime = Date.now();

      const isLesson = !!currentStage.lessonOnly;
      setLessonModeUI(isLesson);

      if(!isLesson){
        codeEl.disabled = false;
        codeEl.value = currentStage.starter;
      }

      hintsLeft = getHintsLeftForStage(stageNum, currentStage.hintBudget || 0);
      hintBtn.textContent = `Hint (${hintsLeft} left)`;
      exBtn.style.display = "none";

      updateTopStats();
      setWelcome();
    }

    // Continue lesson
    continueLessonBtn.onclick = async () => {
      if(!currentStage?.lessonOnly) return;
      const prog = getProgress();
      prog.currentLevel = (prog.currentLevel || 1) + 1;
      showToast("‚û°Ô∏è Next", "Now solve Question 1!");
      await saveUserProfile().catch(()=>{});
      loadStage(prog.currentLevel);
      updateTopStats();
    };

    // Powerups
    useHintPU.onclick = async () => {
      if(!(state.powerUps?.hint > 0)) return;
      if(currentStage?.lessonOnly) return;
      state.powerUps.hint -= 1;
      hintsLeft += 1;
      hintBtn.textContent = `Hint (${hintsLeft} left)`;
      showToast("‚ö° +Hint used!", "You gained +1 hint for this stage.");
      updateTopStats();
      await saveUserProfile().catch(()=>{});
    };

    useRevealPU.onclick = async () => {
      if(!(state.powerUps?.reveal > 0)) return;
      if(currentStage?.lessonOnly) return;
      state.powerUps.reveal -= 1;
      const expected = currentStage.expectedOutput ?? "(unknown)";
      outputEl.textContent = `üëÅÔ∏è REVEAL\n\nExpected Output:\n${expected}\n\nExtra Tip:\nMatch the mission exactly.`;
      showToast("üëÅÔ∏è Reveal used!", "Expected output shown in Output box.");
      updateTopStats();
      await saveUserProfile().catch(()=>{});
    };

    useSkipPU.onclick = async () => {
      if(!(state.powerUps?.skip > 0)) return;
      const ok = confirm("Use SKIP token? This will skip this stage (NOT counted as solved).");
      if(!ok) return;

      state.powerUps.skip -= 1;
      const prog = getProgress();
      const cur = prog.currentLevel || 1;

      state.skippedLevels = state.skippedLevels || [];
      if(!state.skippedLevels.includes(cur)) state.skippedLevels.push(cur);

      prog.currentLevel = cur + 1;
      showToast("‚è≠Ô∏è Skipped!", "Moved to next stage.");
      await saveUserProfile().catch(()=>{});
      loadStage(prog.currentLevel);
      updateTopStats();
    };

    async function buyPowerUp(kind){
      const cost = COSTS[kind];
      if(state.xp < cost){
        showToast("‚ùå Not enough XP", `Need ${cost} XP to buy this.`);
        return;
      }
      state.xp -= cost;
      state.powerUps[kind] = (state.powerUps[kind] || 0) + 1;
      showToast("‚úÖ Purchased!", `You bought 1 ${kind.toUpperCase()} token.`);
      grantMilestoneRewards();
      updateTopStats();
      updateProfile();
      await saveUserProfile().catch(()=>{});
      await refreshChampionStatus().catch(()=>{});
    }
    buyHint.onclick = () => buyPowerUp("hint");
    buyReveal.onclick = () => buyPowerUp("reveal");
    buySkip.onclick = () => buyPowerUp("skip");

    // Hints + EX
    hintBtn.onclick = async () => {
      const L = currentStage;
      if(!L || L.lessonOnly) return;
      if(hintsLeft <= 0) return;

      hintsLeft--;
      const cur = getProgress().currentLevel || 1;
      setHintsLeftForStage(cur, hintsLeft);

      state.hintsUsedTotal += 1;
      hintsUsedThisStage += 1;

      hintBtn.textContent = `Hint (${hintsLeft} left)`;

      const li = document.createElement("li");
      li.textContent = L.hints[shownHints] || "Try breaking the problem into smaller steps.";
      hintsEl.appendChild(li);
      shownHints++;

      if(hintsLeft === 0){
        exBtn.style.display = "inline-block";
        showToast("üìò EX Code unlocked", "You used all hints.\nEX Code is now available.");
      }

      updateTopStats();
      await saveUserProfile().catch(()=>{});
    };

    exBtn.onclick = () => {
      const L = currentStage;
      if(!L || L.lessonOnly) return;
      outputEl.textContent =
        "üìò EX CODE (similar example, NOT the answer):\n\n" +
        (L.exampleCode || "No example available") +
        "\n\n‚ö†Ô∏è Modify this code to solve the mission.";
    };

    // Run
    runBtn.onclick = async () => {
      if(currentStage?.lessonOnly) return;
      const py = await ensurePyodide();
      setBusy(true);
      try{
        resetStdout(py);
        py.runPython(codeEl.value);
        const out = getStdout(py);
        outputEl.textContent = out || "(no output)";
      }catch(e){
        outputEl.textContent = friendlyError(e);
      } finally { setBusy(false); }
    };

    // Explanation bonus
    function scoreExplanation(text, keywords){
      const t = (text || "").toLowerCase();
      let hits = 0;
      for(const k of (keywords || [])){
        if(t.includes(String(k).toLowerCase())) hits++;
      }
      return hits;
    }
    function bonusFromExplanation(hits){
      if(hits >= 4) return 8;
      if(hits >= 3) return 6;
      if(hits >= 2) return 4;
      return 0;
    }

    btnExplainMe.onclick = () => {
      explainMeBox.style.display = "block";
      explainMeText.textContent = currentStage?.explainMe || "Try describing what each line does.";
    };

    async function afterSolveAdvance(){
      const prog = getProgress();

      if(pendingTransition?.type === "toModerate"){
        showTransitionModal({
          title: "‚úÖ Beginner Completed!",
          msg: "You finished Beginner track üéâ\nClick below to start Moderate.",
          buttonText: "Start Moderate",
          onConfirm: async () => {
            state.track = "moderate";
            if(!state.progressByTrack.moderate) state.progressByTrack.moderate = emptyProgress();
            state.progressByTrack.moderate.currentLevel = 1;
            await saveUserProfile().catch(()=>{});
            loadStage(1);
            showPlay();
            showToast("üî• Moderate Started!", "Good luck!");
          }
        });
        pendingTransition = null;
        return;
      }

      if(pendingTransition?.type === "toPro"){
        showTransitionModal({
          title: "‚úÖ Moderate Completed!",
          msg: "You finished Moderate track üéâ\nClick below to start Professional.",
          buttonText: "Start Professional",
          onConfirm: async () => {
            state.track = "pro";
            if(!state.progressByTrack.pro) state.progressByTrack.pro = emptyProgress();
            state.progressByTrack.pro.currentLevel = 1;
            await saveUserProfile().catch(()=>{});
            loadStage(1);
            showPlay();
            showToast("‚ö° Pro Started!", "Now it's serious üòà");
          }
        });
        pendingTransition = null;
        return;
      }

      if(pendingTransition?.type === "toEndless"){
        showTransitionModal({
          title: "üèÜ Professional Completed!",
          msg: "You finished Pro track ‚úÖ\nEndless Mode is now unlocked: infinite mixed questions üî•",
          buttonText: "Start Endless Mode",
          onConfirm: async () => {
            state.endlessUnlocked = true;
            state.track = "pro";
            if(!state.progressByTrack.pro) state.progressByTrack.pro = emptyProgress();
            state.progressByTrack.pro.currentLevel = MAX_PRO_STAGES + 1;
            await saveUserProfile().catch(()=>{});
            loadStage(state.progressByTrack.pro.currentLevel);
            showPlay();
            showToast("‚àû Endless Mode!", "Infinite questions unlocked!");
          }
        });
        pendingTransition = null;
        return;
      }

      prog.currentLevel = pendingNextStage;
      pendingNextStage = null;

      grantMilestoneRewards();
      checkBadges();
      updateTopStats();
      await saveUserProfile().catch(()=>{});
      loadStage(prog.currentLevel);
      await refreshChampionStatus().catch(()=>{});
    }

    btnSkipExplain.onclick = async () => {
      hideExplainModal();
      state.xp += pendingSolvedXp;
      pendingSolvedXp = 0;
      await afterSolveAdvance();
    };

    btnSubmitExplain.onclick = async () => {
      const hits = scoreExplanation(explainInput.value, currentStage?.explainKeywords || []);
      const bonus = bonusFromExplanation(hits);
      if(bonus <= 0){
        explainStatus.textContent = "‚ùå Not enough explanation keywords. Tip: click ‚ÄúExplain me‚Äù then write in your own words.";
        return;
      }
      explainStatus.textContent = `‚úÖ Nice! Bonus +${bonus} XP earned.`;
      showToast("üß† Explanation Bonus!", `You earned +${bonus} XP for explaining your code!`);

      hideExplainModal();
      state.xp += (pendingSolvedXp + bonus);
      pendingSolvedXp = 0;

      await afterSolveAdvance();
    };

    // Submit
    submitBtn.onclick = async () => {
      if(!state.username){ showLoginModal(); return; }
      if(currentStage?.lessonOnly){ return; }

      const py = await ensurePyodide();
      setBusy(true);
      try{
        resetStdout(py);
        py.runPython(codeEl.value);

        const rawOut = getStdout(py);
        const passed = currentStage.validate(py, rawOut);

        if(passed){
          const prog = getProgress();
          const cur = prog.currentLevel || 1;
          if(!state.solvedLevels.includes(cur)) state.solvedLevels.push(cur);

          const bonusHints = Math.max(0, hintsLeft);
          const baseXp = 10 + bonusHints;

          const solveMs = Date.now() - stageStartTime;
          state.lastSolveMs = solveMs;
          adjustDifficulty({ solveMs, hintsUsedThisStage });

          pendingTransition = null;

          if(state.track === "beginner" && cur >= MAX_BEGINNER_STAGES){
            pendingTransition = { type: "toModerate" };
            pendingNextStage = null;
          } else if(state.track === "moderate" && cur >= MAX_MODERATE_STAGES){
            pendingTransition = { type: "toPro" };
            pendingNextStage = null;
          } else if(state.track === "pro" && !state.endlessUnlocked && cur >= MAX_PRO_STAGES){
            pendingTransition = { type: "toEndless" };
            pendingNextStage = null;
          } else {
            pendingNextStage = cur + 1;
          }

          pendingSolvedXp = baseXp;
          await saveUserProfile().catch(()=>{});
          showExplainModal(codeEl.value);
        } else {
          outputEl.textContent =
            `‚ùå Not correct yet.\n\nYour Output:\n${normalizeOutput(rawOut) || "(no output)"}\n\nTip: Try again.`;
        }
      }catch(e){
        outputEl.textContent = "‚ùå Error:\n" + friendlyError(e);
      } finally { setBusy(false); }
    };

    // Switch mode
    applyTrack.onclick = async () => {
      if(!state.username){
        showToast("‚ùå Not logged in", "Please login first.");
        return;
      }
      const newTrack = (switchTrack.value || "learn").trim();
      if(newTrack === state.track){
        switchMsg.textContent = "You are already on this mode ‚úÖ";
        return;
      }

      state.track = newTrack;
      if(!state.progressByTrack[newTrack]) state.progressByTrack[newTrack] = emptyProgress();
      if(state.track === "learn") state.skill = 1;

      switchMsg.textContent = `‚úÖ Switched to ${trackLabel(newTrack)}.`;
      setWelcome();
      updateTopStats();
      updateProfile();

      await saveUserProfile().catch(()=>{});
      await refreshChampionStatus().catch(()=>{});

      loadStage(getProgress().currentLevel || 1);
      showPlay();
      showToast("‚úÖ Mode switched!", `Now playing: ${trackLabel(newTrack)}`);
    };

    resetThisTrack.onclick = async () => {
      if(!state.username) return;
      const ok = confirm(`Reset ${trackLabel(state.track)} progress to stage 1?`);
      if(!ok) return;

      state.progressByTrack[state.track] = emptyProgress();
      switchMsg.textContent = `üîÑ Reset done for ${trackLabel(state.track)}.`;
      await saveUserProfile().catch(()=>{});
      loadStage(1);
      showPlay();
    };

    // Nav buttons
    navPlay.onclick = showPlay;
    navProfile.onclick = () => showProfile();
    navLeaderboard.onclick = () => showLeaderboard();

    // Startup
    async function boot(){
      await ensureAnonAuth();

      try{
        await incrementGlobalVisitOncePerTab();
        await readGlobalVisits();
      } catch {
        globalVisitsEl.textContent = "offline";
      }

      if(sessionUser){
        try{
          const prof = await loadUserProfile(sessionUser);
          if(prof){
            state = migrateProfileToNewShape(prof, sessionUser);
            setWelcome();
            updateTopStats();
            loadStage(getProgress().currentLevel || 1);
            showPlay();
            showToast("‚úÖ Welcome back!", `Logged in as ${state.username}`);
            await refreshChampionStatus();
            return;
          }
        } catch {}
        localStorage.removeItem(SESSION_KEY);
        sessionUser = "";
      }
      showLoginModal();
    }

    showPlay();
    boot();

    setInterval(async () => {
      if(!state.username) return;
      try{ await readGlobalVisits(); } catch {}
      try{ await refreshChampionStatus(); } catch {}
    }, 12000);
  </script>
</body>
</html>
