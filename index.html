<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PyQuest ‚Äì Learn Python</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0f172a; color:white; padding:20px; }
    h1 { margin: 0 0 10px; }
    .card { background:#111827; border:1px solid #334155; border-radius:14px; padding:14px; }
    .prompt { margin-top:6px; padding:10px; background:#020617; border-radius:10px; }
    textarea { width:100%; margin-top:12px; background:black; color:#22c55e; border-radius:10px; padding:10px; border:1px solid #334155; }
    button { padding:10px 12px; border-radius:10px; border:0; cursor:pointer; background:#e5e7eb; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .primary { background:#38bdf8; }
    .row { display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap; }
    .right { display:flex; flex-wrap:wrap; justify-content:flex-end; gap:8px; }
    .split { display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px; }
    pre { background:black; border:1px solid #334155; border-radius:10px; padding:10px; min-height:120px; white-space:pre-wrap; }
    .label { font-size:12px; opacity:.7; margin-bottom:6px; }
    ul { margin:0; padding-left:18px; }
    .small { opacity: .85; margin: 6px 0 14px; }
    @media (max-width: 900px) { .split { grid-template-columns: 1fr; } }
  </style>
</head>

<body>
  <h1>üêç PyQuest ‚Äì Learn Python</h1>
  <p class="small" id="story"></p>

  <div class="card">
    <div class="row">
      <div>
        <b id="levelTitle"></b>
        <div id="prompt" class="prompt"></div>
      </div>
      <div class="right">
        <button id="hintBtn">Hint</button>
        <button id="exBtn">EX Code</button>
        <button id="runBtn">Run</button>
        <button id="submitBtn" class="primary">Submit</button>
      </div>
    </div>

    <textarea id="code" rows="8"></textarea>

    <div class="split">
      <div>
        <div class="label">Output</div>
        <pre id="output"></pre>
      </div>
      <div>
        <div class="label">Hints</div>
        <ul id="hints"></ul>
      </div>
    </div>
  </div>

  <!-- Python in the browser -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>

  <script>
    window.addEventListener("DOMContentLoaded", () => {

      // ---------------- LEVELS (add more levels here) ----------------
      const LEVELS = [
        {
          title: "LEVEL 1 ‚Äì Vault Boot",
          story: "You are locked inside a space vault. The console wants a boot message.",
          prompt: "Print exactly: ACCESS GRANTED",
          starter: "# Write your code here\n",
          hintBudget: 10,
          hints: [
            "Use print()",
            "Text must be in quotes",
            "Example: print('HELLO')",
            "No extra spaces",
            "Exactly: ACCESS GRANTED"
          ],
          // EXAMPLE (NOT the answer)
          exampleCode: "print(\"WELCOME USER\")",
          expectedOutput: "ACCESS GRANTED"
        },
        {
          title: "LEVEL 2 ‚Äì Secret Code Variable",
          story: "Nice! Now store the passcode in a variable and print it.",
          prompt: "Create variable named code = 'OPEN' and print it",
          starter: "# code = 'OPEN'\n# print(code)\n",
          hintBudget: 10,
          hints: [
            "Variable name must be: code",
            "Use: code = 'OPEN'",
            "Then print(code)",
            "Use quotes around OPEN",
            "Only one print is enough"
          ],
          exampleCode: "msg = \"HELLO\"\nprint(msg)",
          expectedOutput: "OPEN",
          extraCheck: (py) => {
            return Boolean(py.runPython("('code' in globals()) and (code == 'OPEN')"));
          }
        }
      ];

      // ---------------- State ----------------
      let levelIndex = 0;
      let hintsLeft = 0;
      let shownHints = 0;
      let pyodide = null;

      // ---------------- Elements ----------------
      const elStory = document.getElementById("story");
      const elLevelTitle = document.getElementById("levelTitle");
      const elPrompt = document.getElementById("prompt");
      const elCode = document.getElementById("code");
      const elOutput = document.getElementById("output");
      const elHints = document.getElementById("hints");

      const hintBtn = document.getElementById("hintBtn");
      const exBtn = document.getElementById("exBtn");
      const runBtn = document.getElementById("runBtn");
      const submitBtn = document.getElementById("submitBtn");

      // ---------------- Helpers ----------------
      function setBusy(isBusy) {
        runBtn.disabled = isBusy;
        submitBtn.disabled = isBusy;
        hintBtn.disabled = isBusy;
        exBtn.disabled = isBusy;
      }

      function resetStdout(py) {
        py.runPython("import sys\nfrom io import StringIO\nsys.stdout = StringIO()\n");
      }

      function getStdout(py) {
        return String(py.runPython("sys.stdout.getvalue()"));
      }

      function loadLevel(i) {
        const L = LEVELS[i];

        elLevelTitle.textContent = L.title;
        elStory.textContent = L.story;
        elPrompt.textContent = L.prompt;

        elCode.value = L.starter;
        elOutput.textContent = "";
        elHints.innerHTML = "";

        shownHints = 0;
        hintsLeft = L.hintBudget;

        hintBtn.textContent = `Hint (${hintsLeft} left)`;

        // EX Code shows only after hints become 0 (fair rule)
        exBtn.style.display = "none";
      }

      async function ensurePyodide() {
        if (pyodide) return pyodide;
        setBusy(true);
        elOutput.textContent = "Loading Python engine...";
        try {
          pyodide = await loadPyodide();
          elOutput.textContent = "Ready ‚úÖ";
          return pyodide;
        } finally {
          setBusy(false);
        }
      }

      function friendlyError(e) {
        const msg = String(e?.message || e);
        if (msg.includes("SyntaxError")) return msg + "\nTip: Check quotes/brackets/colons/indentation.";
        if (msg.includes("NameError")) return msg + "\nTip: Define the variable before using it.";
        if (msg.includes("IndentationError")) return msg + "\nTip: Python indentation matters.";
        return msg;
      }

      // ---------------- Buttons ----------------
      runBtn.onclick = async () => {
        const py = await ensurePyodide();
        setBusy(true);
        try {
          resetStdout(py);
          py.runPython(elCode.value);
          elOutput.textContent = getStdout(py) || "(no output)";
        } catch (e) {
          elOutput.textContent = friendlyError(e);
        } finally {
          setBusy(false);
        }
      };

      submitBtn.onclick = async () => {
        const py = await ensurePyodide();
        const L = LEVELS[levelIndex];

        setBusy(true);
        try {
          resetStdout(py);
          py.runPython(elCode.value);

          const out = getStdout(py).trim();
          const expected = String(L.expectedOutput).trim();

          let pass = (out === expected);

          // Optional extra checks per level (like variable existence)
          if (pass && typeof L.extraCheck === "function") {
            pass = L.extraCheck(py);
          }

          if (pass) {
            alert("‚úÖ Successfully completed " + L.title + "!");
            levelIndex++;

            if (levelIndex >= LEVELS.length) {
              elOutput.textContent =
                "üéâ You finished all levels!\n\n(Add more levels inside the LEVELS array.)";
              return;
            }

            loadLevel(levelIndex);
          } else {
            elOutput.textContent =
              "‚ùå Not correct yet.\n\nExpected: " + expected +
              "\nGot: " + (out || "(no output)") +
              "\n\nTip: Avoid extra spaces/new lines.";
          }
        } catch (e) {
          elOutput.textContent = "‚ùå Error:\n" + friendlyError(e);
        } finally {
          setBusy(false);
        }
      };

      hintBtn.onclick = () => {
        const L = LEVELS[levelIndex];
        if (hintsLeft <= 0) return;

        hintsLeft--;
        hintBtn.textContent = `Hint (${hintsLeft} left)`;

        const li = document.createElement("li");
        li.textContent = L.hints[shownHints] || "No more hint messages, but you still have hint credits.";
        elHints.appendChild(li);
        shownHints++;

        // When hints reach 0, show EX Code button
        if (hintsLeft === 0) {
          exBtn.style.display = "inline-block";
        }
      };

      exBtn.onclick = () => {
        const L = LEVELS[levelIndex];
        if (!L.exampleCode) {
          elOutput.textContent = "No example available for this level.";
          return;
        }

        elOutput.textContent =
          "üìò EX CODE (similar example, NOT the answer):\n\n" +
          L.exampleCode +
          "\n\n‚ö†Ô∏è Now modify this code to solve the mission.";
      };

      // Start at Level 1
      loadLevel(levelIndex);
    });
  </script>
</body>
</html>
