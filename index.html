<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PyQuest ‚Äì Learn Python</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --panel2:#020617; --border:#334155;
      --txt:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; --good:#22c55e; --bad:#fb7185;
    }
    body{ margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--txt); }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    h1{ margin:0; font-size:26px; }
    .nav{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{ padding:10px 12px; border-radius:10px; border:0; cursor:pointer; background:#e5e7eb; color:#111; }
    .btn.primary{ background:var(--accent); }
    .btn.ghost{ background:transparent; border:1px solid var(--border); color:var(--txt); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px; margin-top:12px; }
    .story{ color:var(--muted); margin:6px 0 0; }
    .prompt{ margin-top:10px; padding:10px; background:var(--panel2); border-radius:10px; border:1px solid var(--border); }
    .row{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap; }
    .right{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    textarea{ width:100%; margin-top:12px; background:black; color:var(--good); border-radius:10px; padding:10px; border:1px solid var(--border); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .split{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px; }
    .label{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    pre{ background:black; border:1px solid var(--border); border-radius:10px; padding:10px; min-height:120px; white-space:pre-wrap; margin:0; }
    ul{ margin:0; padding-left:18px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); color:var(--txt); background:rgba(255,255,255,0.03); }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .badge{ display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,0.03); }
    .badge small{ color:var(--muted); }
    .toast{
      position: fixed; right: 16px; top: 16px; z-index: 9999;
      min-width: 260px; max-width: 360px;
      background: #0b1220; border:1px solid var(--border); border-radius:14px; padding:12px;
      box-shadow: 0 20px 60px rgba(0,0,0,.4);
      display:none;
    }
    .toast .tTitle{ font-weight:700; }
    .toast .tMsg{ color:var(--muted); margin-top:6px; }
    .modalBackdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.6);
      display:none; align-items:center; justify-content:center; z-index:9998;
    }
    .modal{
      width:min(520px, 92vw);
      background:#0b1220; border:1px solid var(--border); border-radius:16px; padding:14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
    }
    input{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:#020617; color:var(--txt); outline:none;
    }
    .help{ color:var(--muted); font-size:13px; margin-top:6px; }
    @media (max-width: 900px){ .split, .grid{ grid-template-columns: 1fr; } }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="font-size:28px;">üêç</div>
        <div>
          <h1>PyQuest ‚Äì Learn Python</h1>
          <div style="color:var(--muted);font-size:13px;" id="welcomeLine"></div>
        </div>
      </div>

      <div class="nav">
        <button class="btn ghost" id="navPlay">Play</button>
        <button class="btn ghost" id="navProfile">Profile</button>
        <button class="btn ghost" id="navReset">Reset</button>
        <button class="btn ghost" id="devBtn" style="display:none;">Dev Ctrl</button>
      </div>
    </div>

    <!-- PLAY -->
    <div id="playView" class="card">
      <div class="row">
        <div>
          <div class="pill">üìç <b id="levelTitle">Loading...</b></div>
          <div class="story" id="story"></div>
        </div>
        <div class="right">
          <span class="pill">‚≠ê XP: <b id="xp">0</b></span>
          <span class="pill">üèÖ Badges: <b id="badgeCount">0</b></span>
          <span class="pill">‚úÖ Solved: <b id="solvedCount">0</b></span>
        </div>
      </div>

      <div class="prompt" id="prompt"></div>

      <div class="row" style="margin-top:10px;">
        <div class="right" style="margin-left:auto;">
          <button class="btn" id="hintBtn">Hint</button>
          <button class="btn" id="exBtn">EX Code</button>
          <button class="btn" id="runBtn">Run</button>
          <button class="btn primary" id="submitBtn">Submit</button>
        </div>
      </div>

      <textarea id="code" rows="9"></textarea>

      <div class="split">
        <div>
          <div class="label">Output</div>
          <pre id="output"></pre>
        </div>
        <div>
          <div class="label">Hints</div>
          <ul id="hints"></ul>
        </div>
      </div>
    </div>

    <!-- PROFILE -->
    <div id="profileView" class="card" style="display:none;">
      <div class="row">
        <div>
          <div class="pill">üë§ <b id="profileName">Your Profile</b></div>
          <div class="story">Saved in this browser (no login needed).</div>
        </div>
        <div class="right">
          <button class="btn ghost" id="backToPlay">Back to Play</button>
        </div>
      </div>

      <div class="grid" style="margin-top:12px;">
        <div class="card" style="margin:0;">
          <b>Stats</b>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <span class="pill">‚úÖ Levels solved: <b id="pSolved">0</b></span>
            <span class="pill">‚≠ê XP: <b id="pXp">0</b></span>
            <span class="pill">üí° Hints used: <b id="pHints">0</b></span>
            <span class="pill">üî• Current level: <b id="pCurrent">1</b></span>
          </div>
        </div>

        <div class="card" style="margin:0;">
          <b>Recent solved levels</b>
          <div class="story">Last 10 solved levels</div>
          <div id="recentLevels" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;"></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <b>Achievements / Badges</b>
        <div class="story">Popups appear when you unlock these.</div>
        <div id="badgeList" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;"></div>
      </div>
    </div>

    <!-- DEV CTRL (only when ?dev=1 + PIN) -->
    <div id="devView" class="card" style="display:none;">
      <div class="row">
        <div>
          <div class="pill">üõ†Ô∏è <b>Dev Control</b></div>
          <div class="story">
            Static-site limitation: These stats are only from your browser unless you add a backend/analytics.
          </div>
        </div>
        <div class="right">
          <button class="btn ghost" id="devClose">Close</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <b>Visits (THIS browser only)</b>
        <div class="story">Counts page opens in your device/browser.</div>
        <div style="margin-top:10px;">
          <span class="pill">üëÄ Visits: <b id="devVisits">0</b></span>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <b>Search profiles (THIS browser only)</b>
        <div class="story">This demo searches profiles saved in your browser.</div>

        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <input id="devSearch" placeholder="Type a name..." style="flex:1; min-width:220px;">
          <button class="btn primary" id="devSearchBtn">Search</button>
        </div>

        <pre id="devResult" style="margin-top:10px; min-height:80px;"></pre>
      </div>
    </div>

  </div>

  <!-- Name Modal -->
  <div class="modalBackdrop" id="nameBackdrop">
    <div class="modal">
      <div style="font-size:18px; font-weight:700;">Welcome to PyQuest üëã</div>
      <div class="help">Enter your name to start. This name will show in your profile.</div>
      <div style="margin-top:10px;">
        <input id="nameInput" maxlength="20" placeholder="Your name (e.g., Rahul)">
        <div class="help">Tip: Use your real name for school practical.</div>
      </div>
      <div class="right" style="margin-top:12px;">
        <button class="btn primary" id="saveNameBtn">Start</button>
      </div>
    </div>
  </div>

  <!-- Achievement Popup -->
  <div class="toast" id="toast">
    <div class="tTitle" id="toastTitle">üèÜ Achievement Unlocked!</div>
    <div class="tMsg" id="toastMsg"></div>
  </div>

  <!-- Python engine -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>

  <script>
  window.addEventListener("DOMContentLoaded", () => {

    // -------------------- IMPORTANT LIMITATION --------------------
    // GitHub Pages has no server. So:
    // - Name/profile is saved per visitor browser (localStorage).
    // - "Visits" and "Search profiles" below are demo for YOUR browser only.
    // For real visitors + real search across all users, you need Firebase/Supabase.

    // -------------------- DEV SETTINGS --------------------
    const DEV_PIN = "1234"; // change this to your secret
    const urlParams = new URLSearchParams(location.search);
    const devRequested = (urlParams.get("dev") === "1"); // show Dev Ctrl only when site opened with ?dev=1

    // -------------------- Storage --------------------
    const STORE_KEY = "pyquest_v2_progress";
    const VISITS_KEY = "pyquest_v2_visits";
    const LOCAL_PROFILES_KEY = "pyquest_v2_profiles"; // demo only

    const defaultState = () => ({
      name: "",
      xp: 0,
      currentLevel: 1,
      solvedLevels: [],
      badges: [],
      hintsUsedTotal: 0,
      perLevelHintsLeft: {},
    });

    function loadState(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        return raw ? JSON.parse(raw) : defaultState();
      }catch{
        return defaultState();
      }
    }
    function saveState(){
      localStorage.setItem(STORE_KEY, JSON.stringify(state));
    }

    let state = loadState();

    // Count visits (THIS browser only)
    const visits = (Number(localStorage.getItem(VISITS_KEY) || "0") + 1);
    localStorage.setItem(VISITS_KEY, String(visits));

    // Save local profiles list (demo only)
    function saveLocalProfile(){
      try{
        const raw = localStorage.getItem(LOCAL_PROFILES_KEY);
        const list = raw ? JSON.parse(raw) : [];
        const existing = list.find(p => p.name?.toLowerCase() === state.name.toLowerCase());
        const profile = {
          name: state.name,
          xp: state.xp,
          solved: state.solvedLevels.length,
          badges: state.badges.length,
          currentLevel: state.currentLevel
        };
        if(existing){
          Object.assign(existing, profile);
        } else {
          list.push(profile);
        }
        localStorage.setItem(LOCAL_PROFILES_KEY, JSON.stringify(list));
      } catch {}
    }

    // -------------------- UI Elements --------------------
    const playView = document.getElementById("playView");
    const profileView = document.getElementById("profileView");
    const devView = document.getElementById("devView");

    const navPlay = document.getElementById("navPlay");
    const navProfile = document.getElementById("navProfile");
    const navReset = document.getElementById("navReset");
    const backToPlay = document.getElementById("backToPlay");

    const devBtn = document.getElementById("devBtn");
    const devClose = document.getElementById("devClose");
    const devVisits = document.getElementById("devVisits");
    const devSearch = document.getElementById("devSearch");
    const devSearchBtn = document.getElementById("devSearchBtn");
    const devResult = document.getElementById("devResult");

    const welcomeLine = document.getElementById("welcomeLine");
    const profileName = document.getElementById("profileName");

    const levelTitle = document.getElementById("levelTitle");
    const storyEl = document.getElementById("story");
    const promptEl = document.getElementById("prompt");
    const codeEl = document.getElementById("code");
    const outputEl = document.getElementById("output");
    const hintsEl = document.getElementById("hints");

    const hintBtn = document.getElementById("hintBtn");
    const exBtn = document.getElementById("exBtn");
    const runBtn = document.getElementById("runBtn");
    const submitBtn = document.getElementById("submitBtn");

    const xpEl = document.getElementById("xp");
    const badgeCountEl = document.getElementById("badgeCount");
    const solvedCountEl = document.getElementById("solvedCount");

    // Profile stats
    const pSolved = document.getElementById("pSolved");
    const pXp = document.getElementById("pXp");
    const pHints = document.getElementById("pHints");
    const pCurrent = document.getElementById("pCurrent");
    const recentLevelsEl = document.getElementById("recentLevels");
    const badgeListEl = document.getElementById("badgeList");

    // Name modal
    const nameBackdrop = document.getElementById("nameBackdrop");
    const nameInput = document.getElementById("nameInput");
    const saveNameBtn = document.getElementById("saveNameBtn");

    // Toast
    const toast = document.getElementById("toast");
    const toastTitle = document.getElementById("toastTitle");
    const toastMsg = document.getElementById("toastMsg");
    let toastTimer = null;

    function showToast(title, msg){
      toastTitle.textContent = title;
      toastMsg.textContent = msg;
      toast.style.display = "block";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => { toast.style.display = "none"; }, 3500);
    }

    function setBusy(b){
      runBtn.disabled = b;
      submitBtn.disabled = b;
      hintBtn.disabled = b;
      exBtn.disabled = b;
    }

    // -------------------- Name flow --------------------
    function setWelcome(){
      const nm = state.name ? state.name : "Student";
      welcomeLine.textContent = `Hi ${nm}! Solve levels and unlock badges.`;
      profileName.textContent = `${nm}'s Profile`;
    }

    function showNameModal(){
      nameBackdrop.style.display = "flex";
      setTimeout(() => nameInput.focus(), 50);
    }
    function hideNameModal(){
      nameBackdrop.style.display = "none";
    }

    saveNameBtn.onclick = () => {
      const nm = (nameInput.value || "").trim();
      if(!nm){
        alert("Please enter your name.");
        return;
      }
      state.name = nm;
      saveState();
      setWelcome();
      saveLocalProfile();
      hideNameModal();
    };

    if(!state.name){
      showNameModal();
    } else {
      setWelcome();
    }

    // -------------------- Pyodide --------------------
    let pyodide = null;

    async function ensurePyodide(){
      if(pyodide) return pyodide;
      setBusy(true);
      outputEl.textContent = "Loading Python engine...";
      try{
        pyodide = await loadPyodide();
        outputEl.textContent = "Ready ‚úÖ";
        return pyodide;
      } finally {
        setBusy(false);
      }
    }

    function resetStdout(py){
      py.runPython("import sys\nfrom io import StringIO\nsys.stdout = StringIO()\n");
    }
    function getStdout(py){
      return String(py.runPython("sys.stdout.getvalue()"));
    }
    function normalizeOutput(s){
      return String(s).replace(/\s+/g, " ").trim();
    }
    function friendlyError(e){
      const msg = String(e?.message || e);
      if(msg.includes("SyntaxError")) return msg + "\nTip: Check quotes/brackets/colons/indentation.";
      if(msg.includes("NameError")) return msg + "\nTip: Define the variable before using it.";
      if(msg.includes("IndentationError")) return msg + "\nTip: Python indentation matters.";
      return msg;
    }

    // -------------------- Infinite Level Generator --------------------
    function makeLevel(n){
      const stage = (n - 1) % 6;
      const storyBase = [
        "You are inside a space vault. Each program unlocks a door.",
        "A robot friend needs your code to move forward.",
        "The lab terminal asks for a correct program to continue.",
        "A spaceship computer requests the next command sequence.",
        "The dungeon gate opens only when Python answers correctly.",
        "A hacker console demands a correct script to proceed."
      ];

      if(stage === 0){
        const msg = (n % 2 === 0) ? "ACCESS GRANTED" : "HELLO PYQUEST";
        return {
          title: `LEVEL ${n} ‚Äì Print Mission`,
          story: storyBase[stage],
          prompt: `Print exactly: ${msg}`,
          starter: "# Use print()\n",
          hintBudget: 10,
          hints: ["Use print()", "Text must be in quotes", "No extra spaces", "Only one print line"],
          exampleCode: `print("WELCOME USER")`,
          validate: (py, out) => normalizeOutput(out) === msg
        };
      }

      if(stage === 1){
        const word = (n % 3 === 0) ? "OPEN" : "START";
        return {
          title: `LEVEL ${n} ‚Äì Variables`,
          story: storyBase[stage],
          prompt: `Create variable named code = "${word}" and print it`,
          starter: "# code = \"...\"\n# print(code)\n",
          hintBudget: 10,
          hints: ["Variable name must be code", "Use quotes", "Then print(code)"],
          exampleCode: `msg = "HELLO"\nprint(msg)`,
          validate: (py, out) => {
            const okVar = Boolean(py.runPython(`('code' in globals()) and (code == '${word}')`));
            return okVar && normalizeOutput(out) === word;
          }
        };
      }

      if(stage === 2){
        const a = (n % 7) + 2;
        const b = (n % 5) + 1;
        const ans = String(a + b);
        return {
          title: `LEVEL ${n} ‚Äì Math`,
          story: storyBase[stage],
          prompt: `Compute ${a} + ${b} and print the result`,
          starter: `# print(${a} + ${b})\n`,
          hintBudget: 10,
          hints: ["Use + operator", "Use print()", "Answer is a number"],
          exampleCode: `x = 3\ny = 4\nprint(x + y)`,
          validate: (py, out) => normalizeOutput(out) === ans
        };
      }

      if(stage === 3){
        const threshold = (n % 4) + 3;
        return {
          title: `LEVEL ${n} ‚Äì If / Else`,
          story: storyBase[stage],
          prompt: `Set x = ${threshold}. If x > 4 print BIG else print SMALL`,
          starter: "# x = ...\n# if ...:\n#   print(...)\n# else:\n#   print(...)\n",
          hintBudget: 12,
          hints: ["Use if/else", "Condition: x > 4", "Print BIG or SMALL exactly", "Indentation matters"],
          exampleCode: `x = 2\nif x > 4:\n  print("BIG")\nelse:\n  print("SMALL")`,
          validate: (py, out) => {
            const expected = (threshold > 4) ? "BIG" : "SMALL";
            const okX = Boolean(py.runPython(`('x' in globals()) and (x == ${threshold})`));
            return okX && normalizeOutput(out) === expected;
          }
        };
      }

      if(stage === 4){
        const k = (n % 5) + 3;
        const expected = Array.from({length:k}, (_,i)=>String(i+1)).join(" ");
        return {
          title: `LEVEL ${n} ‚Äì Loops`,
          story: storyBase[stage],
          prompt: `Print numbers from 1 to ${k} (new line or space OK)`,
          starter: "# for i in range(...):\n#   print(i)\n",
          hintBudget: 14,
          hints: ["Use for loop", "Use range(1, k+1)", "Print i", "Indentation matters"],
          exampleCode: `for i in range(1, 4):\n  print(i)`,
          validate: (py, out) => normalizeOutput(out) === expected
        };
      }

      const val = (n % 6) + 2;
      const expected = String(val * 2);
      return {
        title: `LEVEL ${n} ‚Äì Functions`,
        story: storyBase[5],
        prompt: `Write function double(x) returns x*2. Call with ${val} and print result`,
        starter: "# def double(x):\n#   return ...\n# print(double(...))\n",
        hintBudget: 14,
        hints: ["Define function double", "Return x*2", "Call double(val)", "Print the result"],
        exampleCode: `def add1(x):\n  return x + 1\nprint(add1(5))`,
        validate: (py, out) => {
          const okFn = Boolean(py.runPython(`('double' in globals()) and callable(double)`));
          if(!okFn) return false;
          const okVal = Boolean(py.runPython(`double(${val}) == ${val*2}`));
          return okVal && normalizeOutput(out) === expected;
        }
      };
    }

    // -------------------- Badges --------------------
    const BADGES = [
      { id:"solve_1",  name:"First Step",      rule:(s)=> s.solvedLevels.length >= 1,   desc:"Complete 1 level" },
      { id:"solve_10", name:"Python Rookie",   rule:(s)=> s.solvedLevels.length >= 10,  desc:"Complete 10 levels" },
      { id:"solve_25", name:"Python Builder",  rule:(s)=> s.solvedLevels.length >= 25,  desc:"Complete 25 levels" },
      { id:"solve_50", name:"Python Warrior",  rule:(s)=> s.solvedLevels.length >= 50,  desc:"Complete 50 levels" },
      { id:"solve_100",name:"Python Legend",   rule:(s)=> s.solvedLevels.length >= 100, desc:"Complete 100 levels" }
    ];

    function awardBadgeIfNew(badgeId){
      if(state.badges.includes(badgeId)) return false;
      state.badges.push(badgeId);
      saveState();
      const b = BADGES.find(x=>x.id===badgeId);
      if(b) showToast("üèÜ Achievement Unlocked!", `${b.name} ‚Äî ${b.desc}`);
      return true;
    }

    function checkBadges(){
      for(const b of BADGES){
        if(!state.badges.includes(b.id) && b.rule(state)){
          awardBadgeIfNew(b.id);
        }
      }
      saveState();
    }

    // -------------------- Level / Hints --------------------
    let currentLevel = null;
    let hintsLeft = 0;
    let shownHints = 0;

    function getHintsLeftForLevel(levelNum, budget){
      const key = String(levelNum);
      if(state.perLevelHintsLeft[key] === undefined){
        state.perLevelHintsLeft[key] = budget;
        saveState();
      }
      return state.perLevelHintsLeft[key];
    }

    function setHintsLeftForLevel(levelNum, value){
      state.perLevelHintsLeft[String(levelNum)] = value;
      saveState();
    }

    function updateTopStats(){
      xpEl.textContent = state.xp;
      badgeCountEl.textContent = state.badges.length;
      solvedCountEl.textContent = state.solvedLevels.length;
    }

    function loadLevel(levelNum){
      currentLevel = makeLevel(levelNum);
      levelTitle.textContent = currentLevel.title;
      storyEl.textContent = currentLevel.story;
      promptEl.textContent = currentLevel.prompt;

      codeEl.value = currentLevel.starter;
      outputEl.textContent = "";
      hintsEl.innerHTML = "";
      shownHints = 0;

      hintsLeft = getHintsLeftForLevel(levelNum, currentLevel.hintBudget);
      hintBtn.textContent = `Hint (${hintsLeft} left)`;

      exBtn.style.display = "none";
      updateTopStats();
      saveLocalProfile();
    }

    // -------------------- Views --------------------
    function showPlay(){
      profileView.style.display = "none";
      devView.style.display = "none";
      playView.style.display = "block";
      updateTopStats();
    }

    function showProfile(){
      playView.style.display = "none";
      devView.style.display = "none";
      profileView.style.display = "block";
      updateProfile();
    }

    function showDev(){
      playView.style.display = "none";
      profileView.style.display = "none";
      devView.style.display = "block";
      devVisits.textContent = String(visits);
      devResult.textContent = "Type a name and press Search.";
    }

    navPlay.onclick = showPlay;
    navProfile.onclick = showProfile;
    backToPlay.onclick = showPlay;
    devClose.onclick = showPlay;

    navReset.onclick = () => {
      const ok = confirm("Reset everything? (name, levels, badges, xp) This cannot be undone.");
      if(!ok) return;
      localStorage.removeItem(STORE_KEY);
      state = defaultState();
      saveState();
      showToast("Reset done ‚úÖ", "Your progress was cleared.");
      showNameModal();
      loadLevel(state.currentLevel);
      showPlay();
    };

    // -------------------- Run / Submit / Hint / EX --------------------
    runBtn.onclick = async () => {
      const py = await ensurePyodide();
      setBusy(true);
      try{
        resetStdout(py);
        py.runPython(codeEl.value);
        const out = getStdout(py);
        outputEl.textContent = out || "(no output)";
      }catch(e){
        outputEl.textContent = friendlyError(e);
      } finally {
        setBusy(false);
      }
    };

    submitBtn.onclick = async () => {
      const py = await ensurePyodide();
      setBusy(true);
      try{
        resetStdout(py);
        py.runPython(codeEl.value);
        const rawOut = getStdout(py);
        const passed = currentLevel.validate(py, rawOut);

        if(passed){
          if(!state.solvedLevels.includes(state.currentLevel)){
            state.solvedLevels.push(state.currentLevel);
          }

          const bonus = Math.max(0, hintsLeft);
          state.xp += 10 + bonus;
          saveState();

          alert(`‚úÖ Successfully completed LEVEL ${state.currentLevel}!`);
          state.currentLevel += 1;
          saveState();

          checkBadges();
          loadLevel(state.currentLevel);
          updateTopStats();
          saveLocalProfile();
        } else {
          outputEl.textContent =
            `‚ùå Not correct yet.\n\nYour Output:\n${normalizeOutput(rawOut) || "(no output)"}\n\nTip: Try again.`;
        }

      }catch(e){
        outputEl.textContent = "‚ùå Error:\n" + friendlyError(e);
      } finally {
        setBusy(false);
      }
    };

    hintBtn.onclick = () => {
      if(hintsLeft <= 0) return;

      hintsLeft--;
      setHintsLeftForLevel(state.currentLevel, hintsLeft);

      state.hintsUsedTotal += 1;
      saveState();

      hintBtn.textContent = `Hint (${hintsLeft} left)`;

      const hintText = currentLevel.hints[shownHints] || "Try breaking the problem into small steps.";
      const li = document.createElement("li");
      li.textContent = hintText;
      hintsEl.appendChild(li);
      shownHints++;

      if(hintsLeft === 0){
        exBtn.style.display = "inline-block";
        showToast("üìò EX Code unlocked", "You used all hints. EX Code is now available.");
      }

      updateTopStats();
      saveLocalProfile();
    };

    exBtn.onclick = () => {
      outputEl.textContent =
        "üìò EX CODE (similar example, NOT the answer):\n\n" +
        (currentLevel.exampleCode || "No example available") +
        "\n\n‚ö†Ô∏è Modify this to solve the level.";
    };

    // -------------------- Profile Rendering --------------------
    function updateProfile(){
      setWelcome();
      pSolved.textContent = state.solvedLevels.length;
      pXp.textContent = state.xp;
      pHints.textContent = state.hintsUsedTotal;
      pCurrent.textContent = state.currentLevel;

      recentLevelsEl.innerHTML = "";
      const recent = state.solvedLevels.slice(-10).reverse();
      if(recent.length === 0){
        const span = document.createElement("span");
        span.className = "pill";
        span.textContent = "No levels solved yet";
        recentLevelsEl.appendChild(span);
      } else {
        for(const lv of recent){
          const span = document.createElement("span");
          span.className = "pill";
          span.textContent = "Level " + lv;
          recentLevelsEl.appendChild(span);
        }
      }

      badgeListEl.innerHTML = "";
      for(const b of BADGES){
        const earned = state.badges.includes(b.id);
        const div = document.createElement("div");
        div.className = "badge";
        div.innerHTML = `
          <div style="font-size:20px;">${earned ? "üèÖ" : "üîí"}</div>
          <div>
            <div><b>${b.name}</b></div>
            <small>${earned ? "Unlocked" : b.desc}</small>
          </div>
        `;
        badgeListEl.appendChild(div);
      }
    }

    // -------------------- Dev Ctrl --------------------
    if(devRequested){
      devBtn.style.display = "inline-block";
    }

    devBtn.onclick = () => {
      const pin = prompt("Enter Dev PIN:");
      if(pin !== DEV_PIN){
        alert("Wrong PIN");
        return;
      }
      showDev();
    };

    devSearchBtn.onclick = () => {
      const q = (devSearch.value || "").trim().toLowerCase();
      if(!q){
        devResult.textContent = "Type a name to search.";
        return;
      }
      try{
        const raw = localStorage.getItem(LOCAL_PROFILES_KEY);
        const list = raw ? JSON.parse(raw) : [];
        const found = list.find(p => (p.name || "").toLowerCase() === q);
        if(!found){
          devResult.textContent = "Not found in this browser.\n\n(Real global search needs Firebase/Supabase.)";
          return;
        }
        devResult.textContent =
          `FOUND PROFILE (local demo)\n\n` +
          `Name: ${found.name}\n` +
          `Solved: ${found.solved}\n` +
          `XP: ${found.xp}\n` +
          `Badges: ${found.badges}\n` +
          `Current Level: ${found.currentLevel}\n`;
      } catch {
        devResult.textContent = "Could not read local profiles.";
      }
    };

    // -------------------- Start --------------------
    updateTopStats();
    loadLevel(state.currentLevel);
    showPlay();
    checkBadges();
    saveLocalProfile();

  });
  </script>
</body>
</html>
