<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PyQuest ‚Äì Learn Python</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --panel2:#020617; --border:#334155;
      --txt:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; --good:#22c55e; --bad:#fb7185;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --gold: rgba(255,215,0,0.65);
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--txt); }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    h1{ margin:0; font-size:26px; }
    .sub{ color:var(--muted); font-size:13px; margin-top:2px; }
    .nav{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{ padding:10px 12px; border-radius:10px; border:0; cursor:pointer; background:#e5e7eb; color:#111; }
    .btn.primary{ background:var(--accent); }
    .btn.ghost{ background:transparent; border:1px solid var(--border); color:var(--txt); }
    .btn.danger{ background: var(--bad); color:#0b1220; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px; margin-top:12px; }
    .story{ color:var(--muted); margin:6px 0 0; line-height:1.35; }
    .prompt{ margin-top:10px; padding:10px; background:var(--panel2); border-radius:10px; border:1px solid var(--border); white-space:pre-line; }
    .row{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap; }
    .right{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    textarea{
      width:100%; margin-top:12px; background:black; color:var(--good);
      border-radius:10px; padding:10px; border:1px solid var(--border);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    textarea[disabled]{ opacity: 0.6; cursor: not-allowed; }
    .split{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px; }
    .label{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    pre{
      background:black; border:1px solid var(--border); border-radius:10px;
      padding:10px; min-height:120px; white-space:pre-wrap; margin:0; color:#e5e7eb;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    ul{ margin:0; padding-left:18px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
      border-radius:999px; border:1px solid var(--border); color:var(--txt);
      background:rgba(255,255,255,0.03);
    }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .badge{
      display:inline-flex; gap:8px; align-items:center; padding:8px 10px;
      border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,0.03);
    }
    .badge small{ color:var(--muted); }
    .toast{
      position: fixed; right: 16px; top: 16px; z-index: 9999;
      min-width: 260px; max-width: 360px;
      background: #0b1220; border:1px solid var(--border); border-radius:14px; padding:12px;
      box-shadow: var(--shadow);
      display:none;
    }
    .toast .tTitle{ font-weight:700; }
    .toast .tMsg{ color:var(--muted); margin-top:6px; white-space:pre-line; }

    .modalBackdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.6);
      display:none; align-items:center; justify-content:center; z-index:9998;
    }
    .modal{
      width:min(620px, 92vw);
      background:#0b1220; border:1px solid var(--border); border-radius:16px; padding:14px;
      box-shadow: var(--shadow);
    }
    input, select{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:#020617; color:var(--txt); outline:none;
    }
    .help{ color:var(--muted); font-size:13px; margin-top:6px; line-height:1.35; }
    @media (max-width: 900px){ .split, .grid{ grid-template-columns: 1fr; } }

    .champBanner{
      margin-top:12px; padding:12px; border-radius:14px;
      border:1px solid rgba(56,189,248,0.45);
      background: radial-gradient(circle at 10% 10%, rgba(56,189,248,0.25), transparent 55%),
                  radial-gradient(circle at 90% 30%, rgba(34,197,94,0.15), transparent 55%),
                  rgba(255,255,255,0.03);
      box-shadow: 0 0 22px rgba(56,189,248,0.15);
    }
    .champPill{
      border-color: var(--gold);
      background: rgba(255, 215, 0, 0.08);
    }

    .profileHeader{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .crownWrap{
      display:none; position:relative; width:46px; height:46px; border-radius:14px;
      border:1px solid rgba(255,215,0,0.55);
      background: radial-gradient(circle at 30% 30%, rgba(255,215,0,0.22), transparent 60%), rgba(255,255,255,0.03);
      box-shadow: 0 0 18px rgba(255,215,0,0.12);
      align-items:center; justify-content:center;
    }
    .crownWrap.show{ display:inline-flex; }
    .crownIcon{ font-size:26px; animation: crownFloat 2.2s ease-in-out infinite; }
    @keyframes crownFloat{ 0%,100%{ transform: translateY(0); } 50%{ transform: translateY(-4px); } }

    .sparkle{
      position:absolute; width:6px; height:6px; border-radius:50%;
      background: rgba(255,255,255,0.95); opacity:0; animation: twinkle 1.6s ease-in-out infinite;
    }
    .sparkle.s1{ top:8px; left:10px; animation-delay:0.1s; }
    .sparkle.s2{ top:10px; right:10px; animation-delay:0.5s; }
    .sparkle.s3{ bottom:10px; left:14px; animation-delay:0.9s; }
    .sparkle.s4{ bottom:12px; right:14px; animation-delay:1.2s; }
    @keyframes twinkle{ 0%{ transform: scale(0.5); opacity:0; } 40%{ transform: scale(1.2); opacity:0.95; } 100%{ transform: scale(0.6); opacity:0; } }

    .confetti {
      position: fixed; top: -10px; width: 10px; height: 14px; border-radius: 2px;
      opacity: 0.95; z-index: 99999;
      animation: fall 2.2s linear forwards, spin 1.1s linear infinite;
    }
    @keyframes fall { to { transform: translateY(110vh) rotate(720deg); opacity: 0; } }
    @keyframes spin { to { transform: rotate(360deg); } }

    .hr{ height:1px; background: rgba(148,163,184,0.25); margin: 10px 0; border:0; }

    .tag{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px; color:var(--muted); border:1px solid var(--border);
      padding:4px 8px; border-radius:999px;
      background: rgba(255,255,255,0.03);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="font-size:28px;">üêç</div>
        <div>
          <h1>PyQuest ‚Äì Learn Python</h1>
          <div class="sub" id="welcomeLine">Loading‚Ä¶</div>
        </div>
      </div>
      <div class="nav">
        <button class="btn ghost" id="navPlay">Play</button>
        <button class="btn ghost" id="navProfile">Profile</button>
        <button class="btn ghost" id="navLeaderboard">Leaderboard</button>
        <button class="btn ghost" id="navLogout">Logout</button>
        <button class="btn ghost" id="devBtn" style="display:none;">Dev Ctrl</button>
      </div>
    </div>

    <div id="playView" class="card">
      <div class="row">
        <div>
          <div class="pill">üìç <b id="levelTitle">Loading‚Ä¶</b></div>
          <div class="story" id="story"></div>
        </div>
        <div class="right">
          <span class="pill">üéØ Track: <b id="trackPill">-</b></span>
          <span class="pill">‚öôÔ∏è Difficulty: <b id="skillPill">1</b></span>
          <span class="pill">üåç Global visits: <b id="globalVisits">-</b></span>
          <span class="pill">‚≠ê XP: <b id="xp">0</b></span>
          <span class="pill">üèÖ Badges: <b id="badgeCount">0</b></span>
          <span class="pill">‚úÖ Solved: <b id="solvedCount">0</b></span>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="right" style="margin-left:auto;">
          <span class="pill">‚ö° +Hint: <b id="puHint">0</b></span>
          <span class="pill">‚è≠Ô∏è Skip: <b id="puSkip">0</b></span>
          <span class="pill">üëÅÔ∏è Reveal: <b id="puReveal">0</b></span>
        </div>
      </div>

      <div class="prompt" id="prompt"></div>

      <div class="row" style="margin-top:10px;">
        <div class="right" style="margin-left:auto;">
          <button class="btn ghost" id="useHintPU">Use +Hint</button>
          <button class="btn ghost" id="useRevealPU">Use Reveal</button>
          <button class="btn ghost" id="useSkipPU">Use Skip</button>
          <button class="btn primary" id="continueLessonBtn" style="display:none;">Continue</button>
          <button class="btn" id="hintBtn">Hint</button>
          <button class="btn" id="exBtn">EX Code</button>
          <button class="btn" id="runBtn">Run</button>
          <button class="btn primary" id="submitBtn">Submit</button>
        </div>
      </div>

      <textarea id="code" rows="9"></textarea>

      <div class="split">
        <div>
          <div class="label">Output</div>
          <pre id="output"></pre>
        </div>
        <div>
          <div class="label">Hints</div>
          <ul id="hints"></ul>
        </div>
      </div>
    </div>

    <div id="profileView" class="card" style="display:none;">
      <div class="row">
        <div class="profileHeader">
          <div class="crownWrap" id="profileCrown">
            <span class="sparkle s1"></span><span class="sparkle s2"></span>
            <span class="sparkle s3"></span><span class="sparkle s4"></span>
            <div class="crownIcon">üëë</div>
          </div>
          <div>
            <div class="pill">üë§ <b id="profileName">Your Profile</b></div>
            <div class="story">Synced online: Username + PIN</div>
          </div>
        </div>

        <div class="right">
          <button class="btn ghost" id="backToPlay">Back to Play</button>
        </div>
      </div>

      <div id="championBanner" class="champBanner" style="display:none;">
        <div class="row">
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <div class="pill champPill">üëë GLOBAL #1</div>
            <div style="font-weight:700;">Champion of the Leaderboard</div>
          </div>
          <div class="right">
            <span class="pill champPill">üèÜ Decoration Active</span>
          </div>
        </div>
        <div class="help">This moves automatically to whoever is #1 right now.</div>
      </div>

      <div class="grid" style="margin-top:12px;">
        <div class="card" style="margin:0;">
          <b>Stats</b>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <span class="pill">üéØ Track: <b id="pTrack">-</b></span>
            <span class="pill">‚öôÔ∏è Difficulty: <b id="pSkill">1</b></span>
            <span class="pill">‚úÖ Levels solved: <b id="pSolved">0</b></span>
            <span class="pill">‚≠ê XP: <b id="pXp">0</b></span>
            <span class="pill">üí° Hints used: <b id="pHints">0</b></span>
            <span class="pill">üî• Current stage: <b id="pCurrent">1</b></span>
          </div>
          <div class="help">Difficulty auto-adjusts based on your performance (not used much in Learn Python mode).</div>
        </div>

        <div class="card" style="margin:0;">
          <b>Power-Up Inventory</b>
          <div class="story">You can buy these using XP.</div>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <span class="pill">‚ö° +Hint: <b id="pPuHint">0</b></span>
            <span class="pill">‚è≠Ô∏è Skip: <b id="pPuSkip">0</b></span>
            <span class="pill">üëÅÔ∏è Reveal: <b id="pPuReveal">0</b></span>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <b>Power-Up Shop (buy with XP)</b>
        <div class="help">Spend XP to buy power-ups. These work globally for your account.</div>
        <div style="margin-top:10px; display:grid; gap:10px;">
          <div class="row">
            <div>
              <b>‚ö° +Hint Token</b>
              <div class="help">Adds +1 hint to the current level, even after hints end.</div>
              <span class="tag">Cost: 25 XP</span>
            </div>
            <div class="right"><button class="btn primary" id="buyHint">Buy</button></div>
          </div>
          <hr class="hr">
          <div class="row">
            <div>
              <b>üëÅÔ∏è Reveal Token</b>
              <div class="help">Shows expected output + extra guidance for the current level.</div>
              <span class="tag">Cost: 35 XP</span>
            </div>
            <div class="right"><button class="btn primary" id="buyReveal">Buy</button></div>
          </div>
          <hr class="hr">
          <div class="row">
            <div>
              <b>‚è≠Ô∏è Skip Token</b>
              <div class="help">Skips a level (does NOT count as solved).</div>
              <span class="tag">Cost: 60 XP</span>
            </div>
            <div class="right"><button class="btn primary" id="buySkip">Buy</button></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <b>Recent solved levels</b>
        <div class="story">Last 10 solved levels</div>
        <div id="recentLevels" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;"></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <b>Achievements / Badges</b>
        <div class="story">You‚Äôll get popups when you unlock these.</div>
        <div id="badgeList" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;"></div>
      </div>
    </div>

    <div id="leaderView" class="card" style="display:none;">
      <div class="row">
        <div>
          <div class="pill">üèÜ <b>Global Leaderboard</b></div>
          <div class="story">Top students by XP (global)</div>
        </div>
        <div class="right">
          <button class="btn ghost" id="lbRefresh">Refresh</button>
          <button class="btn ghost" id="lbBack">Back</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="story">Showing top 10</div>
        <div id="leaderList" style="margin-top:10px; display:grid; gap:10px;"></div>
        <div class="help" id="lbStatus"></div>
      </div>
    </div>

    <div id="devView" class="card" style="display:none;">
      <div class="row">
        <div>
          <div class="pill">üõ†Ô∏è <b>Dev Control</b></div>
          <div class="story">Admin login required. You can see global visits and search profiles.</div>
        </div>
        <div class="right"><button class="btn ghost" id="devClose">Close</button></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <b>Admin Login</b>
        <div class="help">Use admin email/password created in Firebase Authentication.</div>
        <div style="margin-top:10px; display:grid; gap:8px;">
          <input id="adminEmail" placeholder="Admin email">
          <input id="adminPass" type="password" placeholder="Admin password">
          <button class="btn primary" id="adminLoginBtn">Login</button>
          <div class="help" id="adminStatus"></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <b>Global visits</b>
        <div style="margin-top:10px;">
          <span class="pill">üåç Visits: <b id="devGlobalVisits">-</b></span>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <b>Search a student profile</b>
        <div class="help">Search by username (exact match, case-insensitive).</div>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <input id="devSearch" placeholder="Type username e.g., ankush" style="flex:1; min-width:220px;">
          <button class="btn primary" id="devSearchBtn">Search</button>
        </div>
        <pre id="devResult" style="margin-top:10px; min-height:120px;"></pre>
      </div>
    </div>
  </div>

  <div class="modalBackdrop" id="loginBackdrop">
    <div class="modal">
      <div style="font-size:18px; font-weight:700;">Login to PyQuest üîê</div>
      <div class="help">Use the same <b>Username + PIN</b> on any computer to continue your progress.</div>

      <div style="margin-top:10px; display:grid; gap:10px;">
        <div>
          <div class="help" style="margin-bottom:6px;">Username (no spaces)</div>
          <input id="uInput" maxlength="20" placeholder="e.g., ankush">
        </div>

        <div>
          <div class="help" style="margin-bottom:6px;">PIN (4‚Äì6 digits)</div>
          <input id="pinInput" maxlength="6" inputmode="numeric" placeholder="e.g., 1234">
        </div>

        <div id="trackBlock" style="display:none;">
          <div class="help" style="margin-bottom:6px;">Choose your mode (only for NEW account)</div>
          <select id="trackSelect">
            <option value="learn">Learn Python (guided lessons)</option>
            <option value="beginner">Beginner (easy basics)</option>
            <option value="moderate">Moderate (lists, dicts, strings)</option>
            <option value="pro">Professional (hard concepts)</option>
          </select>
        </div>

        <div class="help" id="loginMsg"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn primary" id="loginBtn">Login</button>
          <button class="btn ghost" id="createBtn">Create New</button>
        </div>

        <hr class="hr">
        <div class="help">
          If your username exists, use <b>Login</b>.<br>
          If it doesn‚Äôt exist, click <b>Create New</b>.
        </div>
      </div>
    </div>
  </div>

  <div class="modalBackdrop" id="explainBackdrop">
    <div class="modal">
      <div style="font-size:18px; font-weight:800;">‚úÖ Level Solved! Explain your code ‚úçÔ∏è</div>
      <div class="help" id="explainHintLine">Write a short explanation. If it has key ideas, you get bonus XP.</div>

      <div style="margin-top:10px;">
        <div class="label">Your code</div>
        <pre id="solvedCodePreview"></pre>
      </div>

      <div style="margin-top:10px;">
        <div class="label">Your explanation</div>
        <textarea id="explainInput" rows="4" style="color:#e5e7eb;background:#020617;"></textarea>
        <div class="help" id="explainStatus"></div>
      </div>

      <div id="explainMeBox" style="display:none; margin-top:10px;">
        <div class="label">Explain me</div>
        <pre id="explainMeText"></pre>
      </div>

      <div class="row" style="margin-top:12px;">
        <div class="right" style="margin-left:auto;">
          <button class="btn ghost" id="btnExplainMe">Explain me</button>
          <button class="btn ghost" id="btnSkipExplain">Continue (no bonus)</button>
          <button class="btn primary" id="btnSubmitExplain">Submit explanation</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="tTitle" id="toastTitle">üèÜ Achievement Unlocked!</div>
    <div class="tMsg" id="toastMsg"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, runTransaction, serverTimestamp,
      collection, query, getDocs, limit, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, signInAnonymously, signInWithEmailAndPassword }
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyADtZ0hjE0VUVVLnEJgqwOBJqokIbb0Lu0",
      authDomain: "pyquest-6e039.firebaseapp.com",
      projectId: "pyquest-6e039",
      storageBucket: "pyquest-6e039.firebasestorage.app",
      messagingSenderId: "427416463276",
      appId: "1:427416463276:web:c56bdad1ef6eaf9a013c09",
      measurementId: "G-TRRZWV6J0F"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const playView = document.getElementById("playView");
    const profileView = document.getElementById("profileView");
    const leaderView = document.getElementById("leaderView");
    const devView = document.getElementById("devView");

    const navPlay = document.getElementById("navPlay");
    const navProfile = document.getElementById("navProfile");
    const navLeaderboard = document.getElementById("navLeaderboard");
    const navLogout = document.getElementById("navLogout");
    const backToPlay = document.getElementById("backToPlay");

    const championBanner = document.getElementById("championBanner");
    const profileCrown = document.getElementById("profileCrown");

    const lbRefresh = document.getElementById("lbRefresh");
    const lbBack = document.getElementById("lbBack");
    const leaderList = document.getElementById("leaderList");
    const lbStatus = document.getElementById("lbStatus");

    const devBtn = document.getElementById("devBtn");
    const devClose = document.getElementById("devClose");

    const welcomeLine = document.getElementById("welcomeLine");
    const trackPill = document.getElementById("trackPill");
    const skillPill = document.getElementById("skillPill");
    const levelTitle = document.getElementById("levelTitle");
    const storyEl = document.getElementById("story");
    const promptEl = document.getElementById("prompt");
    const codeEl = document.getElementById("code");
    const outputEl = document.getElementById("output");
    const hintsEl = document.getElementById("hints");

    const hintBtn = document.getElementById("hintBtn");
    const exBtn = document.getElementById("exBtn");
    const runBtn = document.getElementById("runBtn");
    const submitBtn = document.getElementById("submitBtn");
    const continueLessonBtn = document.getElementById("continueLessonBtn");

    const useHintPU = document.getElementById("useHintPU");
    const useSkipPU = document.getElementById("useSkipPU");
    const useRevealPU = document.getElementById("useRevealPU");
    const puHint = document.getElementById("puHint");
    const puSkip = document.getElementById("puSkip");
    const puReveal = document.getElementById("puReveal");

    const xpEl = document.getElementById("xp");
    const badgeCountEl = document.getElementById("badgeCount");
    const solvedCountEl = document.getElementById("solvedCount");
    const globalVisitsEl = document.getElementById("globalVisits");

    const profileNameEl = document.getElementById("profileName");
    const pTrack = document.getElementById("pTrack");
    const pSolved = document.getElementById("pSolved");
    const pXp = document.getElementById("pXp");
    const pHints = document.getElementById("pHints");
    const pCurrent = document.getElementById("pCurrent");
    const pSkill = document.getElementById("pSkill");
    const recentLevelsEl = document.getElementById("recentLevels");
    const badgeListEl = document.getElementById("badgeList");

    const pPuHint = document.getElementById("pPuHint");
    const pPuSkip = document.getElementById("pPuSkip");
    const pPuReveal = document.getElementById("pPuReveal");

    const buyHint = document.getElementById("buyHint");
    const buyReveal = document.getElementById("buyReveal");
    const buySkip = document.getElementById("buySkip");

    const loginBackdrop = document.getElementById("loginBackdrop");
    const uInput = document.getElementById("uInput");
    const pinInput = document.getElementById("pinInput");
    const trackBlock = document.getElementById("trackBlock");
    const trackSelect = document.getElementById("trackSelect");
    const loginBtn = document.getElementById("loginBtn");
    const createBtn = document.getElementById("createBtn");
    const loginMsg = document.getElementById("loginMsg");

    const explainBackdrop = document.getElementById("explainBackdrop");
    const solvedCodePreview = document.getElementById("solvedCodePreview");
    const explainInput = document.getElementById("explainInput");
    const explainStatus = document.getElementById("explainStatus");
    const explainMeBox = document.getElementById("explainMeBox");
    const explainMeText = document.getElementById("explainMeText");
    const btnExplainMe = document.getElementById("btnExplainMe");
    const btnSkipExplain = document.getElementById("btnSkipExplain");
    const btnSubmitExplain = document.getElementById("btnSubmitExplain");

    const toast = document.getElementById("toast");
    const toastTitle = document.getElementById("toastTitle");
    const toastMsg = document.getElementById("toastMsg");
    let toastTimer = null;

    const adminEmail = document.getElementById("adminEmail");
    const adminPass = document.getElementById("adminPass");
    const adminLoginBtn = document.getElementById("adminLoginBtn");
    const adminStatus = document.getElementById("adminStatus");
    const devGlobalVisitsEl = document.getElementById("devGlobalVisits");
    const devSearch = document.getElementById("devSearch");
    const devSearchBtn = document.getElementById("devSearchBtn");
    const devResult = document.getElementById("devResult");

    function showToast(title, msg){
      toastTitle.textContent = title;
      toastMsg.textContent = msg;
      toast.style.display = "block";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => { toast.style.display = "none"; }, 3500);
    }

    function spawnConfetti(count = 90){
      for(let i=0; i<count; i++){
        const c = document.createElement("div");
        c.className = "confetti";
        c.style.left = Math.random() * 100 + "vw";
        c.style.background = `hsl(${Math.random()*360}, 90%, 60%)`;
        c.style.transform = `rotate(${Math.random()*360}deg)`;
        c.style.animationDuration = (1.6 + Math.random()*1.4) + "s";
        c.style.width = (6 + Math.random()*8) + "px";
        c.style.height = (8 + Math.random()*10) + "px";
        document.body.appendChild(c);
        setTimeout(() => c.remove(), 2600);
      }
    }

    function setBusy(isBusy) {
      runBtn.disabled = isBusy;
      submitBtn.disabled = isBusy;
      hintBtn.disabled = isBusy;
      exBtn.disabled = isBusy;
      useHintPU.disabled = isBusy;
      useRevealPU.disabled = isBusy;
      useSkipPU.disabled = isBusy;
      continueLessonBtn.disabled = isBusy;
    }

    function normalizeOutput(s){ return String(s).replace(/\s+/g, " ").trim(); }

    function trackLabel(t){
      if(t === "learn") return "Learn Python";
      if(t === "beginner") return "Beginner";
      if(t === "moderate") return "Moderate";
      if(t === "pro") return "Professional";
      return "-";
    }

    async function sha256Hex(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, "0")).join("");
    }

    function cleanUsername(raw){
      return (raw || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g, "")
        .replace(/[^a-z0-9_]/g, "");
    }

    function validPin(pin){ return /^[0-9]{4,6}$/.test(pin || ""); }

    const USERS_COL = "users_public";
    const SESSION_KEY = "pyquest_session_user";
    let sessionUser = localStorage.getItem(SESSION_KEY) || "";

    const COSTS = { hint: 25, reveal: 35, skip: 60 };

    const defaultState = () => ({
      username: "",
      track: "",
      xp: 0,
      currentLevel: 1,
      solvedLevels: [],
      skippedLevels: [],
      badges: [],
      hintsUsedTotal: 0,
      perLevelHintsLeft: {},
      powerUps: { hint: 0, reveal: 0, skip: 0 },
      skill: 1,
      lastSolveMs: null,
    });

    let state = defaultState();

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function setWelcome(){
      const nm = state.username ? state.username : "Student";
      welcomeLine.textContent = `Hi ${nm}! Track: ${trackLabel(state.track)} ‚Äî solve levels, earn badges, learn Python.`;
      profileNameEl.textContent = `${nm}'s Profile`;
      trackPill.textContent = trackLabel(state.track);
      pTrack.textContent = trackLabel(state.track);
      skillPill.textContent = String(state.skill || 1);
      pSkill.textContent = String(state.skill || 1);
    }

    function showPlay(){
      profileView.style.display = "none";
      leaderView.style.display = "none";
      devView.style.display = "none";
      playView.style.display = "block";
      updateTopStats();
    }

    async function showProfile(){
      playView.style.display = "none";
      leaderView.style.display = "none";
      devView.style.display = "none";
      profileView.style.display = "block";
      updateProfile();
      await refreshChampionStatus();
    }

    async function showLeaderboard(){
      playView.style.display = "none";
      profileView.style.display = "none";
      devView.style.display = "none";
      leaderView.style.display = "block";
      await loadLeaderboard();
      await refreshChampionStatus();
    }

    function showDev(){
      playView.style.display = "none";
      profileView.style.display = "none";
      leaderView.style.display = "none";
      devView.style.display = "block";
      adminStatus.textContent = "Please login to use Dev Ctrl.";
      devResult.textContent = "Login first, then search a username.";
    }

    navPlay.onclick = showPlay;
    navProfile.onclick = () => showProfile();
    navLeaderboard.onclick = () => showLeaderboard();

    const urlParams = new URLSearchParams(location.search);
    if(urlParams.get("dev") === "1") devBtn.style.display = "inline-block";
    devBtn.onclick = () => showDev();
    devClose.onclick = showPlay;

    navLogout.onclick = () => {
      const ok = confirm("Logout? (Your progress stays online, you can login again with username+PIN.)");
      if(!ok) return;
      localStorage.removeItem(SESSION_KEY);
      sessionUser = "";
      state = defaultState();
      setWelcome();
      showLoginModal();
    };

    function showLoginModal(){
      loginBackdrop.style.display = "flex";
      loginMsg.textContent = "";
      trackBlock.style.display = "none";
      setTimeout(() => uInput.focus(), 50);
    }
    function hideLoginModal(){ loginBackdrop.style.display = "none"; }

    function showExplainModal(codeText){
      solvedCodePreview.textContent = codeText || "";
      explainInput.value = "";
      explainStatus.textContent = "";
      explainMeBox.style.display = "none";
      explainBackdrop.style.display = "flex";
    }
    function hideExplainModal(){ explainBackdrop.style.display = "none"; }

    async function loadUserProfile(usernameLower){
      const ref = doc(db, USERS_COL, usernameLower);
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    async function saveUserProfile(){
      if(!state.username) return;
      const ref = doc(db, USERS_COL, state.username);
      const payload = {
        username: state.username,
        usernameLower: state.username,
        track: state.track || "learn",
        xp: state.xp,
        currentLevel: state.currentLevel,
        solvedLevels: state.solvedLevels,
        skippedLevels: state.skippedLevels || [],
        badges: state.badges,
        hintsUsedTotal: state.hintsUsedTotal,
        perLevelHintsLeft: state.perLevelHintsLeft,
        powerUps: state.powerUps || {hint:0,reveal:0,skip:0},
        skill: state.skill || 1,
        lastSolveMs: state.lastSolveMs ?? null,
        solved: state.solvedLevels.length,
        updatedAt: serverTimestamp(),
      };
      await setDoc(ref, payload, { merge:true });
    }

    loginBtn.onclick = async () => {
      loginMsg.textContent = "Checking account...";
      const usernameLower = cleanUsername(uInput.value);
      const pin = (pinInput.value || "").trim();

      if(!usernameLower){
        loginMsg.textContent = "‚ùå Enter a valid username (letters/numbers/_ only).";
        return;
      }
      if(!validPin(pin)){
        loginMsg.textContent = "‚ùå PIN must be 4‚Äì6 digits.";
        return;
      }

      try{
        const profile = await loadUserProfile(usernameLower);
        if(!profile){
          trackBlock.style.display = "block";
          loginMsg.textContent = "‚ö†Ô∏è Username not found. Click 'Create New' to make this account.";
          return;
        }

        const pinHash = await sha256Hex(pin);
        if(profile.pinHash !== pinHash){
          loginMsg.textContent = "‚ùå Wrong PIN. Try again.";
          return;
        }

        state = {
          username: profile.username || usernameLower,
          track: profile.track || "learn",
          xp: profile.xp ?? 0,
          currentLevel: profile.currentLevel ?? 1,
          solvedLevels: Array.isArray(profile.solvedLevels) ? profile.solvedLevels : [],
          skippedLevels: Array.isArray(profile.skippedLevels) ? profile.skippedLevels : [],
          badges: Array.isArray(profile.badges) ? profile.badges : [],
          hintsUsedTotal: profile.hintsUsedTotal ?? 0,
          perLevelHintsLeft: profile.perLevelHintsLeft || {},
          powerUps: profile.powerUps || {hint:0,reveal:0,skip:0},
          skill: profile.skill ?? 1,
          lastSolveMs: profile.lastSolveMs ?? null,
        };

        sessionUser = usernameLower;
        localStorage.setItem(SESSION_KEY, usernameLower);

        hideLoginModal();
        setWelcome();
        updateTopStats();
        loadLevel(state.currentLevel);
        showPlay();

        showToast("‚úÖ Logged in", `Welcome back, ${state.username}!`);
        await refreshChampionStatus();
      } catch (e){
        console.warn(e);
        loginMsg.textContent = "‚ùå Login failed (check internet).";
      }
    };

    createBtn.onclick = async () => {
      loginMsg.textContent = "Creating...";
      const usernameLower = cleanUsername(uInput.value);
      const pin = (pinInput.value || "").trim();

      if(!usernameLower){
        loginMsg.textContent = "‚ùå Enter a valid username (letters/numbers/_ only).";
        return;
      }
      if(!validPin(pin)){
        loginMsg.textContent = "‚ùå PIN must be 4‚Äì6 digits.";
        return;
      }

      trackBlock.style.display = "block";
      const tr = (trackSelect.value || "").trim();
      if(!tr){
        loginMsg.textContent = "‚ùå Choose your mode.";
        return;
      }

      try{
        const pinHash = await sha256Hex(pin);
        const userRef = doc(db, USERS_COL, usernameLower);

        await runTransaction(db, async (tx) => {
          const snap = await tx.get(userRef);
          if(snap.exists()) throw new Error("USERNAME_TAKEN");
          tx.set(userRef, {
            username: usernameLower,
            usernameLower: usernameLower,
            pinHash,
            track: tr,
            xp: 0,
            currentLevel: 1,
            solvedLevels: [],
            skippedLevels: [],
            badges: [],
            hintsUsedTotal: 0,
            perLevelHintsLeft: {},
            powerUps: {hint:0,reveal:0,skip:0},
            skill: 1,
            lastSolveMs: null,
            solved: 0,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
          });
        });

        state = defaultState();
        state.username = usernameLower;
        state.track = tr;

        sessionUser = usernameLower;
        localStorage.setItem(SESSION_KEY, usernameLower);

        hideLoginModal();
        setWelcome();
        updateTopStats();
        loadLevel(1);
        showPlay();

        showToast("üéâ Account created!", `Welcome, ${state.username}!`);
        await refreshChampionStatus();

      } catch (e){
        if(String(e?.message || e).includes("USERNAME_TAKEN")){
          loginMsg.textContent = "‚ùå Username already taken. Choose a different one.";
          return;
        }
        console.warn(e);
        loginMsg.textContent = "‚ùå Create failed (check internet).";
      }
    };

    let pyodide = null;
    async function ensurePyodide(){
      if(pyodide) return pyodide;
      setBusy(true);
      outputEl.textContent = "Loading Python engine...";
      try{
        pyodide = await loadPyodide();
        outputEl.textContent = "Ready ‚úÖ";
        return pyodide;
      } finally { setBusy(false); }
    }
    function resetStdout(py){
      py.runPython("import sys\nfrom io import StringIO\nsys.stdout = StringIO()\n");
    }
    function getStdout(py){ return String(py.runPython("sys.stdout.getvalue()")); }
    function friendlyError(e){
      const msg = String(e?.message || e);
      if(msg.includes("SyntaxError")) return msg + "\nTip: Check quotes/brackets/colons/indentation.";
      if(msg.includes("NameError")) return msg + "\nTip: Define the variable before using it.";
      if(msg.includes("IndentationError")) return msg + "\nTip: Python indentation matters.";
      return msg;
    }

    function adjustDifficulty({solveMs, hintsUsedThisLevel}){
      if(state.track === "learn") return;
      let delta = 0;
      if(solveMs != null){
        if(solveMs < 45000 && hintsUsedThisLevel <= 1) delta += 1;
        if(solveMs < 25000 && hintsUsedThisLevel === 0) delta += 1;
        if(solveMs > 120000 || hintsUsedThisLevel >= 6) delta -= 1;
        if(solveMs > 180000 || hintsUsedThisLevel >= 9) delta -= 1;
      }
      state.skill = clamp((state.skill || 1) + delta, 1, 5);
    }

    // ‚úÖ ‚úÖ ‚úÖ 22+ LESSONS CURRICULUM ‚úÖ ‚úÖ ‚úÖ
    // NOTE: We avoid input() exercises because browser Python can't accept stdin easily.
    const LEARN_CURRICULUM = [
      {
        name: "Print",
        lesson:
`üìò TOPIC: print()

‚úÖ print() shows output on the screen.

Example:
print("Hello")

Rules:
- Text must be inside quotes
- Python is case-sensitive`,
        q1: {
          title: "Question 1 ‚Äì Print a message",
          prompt: `Print exactly: HELLO`,
          starter: "# Use print()\n",
          hints: ["Use print()", 'Write: print("HELLO")', "No extra spaces"],
          exampleCode: `print("WELCOME")`,
          expectedOutput: "HELLO",
          explainKeywords: ["print","quotes","string"],
          explainMe: `Use print() to show text.\nText must be inside quotes.\nExample: print("HELLO")`
        },
        q2: {
          title: "Question 2 ‚Äì Print two lines",
          prompt: `Print exactly 2 lines:\nLINE1\nLINE2`,
          starter: "# Print LINE1 and LINE2 on separate lines\n",
          hints: ["Use two print() lines", "Print LINE1 first, then LINE2"],
          exampleCode: `print("A")\nprint("B")`,
          expectedOutput: "LINE1 LINE2",
          explainKeywords: ["print","two","lines"],
          explainMe: `Two print lines create two output lines.\nprint("LINE1") then print("LINE2")`
        }
      },

      {
        name: "Comments",
        lesson:
`üìò TOPIC: Comments

‚úÖ Comments are notes for humans.
Python ignores them.

Example:
# this is a comment
print("OK")`,
        q1: {
          title: "Question 1 ‚Äì Add a comment",
          prompt: `Write a comment on the first line, then print OK`,
          starter: "# Write a comment here\n",
          hints: ["Comment starts with #", "Then print OK"],
          exampleCode: `# this is a note\nprint("OK")`,
          expectedOutput: "OK",
          explainKeywords: ["comment","#","print"],
          explainMe: `A comment starts with #. Python ignores it.\nThen print("OK") shows OK.`
        },
        q2: {
          title: "Question 2 ‚Äì Comment out code",
          prompt: `Make sure the output is only YES (not NO). Use a comment to disable NO line.`,
          starter: 'print("YES")\nprint("NO")\n',
          hints: ["Add # before print('NO')", "Output must be only YES"],
          exampleCode: `print("YES")\n# print("NO")`,
          expectedOutput: "YES",
          explainKeywords: ["comment","disable","#"],
          explainMe: `Adding # before a line comments it out, so it won‚Äôt run.`
        }
      },

      {
        name: "Variables",
        lesson:
`üìò TOPIC: Variables

‚úÖ Variables store values.

Example:
name = "PyQuest"
print(name)

Rules:
- = assigns a value
- Variable names should not have spaces`,
        q1: {
          title: "Question 1 ‚Äì Store and print",
          prompt: `Create variable name = "PyQuest" and print it`,
          starter: "# name = \"...\"\n# print(name)\n",
          hints: ["Variable must be named name", "Use quotes around PyQuest", "Then print(name)"],
          exampleCode: `x = "Hello"\nprint(x)`,
          expectedOutput: "PyQuest",
          explainKeywords: ["variable","name","print"],
          explainMe: `name stores the text "PyQuest".\nprint(name) shows what is inside the variable.`
        },
        q2: {
          title: "Question 2 ‚Äì Numbers in variables",
          prompt: `Set a = 6, b = 7 and print a*b`,
          starter: "# a = 6\n# b = 7\n# print(a*b)\n",
          hints: ["Use * for multiply", "Print a*b"],
          exampleCode: `a=2\nb=3\nprint(a*b)`,
          expectedOutput: "42",
          explainKeywords: ["a","b","multiply","print"],
          explainMe: `a and b store numbers.\n* multiplies them.\nprint(a*b) prints the product.`
        }
      },

      {
        name: "Data Types",
        lesson:
`üìò TOPIC: Types

Common types:
- int (numbers): 5
- float (decimal): 3.5
- str (text): "hi"
- bool (True/False)

type(x) tells the type.`,
        q1: {
          title: "Question 1 ‚Äì Use type()",
          prompt: `Set x = 5 and print type(x)`,
          starter: "# x = 5\n# print(type(x))\n",
          hints: ["type(x) returns a type", "Print type(x)"],
          exampleCode: `x=10\nprint(type(x))`,
          expectedOutput: "class 'int'",
          explainKeywords: ["type","int","print"],
          explainMe: `x=5 is an integer.\ntype(x) is <class 'int'> and printing shows it.`
        },
        q2: {
          title: "Question 2 ‚Äì String type",
          prompt: `Set s = "hi" and print type(s)`,
          starter: '# s = "hi"\n# print(type(s))\n',
          hints: ["Text inside quotes is a string", "Print type(s)"],
          exampleCode: `s="yo"\nprint(type(s))`,
          expectedOutput: "class 'str'",
          explainKeywords: ["str","string","type"],
          explainMe: `Strings are text inside quotes.\ntype(s) prints <class 'str'>.`
        }
      },

      {
        name: "Arithmetic",
        lesson:
`üìò TOPIC: Math operators

+ add
- subtract
* multiply
/ division (gives float)
** power

Example:
print(2**3)  # 8`,
        q1: {
          title: "Question 1 ‚Äì Addition",
          prompt: `Print 12 + 8`,
          starter: "# print(12 + 8)\n",
          hints: ["Use +", "Use print()"],
          exampleCode: `print(5+5)`,
          expectedOutput: "20",
          explainKeywords: ["+","add","print"],
          explainMe: `Use + to add numbers.\nprint(12+8) prints 20.`
        },
        q2: {
          title: "Question 2 ‚Äì Power",
          prompt: `Print 2**5`,
          starter: "# print(2**5)\n",
          hints: ["Use ** for power", "2**5 = 32"],
          exampleCode: `print(2**3)`,
          expectedOutput: "32",
          explainKeywords: ["**","power","print"],
          explainMe: `** means power.\n2**5 is 2√ó2√ó2√ó2√ó2 = 32.`
        }
      },

      {
        name: "String Concatenation",
        lesson:
`üìò TOPIC: Joining strings

You can add strings using +.

Example:
first="Py"
second="Quest"
print(first+second)  # PyQuest`,
        q1: {
          title: "Question 1 ‚Äì Join strings",
          prompt: `Set a="Py" and b="thon" then print a+b`,
          starter: '# a="Py"\n# b="thon"\n# print(a+b)\n',
          hints: ["Use + between strings", "Print a+b"],
          exampleCode: `a="A"\nb="B"\nprint(a+b)`,
          expectedOutput: "Python",
          explainKeywords: ["string","+","concat"],
          explainMe: `Strings can be joined using +.\na+b becomes "Python".`
        },
        q2: {
          title: "Question 2 ‚Äì Add space",
          prompt: `Print: Hello World (with a space) using string +`,
          starter: '# print("Hello" + " " + "World")\n',
          hints: ["Add a space string \" \"", "Use +"],
          exampleCode: `print("Hi"+" "+"There")`,
          expectedOutput: "Hello World",
          explainKeywords: ["space","+","string"],
          explainMe: `To add a space, join "Hello" + " " + "World".`
        }
      },

      {
        name: "f-strings",
        lesson:
`üìò TOPIC: f-strings

f-strings put variables inside text easily.

Example:
name="Av"
print(f"Hi {name}")`,
        q1: {
          title: "Question 1 ‚Äì f-string basic",
          prompt: `Set name="Sam" and print: Hi Sam using f-string`,
          starter: '# name="Sam"\n# print(f"Hi {name}")\n',
          hints: ["Put f before quotes", "Use {name} inside"],
          exampleCode: `name="Bob"\nprint(f"Hi {name}")`,
          expectedOutput: "Hi Sam",
          explainKeywords: ["f-string","{","name"],
          explainMe: `f-strings use f"..." and {var} inside.\nIt replaces {name} with Sam.`
        },
        q2: {
          title: "Question 2 ‚Äì f-string with math",
          prompt: `Set x=3 and print: x squared is 9 using f-string`,
          starter: "# x=3\n# print(f\"x squared is {x*x}\")\n",
          hints: ["Compute x*x inside {}", "Output must match exactly"],
          exampleCode: `x=2\nprint(f"x squared is {x*x}")`,
          expectedOutput: "x squared is 9",
          explainKeywords: ["f-string","expression","x*x"],
          explainMe: `You can put calculations inside { }.\n{x*x} becomes 9.`
        }
      },

      {
        name: "If / Else",
        lesson:
`üìò TOPIC: if / else

if checks a condition.
If true -> runs one block
Else -> runs another block

Indentation matters!`,
        q1: {
          title: "Question 1 ‚Äì Simple condition",
          prompt: `Set x = 5\nIf x > 3 print YES else print NO`,
          starter: "# x = 5\n# if x > 3:\n#   print(\"YES\")\n# else:\n#   print(\"NO\")\n",
          hints: ["Condition is x > 3", "Indentation matters"],
          exampleCode: `x=2\nif x>1:\n  print("YES")\nelse:\n  print("NO")`,
          expectedOutput: "YES",
          explainKeywords: ["if","else","condition","indent"],
          explainMe: `Since x=5 and 5>3 is true, it prints YES.`
        },
        q2: {
          title: "Question 2 ‚Äì Else case",
          prompt: `Set x = 1\nIf x > 3 print YES else print NO`,
          starter: "# x = 1\n# if x > 3:\n#   print(\"YES\")\n# else:\n#   print(\"NO\")\n",
          hints: ["This time else will run", "Print NO"],
          exampleCode: `x=0\nif x>3:\n  print("YES")\nelse:\n  print("NO")`,
          expectedOutput: "NO",
          explainKeywords: ["if","else","false"],
          explainMe: `1>3 is false so else runs and prints NO.`
        }
      },

      {
        name: "Comparisons",
        lesson:
`üìò TOPIC: Comparison operators

== equal
!= not equal
>  greater
<  smaller
>= greater or equal
<= smaller or equal`,
        q1: {
          title: "Question 1 ‚Äì Equality",
          prompt: `Print the result of: 5 == 5`,
          starter: "# print(5 == 5)\n",
          hints: ["== checks equality", "Print it"],
          exampleCode: `print(2==3)`,
          expectedOutput: "True",
          explainKeywords: ["==","True","comparison"],
          explainMe: `5 equals 5, so 5==5 is True.`
        },
        q2: {
          title: "Question 2 ‚Äì Not equal",
          prompt: `Print the result of: 4 != 4`,
          starter: "# print(4 != 4)\n",
          hints: ["!= means not equal", "4 != 4 is False"],
          exampleCode: `print(4!=5)`,
          expectedOutput: "False",
          explainKeywords: ["!=","False"],
          explainMe: `4 is equal to 4, so 'not equal' is False.`
        }
      },

      {
        name: "Logical Operators",
        lesson:
`üìò TOPIC: and / or / not

and: both must be True
or : any one True
not: flips True/False`,
        q1: {
          title: "Question 1 ‚Äì and",
          prompt: `Print: (True and False)`,
          starter: "# print(True and False)\n",
          hints: ["and needs both True", "True and False -> False"],
          exampleCode: `print(True and True)`,
          expectedOutput: "False",
          explainKeywords: ["and","True","False"],
          explainMe: `and requires both sides True.\nTrue and False gives False.`
        },
        q2: {
          title: "Question 2 ‚Äì or",
          prompt: `Print: (True or False)`,
          starter: "# print(True or False)\n",
          hints: ["or needs only one True", "True or False -> True"],
          exampleCode: `print(False or False)`,
          expectedOutput: "True",
          explainKeywords: ["or","True"],
          explainMe: `or returns True if any side is True.`
        }
      },

      {
        name: "For Loops",
        lesson:
`üìò TOPIC: for loop + range

range(1, 4) gives: 1, 2, 3

Example:
for i in range(1,4):
  print(i)`,
        q1: {
          title: "Question 1 ‚Äì Print 1 to 3",
          prompt: `Print numbers 1 to 3`,
          starter: "# for i in range(1, 4):\n#   print(i)\n",
          hints: ["Use range(1, 4)", "Indentation matters"],
          exampleCode: `for i in range(1, 4):\n  print(i)`,
          expectedOutput: "1 2 3",
          explainKeywords: ["for","range","loop"],
          explainMe: `range(1,4) produces 1,2,3.\nLoop prints each.`
        },
        q2: {
          title: "Question 2 ‚Äì Sum 1 to 5",
          prompt: `Sum numbers 1 to 5 and print the sum`,
          starter: "# total=0\n# for i in range(1,6):\n#   total += i\n# print(total)\n",
          hints: ["Start total=0", "Use total += i", "Loop range(1,6)"],
          exampleCode: `total=0\nfor i in range(1,4):\n  total+=i\nprint(total)`,
          expectedOutput: "15",
          explainKeywords: ["total","+=","range"],
          explainMe: `Add each i from 1..5 into total, then print total.`
        }
      },

      {
        name: "While Loops",
        lesson:
`üìò TOPIC: while loop

while repeats until condition becomes False.

Example:
x=1
while x<=3:
  print(x)
  x+=1`,
        q1: {
          title: "Question 1 ‚Äì While print",
          prompt: `Use while loop to print 1 2 3 (each on new line or space)`,
          starter: "# x=1\n# while x<=3:\n#   print(x)\n#   x+=1\n",
          hints: ["Start x=1", "Stop when x<=3", "Increment x by 1"],
          exampleCode: `x=1\nwhile x<=2:\n  print(x)\n  x+=1`,
          expectedOutput: "1 2 3",
          explainKeywords: ["while","condition","x+=1"],
          explainMe: `while runs as long as condition is true.\nIncrement x so it stops.`
        },
        q2: {
          title: "Question 2 ‚Äì Count down",
          prompt: `Print 3 2 1 using while loop`,
          starter: "# x=3\n# while x>=1:\n#   print(x)\n#   x-=1\n",
          hints: ["Start x=3", "Decrement using x-=1"],
          exampleCode: `x=3\nwhile x>=2:\n  print(x)\n  x-=1`,
          expectedOutput: "3 2 1",
          explainKeywords: ["while","x-=1","loop"],
          explainMe: `Start at 3 and decrease by 1 until 1.`
        }
      },

      {
        name: "Break and Continue",
        lesson:
`üìò TOPIC: break / continue

break: stops the loop
continue: skips to next iteration`,
        q1: {
          title: "Question 1 ‚Äì break",
          prompt: `Loop from 1 to 5, but stop when i==3, print numbers printed`,
          starter: "# for i in range(1,6):\n#   if i==3:\n#     break\n#   print(i)\n",
          hints: ["Use break when i==3", "Should print 1 and 2 only"],
          exampleCode: `for i in range(1,6):\n  if i==4:\n    break\n  print(i)`,
          expectedOutput: "1 2",
          explainKeywords: ["break","stop","loop"],
          explainMe: `break exits loop immediately when condition matches.`
        },
        q2: {
          title: "Question 2 ‚Äì continue",
          prompt: `Loop 1 to 5 but skip 3, print the rest`,
          starter: "# for i in range(1,6):\n#   if i==3:\n#     continue\n#   print(i)\n",
          hints: ["Use continue when i==3", "Should print 1 2 4 5"],
          exampleCode: `for i in range(1,6):\n  if i==2:\n    continue\n  print(i)`,
          expectedOutput: "1 2 4 5",
          explainKeywords: ["continue","skip","loop"],
          explainMe: `continue skips current iteration and goes to next.`
        }
      },

      {
        name: "Lists Basics",
        lesson:
`üìò TOPIC: Lists

Lists hold multiple items.

Example:
nums = [1,2,3]
print(nums[0])  # 1`,
        q1: {
          title: "Question 1 ‚Äì Access index",
          prompt: `Create nums=[10,20,30] and print nums[1]`,
          starter: "# nums=[10,20,30]\n# print(nums[1])\n",
          hints: ["Index starts at 0", "nums[1] is 20"],
          exampleCode: `nums=[1,2,3]\nprint(nums[2])`,
          expectedOutput: "20",
          explainKeywords: ["list","index","0"],
          explainMe: `Index starts at 0.\nnums[1] is the 2nd item.`
        },
        q2: {
          title: "Question 2 ‚Äì len()",
          prompt: `Create a=[1,2,3,4] and print len(a)`,
          starter: "# a=[1,2,3,4]\n# print(len(a))\n",
          hints: ["len(list) gives size", "Answer is 4"],
          exampleCode: `a=[9,8]\nprint(len(a))`,
          expectedOutput: "4",
          explainKeywords: ["len","list","size"],
          explainMe: `len(a) returns how many items are in the list.`
        }
      },

      {
        name: "List Methods",
        lesson:
`üìò TOPIC: List methods

append(x) adds to end
pop() removes last item

Example:
a=[1]
a.append(2)
print(a)  # [1,2]`,
        q1: {
          title: "Question 1 ‚Äì append",
          prompt: `Start a=[1,2]. Append 3. Print a`,
          starter: "# a=[1,2]\n# a.append(3)\n# print(a)\n",
          hints: ["Use a.append(3)", "Print list"],
          exampleCode: `a=[1]\na.append(2)\nprint(a)`,
          expectedOutput: "[1, 2, 3]",
          explainKeywords: ["append","list","end"],
          explainMe: `append adds an item to the end of list.`
        },
        q2: {
          title: "Question 2 ‚Äì pop",
          prompt: `Start a=[7,8,9]. Remove last item using pop(). Print a`,
          starter: "# a=[7,8,9]\n# a.pop()\n# print(a)\n",
          hints: ["pop removes last element", "After pop, list is [7,8]"],
          exampleCode: `a=[1,2,3]\na.pop()\nprint(a)`,
          expectedOutput: "[7, 8]",
          explainKeywords: ["pop","remove","last"],
          explainMe: `pop() removes the last element from the list.`
        }
      },

      {
        name: "Slicing Strings",
        lesson:
`üìò TOPIC: Slicing

text[start:end] (end not included)

Example:
s="Python"
print(s[0:3])  # Pyt`,
        q1: {
          title: "Question 1 ‚Äì Slice",
          prompt: `s="Python" print first 3 letters using slicing`,
          starter: '# s="Python"\n# print(s[0:3])\n',
          hints: ["Use s[0:3]", "End index not included"],
          exampleCode: `s="Hello"\nprint(s[0:2])`,
          expectedOutput: "Pyt",
          explainKeywords: ["slice","start","end"],
          explainMe: `s[0:3] takes characters at index 0,1,2.`
        },
        q2: {
          title: "Question 2 ‚Äì Last character",
          prompt: `s="Python" print last character using s[-1]`,
          starter: '# s="Python"\n# print(s[-1])\n',
          hints: ["-1 means last", "Should print n"],
          exampleCode: `s="Hi"\nprint(s[-1])`,
          expectedOutput: "n",
          explainKeywords: ["-1","last","index"],
          explainMe: `Negative indices count from end. s[-1] is last char.`
        }
      },

      {
        name: "Slicing Lists",
        lesson:
`üìò TOPIC: List slicing

nums[a:b] returns part of list

Example:
a=[1,2,3,4]
print(a[1:3])  # [2,3]`,
        q1: {
          title: "Question 1 ‚Äì Slice list",
          prompt: `a=[1,2,3,4,5] print a[1:4]`,
          starter: "# a=[1,2,3,4,5]\n# print(a[1:4])\n",
          hints: ["a[1:4] gives [2,3,4]"],
          exampleCode: `a=[0,1,2]\nprint(a[1:2])`,
          expectedOutput: "[2, 3, 4]",
          explainKeywords: ["slice","list","range"],
          explainMe: `End index not included. a[1:4] => items 1,2,3.`
        },
        q2: {
          title: "Question 2 ‚Äì From start",
          prompt: `a=[5,6,7,8] print a[:2]`,
          starter: "# a=[5,6,7,8]\n# print(a[:2])\n",
          hints: ["a[:2] gives first two items", "[5,6]"],
          exampleCode: `a=[9,8,7]\nprint(a[:1])`,
          expectedOutput: "[5, 6]",
          explainKeywords: ["slice",":2","first"],
          explainMe: `If start is missing, slicing starts from 0.`
        }
      },

      {
        name: "Tuples",
        lesson:
`üìò TOPIC: Tuples

Tuples are like lists but fixed (cannot change).

Example:
t=(1,2,3)
print(t[0])`,
        q1: {
          title: "Question 1 ‚Äì Tuple index",
          prompt: `t=(10,20,30) print t[2]`,
          starter: "# t=(10,20,30)\n# print(t[2])\n",
          hints: ["Index starts at 0", "t[2] is 30"],
          exampleCode: `t=(1,2)\nprint(t[1])`,
          expectedOutput: "30",
          explainKeywords: ["tuple","()","index"],
          explainMe: `Tuple uses ( ). Indexing works like list.`
        },
        q2: {
          title: "Question 2 ‚Äì Tuple length",
          prompt: `t=(1,2,3,4) print len(t)`,
          starter: "# t=(1,2,3,4)\n# print(len(t))\n",
          hints: ["len returns number of items", "Answer is 4"],
          exampleCode: `t=(9,)\nprint(len(t))`,
          expectedOutput: "4",
          explainKeywords: ["len","tuple"],
          explainMe: `len(t) gives how many items in the tuple.`
        }
      },

      {
        name: "Sets",
        lesson:
`üìò TOPIC: Sets

Sets store unique items (no duplicates).

Example:
s={1,1,2}
print(s)  # {1,2}`,
        q1: {
          title: "Question 1 ‚Äì Unique",
          prompt: `Create s={1,1,2,2,3} and print len(s)`,
          starter: "# s={1,1,2,2,3}\n# print(len(s))\n",
          hints: ["Duplicates removed", "Unique are 1,2,3 => len 3"],
          exampleCode: `s={1,1,1}\nprint(len(s))`,
          expectedOutput: "3",
          explainKeywords: ["set","unique","len"],
          explainMe: `Sets keep only unique items.`
        },
        q2: {
          title: "Question 2 ‚Äì Add to set",
          prompt: `Create s={1,2}. Add 3 using add(). Print sorted list of s.`,
          starter: "# s={1,2}\n# s.add(3)\n# print(sorted(list(s)))\n",
          hints: ["Use s.add(3)", "Convert to list then sort"],
          exampleCode: `s={2,1}\nprint(sorted(list(s)))`,
          expectedOutput: "[1, 2, 3]",
          explainKeywords: ["add","set","sorted"],
          explainMe: `add inserts into set. sorted(list(s)) prints in order.`
        }
      },

      {
        name: "Dictionaries",
        lesson:
`üìò TOPIC: Dictionaries

Dictionary maps key -> value.

Example:
d={"a":1}
print(d["a"])  # 1`,
        q1: {
          title: "Question 1 ‚Äì Access value",
          prompt: `d={"name":"Alex"} print d["name"]`,
          starter: '# d={"name":"Alex"}\n# print(d["name"])\n',
          hints: ['Use d["name"]', "Print it"],
          exampleCode: `d={"x":5}\nprint(d["x"])`,
          expectedOutput: "Alex",
          explainKeywords: ["dict","key","value"],
          explainMe: `d["name"] gets the value for key "name".`
        },
        q2: {
          title: "Question 2 ‚Äì Add key",
          prompt: `d={} then set d["age"]=10 and print d["age"]`,
          starter: "# d={}\n# d[\"age\"]=10\n# print(d[\"age\"])\n",
          hints: ["Use d[key]=value", "Print d['age']"],
          exampleCode: `d={}\nd["k"]=1\nprint(d["k"])`,
          expectedOutput: "10",
          explainKeywords: ["dict","assign","key"],
          explainMe: `You can add a new key by assignment: d["age"]=10.`
        }
      },

      {
        name: "Functions",
        lesson:
`üìò TOPIC: Functions

Functions are reusable blocks.

Example:
def add(a,b):
  return a+b

print(add(2,3))`,
        q1: {
          title: "Question 1 ‚Äì Simple function",
          prompt: `Write function greet() that prints HI`,
          starter: "# def greet():\n#   ...\n# greet()\n",
          hints: ["Use def greet():", "Inside print('HI')", "Call greet()"],
          exampleCode: `def f():\n  print("OK")\nf()`,
          expectedOutput: "HI",
          explainKeywords: ["def","function","call"],
          explainMe: `Define greet() using def. Inside, print HI. Then call greet().`
        },
        q2: {
          title: "Question 2 ‚Äì Return",
          prompt: `Write function double(x) returning x*2. Print double(6).`,
          starter: "# def double(x):\n#   return ...\n# print(double(6))\n",
          hints: ["Use return x*2", "Print result"],
          exampleCode: `def double(x):\n  return x*2\nprint(double(3))`,
          expectedOutput: "12",
          explainKeywords: ["return","x*2","double"],
          explainMe: `return sends value back. double(6) returns 12.`
        }
      },

      {
        name: "String Methods",
        lesson:
`üìò TOPIC: String methods

upper(), lower(), replace()

Example:
s="hi"
print(s.upper())  # HI`,
        q1: {
          title: "Question 1 ‚Äì lower()",
          prompt: `s="PYTHON" print s.lower()`,
          starter: 's="PYTHON"\n# print(s.lower())\n',
          hints: ["Use .lower()", "Print it"],
          exampleCode: `print("HI".lower())`,
          expectedOutput: "python",
          explainKeywords: ["lower","method"],
          explainMe: `.lower() makes all letters lowercase.`
        },
        q2: {
          title: "Question 2 ‚Äì replace()",
          prompt: `s="I like cats" replace cats with dogs and print`,
          starter: 's="I like cats"\n# print(s.replace("cats","dogs"))\n',
          hints: ["Use replace(old,new)", "Print result"],
          exampleCode: `print("a-b".replace("-"," "))`,
          expectedOutput: "I like dogs",
          explainKeywords: ["replace","string"],
          explainMe: `replace changes parts of string. It returns a new string.`
        }
      },

      {
        name: "Membership (in)",
        lesson:
`üìò TOPIC: in operator

Checks if item exists in list/string.

Example:
print("a" in "cat")  # True`,
        q1: {
          title: "Question 1 ‚Äì in string",
          prompt: `Print: "y" in "python"`,
          starter: '# print("y" in "python")\n',
          hints: ["Should be True", "Use in operator"],
          exampleCode: `print("x" in "abc")`,
          expectedOutput: "True",
          explainKeywords: ["in","membership"],
          explainMe: `"y" exists inside "python", so it's True.`
        },
        q2: {
          title: "Question 2 ‚Äì in list",
          prompt: `Print: 3 in [1,2,3]`,
          starter: "# print(3 in [1,2,3])\n",
          hints: ["3 exists in list", "Output True"],
          exampleCode: `print(2 in [4,5])`,
          expectedOutput: "True",
          explainKeywords: ["in","list"],
          explainMe: `in checks if the item is present in the list.`
        }
      },

      {
        name: "Range and Step",
        lesson:
`üìò TOPIC: range(start, stop, step)

Example:
range(2, 10, 2) gives 2,4,6,8`,
        q1: {
          title: "Question 1 ‚Äì Even numbers",
          prompt: `Print 2 4 6 8 using for loop and range(2,10,2)`,
          starter: "# for i in range(2,10,2):\n#   print(i)\n",
          hints: ["Use range(2,10,2)", "Print i"],
          exampleCode: `for i in range(1,5):\n  print(i)`,
          expectedOutput: "2 4 6 8",
          explainKeywords: ["range","step","for"],
          explainMe: `Step 2 means it increases by 2 each time.`
        },
        q2: {
          title: "Question 2 ‚Äì Backwards range",
          prompt: `Print 5 4 3 2 1 using range(5,0,-1)`,
          starter: "# for i in range(5,0,-1):\n#   print(i)\n",
          hints: ["Negative step goes backwards", "Stop is 0 (not included)"],
          exampleCode: `for i in range(3,0,-1):\n  print(i)`,
          expectedOutput: "5 4 3 2 1",
          explainKeywords: ["range","-1","backwards"],
          explainMe: `range(5,0,-1) produces 5 down to 1.`
        }
      },

      {
        name: "Nested Loops",
        lesson:
`üìò TOPIC: Nested loops

Loop inside a loop.

Example:
for i in range(2):
  for j in range(2):
    print(i,j)`,
        q1: {
          title: "Question 1 ‚Äì Print grid",
          prompt: `Print a 2x2 grid of X (4 X's total)`,
          starter: "# for i in range(2):\n#   for j in range(2):\n#     print(\"X\")\n",
          hints: ["Use nested loops", "Print X in inner loop"],
          exampleCode: `for i in range(2):\n  print("X")`,
          expectedOutput: "X X X X",
          explainKeywords: ["nested","inner","loop"],
          explainMe: `Inner loop runs fully for each outer loop iteration.`
        },
        q2: {
          title: "Question 2 ‚Äì Coordinates",
          prompt: `Print coordinates: (0,0) (0,1) (1,0) (1,1) using nested loops`,
          starter: "# for i in range(2):\n#   for j in range(2):\n#     print(i, j)\n",
          hints: ["Use range(2)", "print(i, j)"],
          exampleCode: `for i in range(2):\n  for j in range(1):\n    print(i,j)`,
          expectedOutput: "0 0 0 1 1 0 1 1",
          explainKeywords: ["i","j","nested"],
          explainMe: `Two loops: i outer, j inner.\nPrint pairs for each combination.`
        }
      },

      {
        name: "Try / Except",
        lesson:
`üìò TOPIC: Exceptions

try:
  risky code
except:
  runs if error happens`,
        q1: {
          title: "Question 1 ‚Äì Handle error",
          prompt: `Use try/except to print SAFE even if 1/0 fails`,
          starter: "# try:\n#   print(1/0)\n# except:\n#   print(\"SAFE\")\n",
          hints: ["1/0 causes error", "except block should print SAFE"],
          exampleCode: `try:\n  x=1/0\nexcept:\n  print("OK")`,
          expectedOutput: "SAFE",
          explainKeywords: ["try","except","error"],
          explainMe: `If an error happens in try, Python jumps to except.`
        },
        q2: {
          title: "Question 2 ‚Äì No crash",
          prompt: `Write try/except for int("abc") and print FAIL in except`,
          starter: "# try:\n#   int(\"abc\")\n# except:\n#   print(\"FAIL\")\n",
          hints: ["int('abc') fails", "except should print FAIL"],
          exampleCode: `try:\n  int("x")\nexcept:\n  print("FAIL")`,
          expectedOutput: "FAIL",
          explainKeywords: ["int","exception","except"],
          explainMe: `int("abc") raises ValueError, so except runs.`
        }
      },

      {
        name: "Modules (random seed)",
        lesson:
`üìò TOPIC: import modules

Example:
import random
random.seed(0)
print(random.randint(1,10))`,
        q1: {
          title: "Question 1 ‚Äì randint with seed",
          prompt: `Use random.seed(0) then print random.randint(1,10)`,
          starter: "# import random\n# random.seed(0)\n# print(random.randint(1,10))\n",
          hints: ["Must seed(0)", "Then randint(1,10)"],
          exampleCode: `import random\nrandom.seed(1)\nprint(random.randint(1,10))`,
          expectedOutput: "7",
          explainKeywords: ["import","random","seed","randint"],
          explainMe: `Seeding makes random repeatable. With seed(0), randint(1,10) prints 7 in Python.`
        },
        q2: {
          title: "Question 2 ‚Äì choice with seed",
          prompt: `Use random.seed(0). Print random.choice(["A","B","C"])`,
          starter: '# import random\n# random.seed(0)\n# print(random.choice(["A","B","C"]))\n',
          hints: ["Seed first", "Then choice list"],
          exampleCode: `import random\nrandom.seed(2)\nprint(random.choice(["A","B"]))`,
          expectedOutput: "B",
          explainKeywords: ["choice","seed","random"],
          explainMe: `random.choice picks one item. With seed(0) it becomes deterministic.`
        }
      },

      {
        name: "List Comprehension",
        lesson:
`üìò TOPIC: List Comprehension

Create list in one line.

Example:
squares = [i*i for i in range(1,6)]`,
        q1: {
          title: "Question 1 ‚Äì Squares",
          prompt: `Create squares=[i*i for i in range(1,4)] and print squares`,
          starter: "# squares = [i*i for i in range(1,4)]\n# print(squares)\n",
          hints: ["Use [i*i for i in range(1,4)]"],
          exampleCode: `nums=[i for i in range(3)]\nprint(nums)`,
          expectedOutput: "[1, 4, 9]",
          explainKeywords: ["comprehension","range","i*i"],
          explainMe: `This loops i over 1..3 and stores i*i in the list.`
        },
        q2: {
          title: "Question 2 ‚Äì Filter",
          prompt: `Create evens=[i for i in range(1,7) if i%2==0] and print evens`,
          starter: "# evens = [i for i in range(1,7) if i%2==0]\n# print(evens)\n",
          hints: ["Use if in comprehension", "Even means i%2==0"],
          exampleCode: `ev=[i for i in range(5) if i%2==0]\nprint(ev)`,
          expectedOutput: "[2, 4, 6]",
          explainKeywords: ["if","%2","filter"],
          explainMe: `The if part keeps only even numbers.`
        }
      },

      {
        name: "Sorting",
        lesson:
`üìò TOPIC: sorted()

sorted(list) returns sorted copy.

Example:
a=[3,1,2]
print(sorted(a))  # [1,2,3]`,
        q1: {
          title: "Question 1 ‚Äì sorted list",
          prompt: `a=[3,1,2] print sorted(a)`,
          starter: "# a=[3,1,2]\n# print(sorted(a))\n",
          hints: ["Use sorted(a)"],
          exampleCode: `print(sorted([2,1]))`,
          expectedOutput: "[1, 2, 3]",
          explainKeywords: ["sorted","order"],
          explainMe: `sorted() returns a new sorted list.`
        },
        q2: {
          title: "Question 2 ‚Äì reverse sort",
          prompt: `a=[3,1,2] print sorted(a, reverse=True)`,
          starter: "# a=[3,1,2]\n# print(sorted(a, reverse=True))\n",
          hints: ["Use reverse=True"],
          exampleCode: `print(sorted([1,2], reverse=True))`,
          expectedOutput: "[3, 2, 1]",
          explainKeywords: ["reverse","sorted"],
          explainMe: `reverse=True sorts descending.`
        }
      },

      {
        name: "Classes (OOP basics)",
        lesson:
`üìò TOPIC: Classes

A class is a blueprint.

Example:
class Dog:
  def speak(self):
    return "woof"

d=Dog()
print(d.speak())`,
        q1: {
          title: "Question 1 ‚Äì Simple class method",
          prompt: `Create class A with method hi() returning "HI". Create object and print a.hi()`,
          starter: "# class A:\n#   def hi(self):\n#     return \"HI\"\n# a=A()\n# print(a.hi())\n",
          hints: ["Method must return HI", "Create object", "Print method call"],
          exampleCode: `class X:\n  def ok(self):\n    return "OK"\nx=X()\nprint(x.ok())`,
          expectedOutput: "HI",
          explainKeywords: ["class","self","object","method"],
          explainMe: `Define class, create object a=A(), call a.hi() to get return value.`
        },
        q2: {
          title: "Question 2 ‚Äì __init__",
          prompt: `Create class Person that stores name in __init__. Make p=Person("Sam") and print p.name`,
          starter: "# class Person:\n#   def __init__(self, name):\n#     self.name = name\n# p=Person(\"Sam\")\n# print(p.name)\n",
          hints: ["__init__ sets self.name", "Print p.name"],
          exampleCode: `class P:\n  def __init__(self,x):\n    self.x=x\np=P(5)\nprint(p.x)`,
          expectedOutput: "Sam",
          explainKeywords: ["__init__","self.name","attribute"],
          explainMe: `__init__ runs when object is created.\nself.name stores the given name.`
        }
      }
    ];

    // Learn mode generator (lesson + Q1 + Q2)
    function makeLearnLevel(stageNumber){
      const idx = Math.floor((stageNumber - 1) / 3);
      const stage = (stageNumber - 1) % 3;
      const topic = LEARN_CURRICULUM[idx % LEARN_CURRICULUM.length];

      if(stage === 0){
        return {
          title: `TOPIC ${idx + 1} ‚Äì ${topic.name}`,
          story: "Read the lesson, then continue to questions.",
          prompt: topic.lesson + "\n\nüëâ Click CONTINUE to start Question 1.",
          starter: "",
          hintBudget: 0,
          hints: [],
          exampleCode: "",
          expectedOutput: "",
          explainKeywords: [],
          explainMe: "",
          lessonOnly: true,
          validate: () => true,
        };
      }

      const q = (stage === 1) ? topic.q1 : topic.q2;
      const expectedNorm = normalizeOutput(q.expectedOutput);

      return {
        title: `TOPIC ${idx + 1} ‚Äì ${topic.name}\n${q.title}`,
        story: "Now solve the question to continue the lesson.",
        prompt: q.prompt,
        starter: q.starter,
        hintBudget: 10,
        hints: q.hints,
        exampleCode: q.exampleCode,
        expectedOutput: q.expectedOutput,
        explainKeywords: q.explainKeywords,
        explainMe: q.explainMe,
        lessonOnly: false,
        validate: (_py, rawOut) => normalizeOutput(rawOut) === expectedNorm
      };
    }

    // (Beginner / Moderate / Pro still exist, unchanged)
    function levelScaling(){
      const s = state.skill || 1;
      return { addMax: 3 + s * 2, loopMax: 4 + s * 2 };
    }
    function makeBeginnerLevel(n){
      const stage = (n - 1) % 6;
      const sc = levelScaling();

      if(stage === 0){
        const msg = (n % 2 === 0) ? "ACCESS GRANTED" : "HELLO PYQUEST";
        return {
          title: `LEVEL ${n} ‚Äì Print`,
          story: "A vault door needs a basic command.",
          prompt: `Print exactly: ${msg}`,
          starter: "# Use print()\n",
          hintBudget: 10,
          hints: ["Use print()", "Text must be inside quotes", "No extra spaces", "Only one print line"],
          exampleCode: `print("WELCOME USER")`,
          expectedOutput: msg,
          explainKeywords: ["print","quotes","string"],
          explainMe: `Use print() to display text inside quotes.`,
          validate: (_py, rawOut) => normalizeOutput(rawOut) === msg
        };
      }

      if(stage === 1){
        const word = (n % 3 === 0) ? "OPEN" : "START";
        return {
          title: `LEVEL ${n} ‚Äì Variables`,
          story: "Your robot friend wants a simple variable.",
          prompt: `Create variable named code = "${word}" and print it`,
          starter: "# code = \"...\"\n# print(code)\n",
          hintBudget: 10,
          hints: ["Variable name must be code", "Use quotes around text", "Then print(code)"],
          exampleCode: `msg = "HELLO"\nprint(msg)`,
          expectedOutput: word,
          explainKeywords: ["variable","code","print"],
          explainMe: `Store text in a variable then print it.`,
          validate: (py, rawOut) => {
            const okVar = Boolean(py.runPython(`('code' in globals()) and (code == '${word}')`));
            return okVar && normalizeOutput(rawOut) === word;
          }
        };
      }

      if(stage === 2){
        const a = (n % sc.addMax) + 2;
        const b = (n % (sc.addMax-1)) + 1;
        const ans = String(a + b);
        return {
          title: `LEVEL ${n} ‚Äì Math`,
          story: "The lab console needs quick math.",
          prompt: `Compute ${a} + ${b} and print the result`,
          starter: `# print(${a} + ${b})\n`,
          hintBudget: 10,
          hints: ["Use + operator", "Use print()", "Answer should be a number"],
          exampleCode: `x = 3\ny = 4\nprint(x + y)`,
          expectedOutput: ans,
          explainKeywords: ["add","+","print"],
          explainMe: `Use + and print() to show result.`,
          validate: (_py, rawOut) => normalizeOutput(rawOut) === ans
        };
      }

      if(stage === 3){
        const threshold = (n % (2 + state.skill)) + 3;
        return {
          title: `LEVEL ${n} ‚Äì If / Else`,
          story: "The spaceship wants an if/else decision.",
          prompt: `Set x = ${threshold}. If x > 4 print BIG else print SMALL`,
          starter: "# x = ...\n# if ...:\n#   print(...)\n# else:\n#   print(...)\n",
          hintBudget: 12,
          hints: ["Use if/else", "Condition is x > 4", "Print BIG or SMALL exactly", "Indentation matters"],
          exampleCode: `x = 2\nif x > 4:\n  print("BIG")\nelse:\n  print("SMALL")`,
          expectedOutput: (threshold > 4) ? "BIG" : "SMALL",
          explainKeywords: ["if","else","condition"],
          explainMe: `if checks condition, else runs if false.`,
          validate: (py, rawOut) => {
            const expected = (threshold > 4) ? "BIG" : "SMALL";
            const okX = Boolean(py.runPython(`('x' in globals()) and (x == ${threshold})`));
            return okX && normalizeOutput(rawOut) === expected;
          }
        };
      }

      if(stage === 4){
        const k = (n % sc.loopMax) + 3;
        const expected = Array.from({length:k}, (_,i)=>String(i+1)).join(" ");
        return {
          title: `LEVEL ${n} ‚Äì Loops`,
          story: "A dungeon gate needs a loop.",
          prompt: `Print numbers from 1 to ${k} (new lines OR spaces OK)`,
          starter: "# for i in range(...):\n#   print(i)\n",
          hintBudget: 14,
          hints: ["Use for loop", "Use range(1, k+1)", "Print i", "Indentation matters"],
          exampleCode: `for i in range(1, 4):\n  print(i)`,
          expectedOutput: expected,
          explainKeywords: ["for","range","loop"],
          explainMe: `range creates sequence, loop prints each.`,
          validate: (_py, rawOut) => normalizeOutput(rawOut) === expected
        };
      }

      const val = (n % (4 + state.skill)) + 2;
      const expected = String(val * 2);
      return {
        title: `LEVEL ${n} ‚Äì Functions`,
        story: "A terminal wants a simple function.",
        prompt: `Write function double(x) that returns x*2. Call it with ${val} and print result`,
        starter: "# def double(x):\n#   return ...\n# print(double(...))\n",
        hintBudget: 14,
        hints: ["Define function double", "Return x*2", "Call double(val)", "Print the result"],
        exampleCode: `def add1(x):\n  return x + 1\nprint(add1(5))`,
        expectedOutput: expected,
        explainKeywords: ["def","return","call"],
        explainMe: `Define, return, then call and print.`,
        validate: (py, rawOut) => {
          const okFn = Boolean(py.runPython(`('double' in globals()) and callable(double)`));
          if(!okFn) return false;
          const okVal = Boolean(py.runPython(`double(${val}) == ${val*2}`));
          return okVal && normalizeOutput(rawOut) === expected;
        }
      };
    }

    function makeModerateLevel(n){
      const stage = (n - 1) % 4;
      const s = state.skill || 1;

      if(stage === 0){
        const word = (n % 2 === 0) ? "python" : "quest";
        const expected = word.toUpperCase();
        return {
          title: `LEVEL ${n} ‚Äì Strings`,
          story: "You found a message hidden in a string.",
          prompt: `Set s = "${word}" and print s.upper()`,
          starter: "# s = \"...\"\n# print(s.upper())\n",
          hintBudget: 12,
          hints: ["Use .upper()", "Print the result", "No extra spaces"],
          exampleCode: `s="hello"\nprint(s.upper())`,
          expectedOutput: expected,
          explainKeywords: ["string","upper","print"],
          explainMe: `upper() makes string uppercase.`,
          validate: (py, out) => {
            const okS = Boolean(py.runPython(`('s' in globals()) and (s == '${word}')`));
            return okS && normalizeOutput(out) === expected;
          }
        };
      }

      if(stage === 1){
        const a = (n % (4+s)) + 1;
        const b = (n % (6+s)) + 2;
        const expected = String(a + b);
        return {
          title: `LEVEL ${n} ‚Äì Lists`,
          story: "A list of items must be processed.",
          prompt: `Create list nums = [${a}, ${b}] and print sum(nums)`,
          starter: "# nums = [...]\n# print(sum(nums))\n",
          hintBudget: 14,
          hints: ["List uses [ ]", "Use sum(nums)", "Print the result"],
          exampleCode: `nums=[2,5]\nprint(sum(nums))`,
          expectedOutput: expected,
          explainKeywords: ["list","sum","print"],
          explainMe: `sum() adds list numbers.`,
          validate: (py, out) => {
            const ok = Boolean(py.runPython(`('nums' in globals()) and (nums == [${a}, ${b}])`));
            return ok && normalizeOutput(out) === expected;
          }
        };
      }

      if(stage === 2){
        const expected = "NAME: ALICE";
        return {
          title: `LEVEL ${n} ‚Äì Dictionary`,
          story: "A dictionary gate needs correct keys.",
          prompt: `Make dict d={"name":"Alice"} and print "NAME: " + d["name"].upper()`,
          starter: '# d = {"name": "Alice"}\n# print("NAME: " + d["name"].upper())\n',
          hintBudget: 16,
          hints: ["Use { } for dict", 'Access with d["name"]', "Use .upper()", "Print exactly NAME: ALICE"],
          exampleCode: 'd={"x":"hi"}\nprint(d["x"].upper())',
          expectedOutput: expected,
          explainKeywords: ["dict","key","upper"],
          explainMe: `Dict access + upper()`,
          validate: (py, out) => {
            const ok = Boolean(py.runPython(`('d' in globals()) and (isinstance(d, dict)) and (d.get('name') == 'Alice')`));
            return ok && normalizeOutput(out) === expected;
          }
        };
      }

      const k = (n % (6+s)) + 6;
      const expected = String(Math.floor(k/2));
      return {
        title: `LEVEL ${n} ‚Äì Loop + Condition`,
        story: "A loop + condition combo unlocks the terminal.",
        prompt: `Count how many even numbers are from 1 to ${k} and print the count`,
        starter: "# count = 0\n# for i in range(1, k+1):\n#   if ...:\n#     count += 1\n# print(count)\n",
        hintBudget: 18,
        hints: ["Even means i % 2 == 0", "Use count += 1", "Print count"],
        exampleCode: "count=0\nfor i in range(1,6):\n  if i%2==0:\n    count+=1\nprint(count)",
        expectedOutput: expected,
        explainKeywords: ["for","%","even","count"],
        explainMe: `Count evens with modulo.`,
        validate: (_py, out) => normalizeOutput(out) === expected
      };
    }

    function makeProLevel(n){
      const stage = (n - 1) % 3;
      const s = state.skill || 1;

      if(stage === 0){
        const k = (n % (5+s)) + 5;
        const expected = Array.from({length:k}, (_,i)=>String((i+1)*(i+1))).join(" ");
        return {
          title: `LEVEL ${n} ‚Äì List Comprehension`,
          story: "The system wants a list comprehension.",
          prompt: `Create list squares = [i*i for i in range(1, ${k+1})] and print values separated by spaces`,
          starter: "# squares = [ ... ]\n# print(*squares)\n",
          hintBudget: 20,
          hints: ["Use list comprehension", "range(1, k+1)", "Print with print(*squares)"],
          exampleCode: "squares=[i*i for i in range(1,6)]\nprint(*squares)",
          expectedOutput: expected,
          explainKeywords: ["list","comprehension","range","i*i"],
          explainMe: `Comprehension builds list quickly.`,
          validate: (_py, out) => normalizeOutput(out) === expected
        };
      }

      if(stage === 1){
        const m = (n % (4+s)) + 4;
        let fact = 1; for(let i=2;i<=m;i++) fact*=i;
        const expected = String(fact);
        return {
          title: `LEVEL ${n} ‚Äì Recursion`,
          story: "A recursion challenge appears.",
          prompt: `Write recursive function fact(n) and print fact(${m})`,
          starter: "# def fact(n):\n#   if n==0 or n==1:\n#     return 1\n#   return n*fact(n-1)\n# print(fact(...))\n",
          hintBudget: 22,
          hints: ["Base case: 0 or 1", "Recursive call: fact(n-1)", "Return n * fact(n-1)"],
          exampleCode: "def fact(n):\n  return 1 if n<=1 else n*fact(n-1)\nprint(fact(5))",
          expectedOutput: expected,
          explainKeywords: ["recursion","base","return","fact(n-1)"],
          explainMe: `Base case stops recursion.`,
          validate: (py, out) => {
            const okFn = Boolean(py.runPython(`('fact' in globals()) and callable(fact)`));
            const okVal = okFn ? Boolean(py.runPython(`fact(${m}) == ${fact}`)) : false;
            return okFn && okVal && normalizeOutput(out) === expected;
          }
        };
      }

      const a = (n % (10+s)) + 1;
      const b = (n % (7+s)) + 2;
      const expected = String(a + b);
      return {
        title: `LEVEL ${n} ‚Äì Lambda`,
        story: "The console asks for a lambda.",
        prompt: `Create add = lambda x,y: x+y and print add(${a}, ${b})`,
        starter: "# add = lambda x,y: ...\n# print(add(a,b))\n",
        hintBudget: 18,
        hints: ["lambda x,y: x+y", "Call add(a,b)", "Print result"],
        exampleCode: "add=lambda x,y:x+y\nprint(add(2,3))",
        expectedOutput: expected,
        explainKeywords: ["lambda","function","x+y","print"],
        explainMe: `lambda makes quick function.`,
        validate: (py, out) => {
          const ok = Boolean(py.runPython(`('add' in globals()) and callable(add) and (add(${a},${b})==${a+b})`));
          return ok && normalizeOutput(out) === expected;
        }
      };
    }

    function makeLevel(n){
      const tr = state.track || "learn";
      if(tr === "learn") return makeLearnLevel(n);
      if(tr === "moderate") return makeModerateLevel(n);
      if(tr === "pro") return makeProLevel(n);
      return makeBeginnerLevel(n);
    }

    const BADGES = [
      { id:"solve_1",   name:"First Step",      desc:"Complete 1 level",   rule:(s)=> s.solvedLevels.length >= 1 },
      { id:"solve_5",   name:"Learner x5",      desc:"Complete 5 levels",  rule:(s)=> s.solvedLevels.length >= 5 },
      { id:"solve_10",  name:"Python Rookie",   desc:"Complete 10 levels", rule:(s)=> s.solvedLevels.length >= 10 },
      { id:"solve_20",  name:"Python Explorer", desc:"Complete 20 levels", rule:(s)=> s.solvedLevels.length >= 20 },
      { id:"solve_50",  name:"Python Warrior",  desc:"Complete 50 levels", rule:(s)=> s.solvedLevels.length >= 50 },
      { id:"solve_100", name:"Python Legend",   desc:"Complete 100 levels",rule:(s)=> s.solvedLevels.length >= 100 },
    ];

    function checkBadges(){
      for(const b of BADGES){
        if(!state.badges.includes(b.id) && b.rule(state)){
          state.badges.push(b.id);
          showToast("üèÜ Achievement Unlocked!", `${b.name}\n${b.desc}`);
        }
      }
    }

    let currentLevel = null;
    let hintsLeft = 0;
    let shownHints = 0;
    let levelStartTime = 0;
    let hintsUsedThisLevel = 0;
    let pendingNextLevel = null;
    let pendingSolvedXp = 0;

    function getHintsLeftForLevel(levelNum, budget){
      const key = String(levelNum);
      if(state.perLevelHintsLeft[key] === undefined) state.perLevelHintsLeft[key] = budget;
      return state.perLevelHintsLeft[key];
    }
    function setHintsLeftForLevel(levelNum, value){
      state.perLevelHintsLeft[String(levelNum)] = value;
    }

    function updateTopStats(){
      xpEl.textContent = state.xp;
      badgeCountEl.textContent = state.badges.length;
      solvedCountEl.textContent = state.solvedLevels.length;

      puHint.textContent = state.powerUps?.hint ?? 0;
      puReveal.textContent = state.powerUps?.reveal ?? 0;
      puSkip.textContent = state.powerUps?.skip ?? 0;

      useHintPU.disabled = !(state.powerUps?.hint > 0);
      useRevealPU.disabled = !(state.powerUps?.reveal > 0);
      useSkipPU.disabled = !(state.powerUps?.skip > 0);

      trackPill.textContent = trackLabel(state.track);
      skillPill.textContent = String(state.skill || 1);
    }

    function updateProfile(){
      setWelcome();
      pSolved.textContent = state.solvedLevels.length;
      pXp.textContent = state.xp;
      pHints.textContent = state.hintsUsedTotal;
      pCurrent.textContent = state.currentLevel;
      pSkill.textContent = String(state.skill || 1);

      pPuHint.textContent = state.powerUps?.hint ?? 0;
      pPuReveal.textContent = state.powerUps?.reveal ?? 0;
      pPuSkip.textContent = state.powerUps?.skip ?? 0;

      recentLevelsEl.innerHTML = "";
      const recent = state.solvedLevels.slice(-10).reverse();
      if(recent.length === 0){
        const span = document.createElement("span");
        span.className = "pill";
        span.textContent = "No levels solved yet";
        recentLevelsEl.appendChild(span);
      } else {
        for(const lv of recent){
          const span = document.createElement("span");
          span.className = "pill";
          span.textContent = "Solved " + lv;
          recentLevelsEl.appendChild(span);
        }
      }

      badgeListEl.innerHTML = "";
      for(const b of BADGES){
        const earned = state.badges.includes(b.id);
        const div = document.createElement("div");
        div.className = "badge";
        div.innerHTML = `
          <div style="font-size:20px;">${earned ? "üèÖ" : "üîí"}</div>
          <div>
            <div><b>${b.name}</b></div>
            <small>${earned ? "Unlocked" : b.desc}</small>
          </div>
        `;
        badgeListEl.appendChild(div);
      }
    }

    function setLessonModeUI(isLesson){
      continueLessonBtn.style.display = isLesson ? "inline-block" : "none";
      hintBtn.style.display = isLesson ? "none" : "inline-block";
      exBtn.style.display = isLesson ? "none" : "inline-block";
      runBtn.style.display = isLesson ? "none" : "inline-block";
      submitBtn.style.display = isLesson ? "none" : "inline-block";
      codeEl.disabled = isLesson;
      if(isLesson) codeEl.value = "# Lesson screen (no code needed)\n";
    }

    function loadLevel(levelNum){
      currentLevel = makeLevel(levelNum);
      levelTitle.textContent = currentLevel.title;
      storyEl.textContent = currentLevel.story;
      promptEl.textContent = currentLevel.prompt;

      outputEl.textContent = "";
      hintsEl.innerHTML = "";

      shownHints = 0;
      hintsUsedThisLevel = 0;
      levelStartTime = Date.now();

      const isLesson = !!currentLevel.lessonOnly;
      setLessonModeUI(isLesson);

      if(!isLesson){
        codeEl.disabled = false;
        codeEl.value = currentLevel.starter;
      }

      hintsLeft = getHintsLeftForLevel(levelNum, currentLevel.hintBudget || 0);
      hintBtn.textContent = `Hint (${hintsLeft} left)`;
      exBtn.style.display = "none";

      updateTopStats();
      setWelcome();
    }

    continueLessonBtn.onclick = async () => {
      if(!currentLevel?.lessonOnly) return;
      state.currentLevel += 1;
      showToast("‚û°Ô∏è Next", "Now solve Question 1!");
      await saveUserProfile().catch(()=>{});
      loadLevel(state.currentLevel);
      updateTopStats();
    };

    useHintPU.onclick = async () => {
      if(!(state.powerUps?.hint > 0)) return;
      if(currentLevel?.lessonOnly) return;
      state.powerUps.hint -= 1;
      hintsLeft += 1;
      hintBtn.textContent = `Hint (${hintsLeft} left)`;
      showToast("‚ö° +Hint used!", "You gained +1 hint for this stage.");
      updateTopStats();
      await saveUserProfile().catch(()=>{});
    };

    useRevealPU.onclick = async () => {
      if(!(state.powerUps?.reveal > 0)) return;
      if(currentLevel?.lessonOnly) return;
      state.powerUps.reveal -= 1;
      const expected = currentLevel.expectedOutput ?? "(unknown)";
      outputEl.textContent = `üëÅÔ∏è REVEAL\n\nExpected Output:\n${expected}\n\nExtra Tip:\nMatch the mission exactly.`;
      showToast("üëÅÔ∏è Reveal used!", "Expected output shown in Output box.");
      updateTopStats();
      await saveUserProfile().catch(()=>{});
    };

    useSkipPU.onclick = async () => {
      if(!(state.powerUps?.skip > 0)) return;
      const ok = confirm("Use SKIP token? This will skip this stage (NOT counted as solved).");
      if(!ok) return;

      state.powerUps.skip -= 1;
      state.skippedLevels = state.skippedLevels || [];
      if(!state.skippedLevels.includes(state.currentLevel)) state.skippedLevels.push(state.currentLevel);

      state.currentLevel += 1;
      showToast("‚è≠Ô∏è Skipped!", "Moved to next stage.");
      await saveUserProfile().catch(()=>{});
      loadLevel(state.currentLevel);
      updateTopStats();
    };

    async function buyPowerUp(kind){
      const cost = COSTS[kind];
      if(state.xp < cost){
        showToast("‚ùå Not enough XP", `Need ${cost} XP to buy this.`);
        return;
      }
      state.xp -= cost;
      state.powerUps[kind] = (state.powerUps[kind] || 0) + 1;
      showToast("‚úÖ Purchased!", `You bought 1 ${kind.toUpperCase()} token.`);
      updateTopStats();
      updateProfile();
      await saveUserProfile().catch(()=>{});
    }
    buyHint.onclick = () => buyPowerUp("hint");
    buyReveal.onclick = () => buyPowerUp("reveal");
    buySkip.onclick = () => buyPowerUp("skip");

    hintBtn.onclick = async () => {
      const L = currentLevel;
      if(!L || L.lessonOnly) return;
      if(hintsLeft <= 0) return;

      hintsLeft--;
      setHintsLeftForLevel(state.currentLevel, hintsLeft);

      state.hintsUsedTotal += 1;
      hintsUsedThisLevel += 1;

      hintBtn.textContent = `Hint (${hintsLeft} left)`;

      const li = document.createElement("li");
      li.textContent = L.hints[shownHints] || "Try breaking the problem into smaller steps.";
      hintsEl.appendChild(li);
      shownHints++;

      if(hintsLeft === 0){
        exBtn.style.display = "inline-block";
        showToast("üìò EX Code unlocked", "You used all hints.\nEX Code is now available.");
      }

      updateTopStats();
      await saveUserProfile().catch(()=>{});
    };

    exBtn.onclick = () => {
      const L = currentLevel;
      if(!L || L.lessonOnly) return;
      outputEl.textContent =
        "üìò EX CODE (similar example, NOT the answer):\n\n" +
        (L.exampleCode || "No example available") +
        "\n\n‚ö†Ô∏è Modify this code to solve the mission.";
    };

    runBtn.onclick = async () => {
      if(currentLevel?.lessonOnly) return;
      const py = await ensurePyodide();
      setBusy(true);
      try{
        resetStdout(py);
        py.runPython(codeEl.value);
        const out = getStdout(py);
        outputEl.textContent = out || "(no output)";
      }catch(e){
        outputEl.textContent = friendlyError(e);
      } finally { setBusy(false); }
    };

    function scoreExplanation(text, keywords){
      const t = (text || "").toLowerCase();
      let hits = 0;
      for(const k of (keywords || [])){
        if(t.includes(String(k).toLowerCase())) hits++;
      }
      return hits;
    }
    function bonusFromExplanation(hits){
      if(hits >= 4) return 8;
      if(hits >= 3) return 6;
      if(hits >= 2) return 4;
      return 0;
    }

    btnExplainMe.onclick = () => {
      explainMeBox.style.display = "block";
      explainMeText.textContent = currentLevel.explainMe || "Try describing what each line does.";
    };

    btnSkipExplain.onclick = async () => {
      hideExplainModal();
      state.xp += pendingSolvedXp;
      pendingSolvedXp = 0;
      state.currentLevel = pendingNextLevel;
      pendingNextLevel = null;

      checkBadges();
      updateTopStats();
      await saveUserProfile().catch(()=>{});
      await refreshChampionStatus().catch(()=>{});
      loadLevel(state.currentLevel);
    };

    btnSubmitExplain.onclick = async () => {
      const hits = scoreExplanation(explainInput.value, currentLevel.explainKeywords);
      const bonus = bonusFromExplanation(hits);
      if(bonus <= 0){
        explainStatus.textContent = "‚ùå Not enough explanation keywords. (Tip: click ‚ÄúExplain me‚Äù then write in your own words.)";
        return;
      }
      explainStatus.textContent = `‚úÖ Nice! Bonus +${bonus} XP earned.`;
      showToast("üß† Explanation Bonus!", `You earned +${bonus} XP for explaining your code!`);

      hideExplainModal();
      state.xp += (pendingSolvedXp + bonus);
      pendingSolvedXp = 0;

      state.currentLevel = pendingNextLevel;
      pendingNextLevel = null;

      checkBadges();
      updateTopStats();
      await saveUserProfile().catch(()=>{});
      await refreshChampionStatus().catch(()=>{});
      loadLevel(state.currentLevel);
    };

    submitBtn.onclick = async () => {
      if(!state.username){ showLoginModal(); return; }
      if(currentLevel?.lessonOnly){ return; }

      const py = await ensurePyodide();
      setBusy(true);
      try{
        resetStdout(py);
        py.runPython(codeEl.value);

        const rawOut = getStdout(py);
        const passed = currentLevel.validate(py, rawOut);

        if(passed){
          if(!state.solvedLevels.includes(state.currentLevel)) state.solvedLevels.push(state.currentLevel);

          const bonusHints = Math.max(0, hintsLeft);
          const baseXp = 10 + bonusHints;

          const solveMs = Date.now() - levelStartTime;
          state.lastSolveMs = solveMs;
          adjustDifficulty({ solveMs, hintsUsedThisLevel });

          alert(`‚úÖ Successfully completed this stage!\nNow explain your code for bonus XP.`);

          pendingSolvedXp = baseXp;
          pendingNextLevel = state.currentLevel + 1;

          await saveUserProfile().catch(()=>{});
          await refreshChampionStatus().catch(()=>{});
          showExplainModal(codeEl.value);

        } else {
          outputEl.textContent =
            `‚ùå Not correct yet.\n\nYour Output:\n${normalizeOutput(rawOut) || "(no output)"}\n\nTip: Try again.`;
        }
      }catch(e){
        outputEl.textContent = "‚ùå Error:\n" + friendlyError(e);
      } finally { setBusy(false); }
    };

    async function getTop1Username(){
      const colRef = collection(db, USERS_COL);
      const qy = query(colRef, orderBy("xp", "desc"), limit(1));
      const snap = await getDocs(qy);
      if(snap.empty) return null;
      return snap.docs[0].id;
    }

    let wasChampion = false;
    async function refreshChampionStatus(){
      try{
        const top1 = await getTop1Username();
        const amIChampion = (state.username && top1 && state.username === top1);

        championBanner.style.display = amIChampion ? "block" : "none";
        if(amIChampion) profileCrown.classList.add("show");
        else profileCrown.classList.remove("show");

        if(amIChampion && !wasChampion){
          showToast("üëë YOU ARE #1!", "You are now #1 on the Global Leaderboard!\nKeep going üî•");
          spawnConfetti(110);
        }
        wasChampion = amIChampion;
      } catch {
        championBanner.style.display = "none";
        profileCrown.classList.remove("show");
      }
    }

    async function loadLeaderboard(){
      lbStatus.textContent = "Loading leaderboard...";
      leaderList.innerHTML = "";
      try{
        const colRef = collection(db, USERS_COL);
        const qy = query(colRef, orderBy("xp", "desc"), limit(10));
        const snap = await getDocs(qy);

        if(snap.empty){
          lbStatus.textContent = "No players yet.";
          return;
        }

        let rank = 1;
        snap.forEach((docSnap) => {
          const d = docSnap.data();
          const name = d.username || docSnap.id;
          const xp = d.xp ?? 0;
          const solved = d.solved ?? 0;
          const lvl = d.currentLevel ?? 1;
          const tr = d.track ? trackLabel(d.track) : "-";
          const sk = d.skill ?? 1;

          const row = document.createElement("div");
          row.className = "card";
          row.style.margin = "0";
          row.innerHTML = `
            <div class="row">
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <div class="pill">#${rank}</div>
                <div><b>${name}</b></div>
                ${rank === 1 ? `<div class="pill champPill">üëë Champion</div>` : ""}
                <div class="pill">üéØ ${tr}</div>
                <div class="pill">‚öôÔ∏è ${sk}</div>
              </div>
              <div class="right">
                <span class="pill">‚≠ê XP: <b>${xp}</b></span>
                <span class="pill">‚úÖ Solved: <b>${solved}</b></span>
                <span class="pill">üî• Stage: <b>${lvl}</b></span>
              </div>
            </div>
          `;
          leaderList.appendChild(row);
          rank++;
        });

        lbStatus.textContent = "‚úÖ Updated.";
      } catch {
        lbStatus.textContent = "‚ùå Failed. (If console says index needed, create it from Firebase link.)";
      }
    }

    lbRefresh.onclick = () => loadLeaderboard();
    lbBack.onclick = showPlay;

    let isAdminLoggedIn = false;
    adminLoginBtn.onclick = async () => {
      adminStatus.textContent = "Logging in...";
      try{
        await signInWithEmailAndPassword(auth, (adminEmail.value || "").trim(), adminPass.value || "");
        isAdminLoggedIn = true;
        adminStatus.textContent = "‚úÖ Admin logged in.";
        await readGlobalVisits();
      }catch(e){
        isAdminLoggedIn = false;
        adminStatus.textContent = "‚ùå Login failed: " + (e?.message || e);
      }
    };

    devSearchBtn.onclick = async () => {
      if(!isAdminLoggedIn){
        devResult.textContent = "‚ùå Please login as admin first.";
        return;
      }
      const qUser = cleanUsername(devSearch.value);
      if(!qUser){
        devResult.textContent = "Type a username to search.";
        return;
      }

      devResult.textContent = "Searching...";
      try{
        const prof = await loadUserProfile(qUser);
        if(!prof){
          devResult.textContent = "Not found.";
          return;
        }
        devResult.textContent =
          `FOUND PROFILE\n\n` +
          `Username: ${prof.username}\n` +
          `Track: ${trackLabel(prof.track)}\n` +
          `Solved: ${prof.solved ?? (prof.solvedLevels?.length || 0)}\n` +
          `XP: ${prof.xp}\n` +
          `Current Stage: ${prof.currentLevel}\n` +
          `Difficulty: ${prof.skill ?? 1}\n` +
          `PowerUps: ${JSON.stringify(prof.powerUps || {})}\n` +
          `Hints Used: ${prof.hintsUsedTotal ?? "-"}\n`;
      } catch(e){
        devResult.textContent = "Error: " + (e?.message || e);
      }
    };

    async function incrementGlobalVisit(){
      const statsRef = doc(db, "stats", "global");
      await runTransaction(db, async (tx) => {
        const snap = await tx.get(statsRef);
        const cur = snap.exists() ? (snap.data().visits || 0) : 0;
        tx.set(statsRef, { visits: cur + 1, updatedAt: serverTimestamp() }, { merge:true });
      });
    }
    async function readGlobalVisits(){
      const statsRef = doc(db, "stats", "global");
      const snap = await getDoc(statsRef);
      const v = snap.exists() ? (snap.data().visits || 0) : 0;
      globalVisitsEl.textContent = v;
      devGlobalVisitsEl.textContent = v;
    }

    function showPlayOnly(){
      playView.style.display = "block";
      profileView.style.display = "none";
      leaderView.style.display = "none";
      devView.style.display = "none";
    }
    showPlayOnly();

    let anonReady = false;
    async function ensureAnonAuth(){
      if(anonReady && auth.currentUser) return;
      try{ await signInAnonymously(auth); anonReady = true; } catch { anonReady = true; }
    }

    (async () => {
      await ensureAnonAuth();

      try{
        await incrementGlobalVisit();
        await readGlobalVisits();
      }catch{
        globalVisitsEl.textContent = "offline";
      }

      if(sessionUser){
        try{
          const prof = await loadUserProfile(sessionUser);
          if(prof){
            state = {
              username: prof.username || sessionUser,
              track: prof.track || "learn",
              xp: prof.xp ?? 0,
              currentLevel: prof.currentLevel ?? 1,
              solvedLevels: Array.isArray(prof.solvedLevels) ? prof.solvedLevels : [],
              skippedLevels: Array.isArray(prof.skippedLevels) ? prof.skippedLevels : [],
              badges: Array.isArray(prof.badges) ? prof.badges : [],
              hintsUsedTotal: prof.hintsUsedTotal ?? 0,
              perLevelHintsLeft: prof.perLevelHintsLeft || {},
              powerUps: prof.powerUps || {hint:0,reveal:0,skip:0},
              skill: prof.skill ?? 1,
              lastSolveMs: prof.lastSolveMs ?? null,
            };
            setWelcome();
            updateTopStats();
            loadLevel(state.currentLevel);
            showToast("‚úÖ Welcome back!", `Logged in as ${state.username}`);
            await refreshChampionStatus();
          } else {
            localStorage.removeItem(SESSION_KEY);
            sessionUser = "";
            showLoginModal();
          }
        } catch {
          showLoginModal();
        }
      } else {
        showLoginModal();
      }

      setInterval(() => refreshChampionStatus().catch(()=>{}), 8000);
    })();

    navPlay.onclick = showPlay;
    navProfile.onclick = () => showProfile();
    navLeaderboard.onclick = () => showLeaderboard();

  </script>
</body>
</html>
